import{u as w,s as h,j as t,e as _}from"./index-e7111140.js";import{r as a}from"./react-63c462fe.js";import{u as q}from"./useQuizEngine-288713d0.js";import{S as y}from"./SEO-9de033b6.js";import{f as z}from"./slots-42960951.js";import{c as N,b as Q}from"./router-d6d570a4.js";import"./supabase-07ebd5d8.js";import"./icons-1e9e0bae.js";import"./smartJoinQuiz-dd29b6b8.js";function E({seconds:n}){return t.jsxs("div",{className:"text-center mt-6 text-indigo-300 font-semibold text-xl","aria-live":"polite",children:["Starts in"," ",Math.floor(n/60).toString().padStart(2,"0"),":",(n%60).toString().padStart(2,"0")]})}function M(){const{slotId:n}=N(),s=Q();w();const[e,x]=a.useState(null),[d,o]=a.useState(!0),[u,p]=a.useState(null),[l,c]=a.useState("loading"),b=a.useCallback(async()=>{if(!h){p("Supabase not configured"),o(!1);return}try{const{data:i,error:r}=await h.from("quiz_slots_view").select("*").eq("id",n).maybeSingle();if(r)throw r;if(!i)throw new Error("Slot not found");x(i),o(!1)}catch(i){p(i.message||"Failed"),o(!1)}},[n]);a.useEffect(()=>{b()},[b]),a.useEffect(()=>{if(!e||u)return;const i=Date.now(),r=e.start_time?new Date(e.start_time).getTime():null,m=e.end_time?new Date(e.end_time).getTime():null;if(e.status==="paused"){c("paused");return}if(r&&m&&i>=r&&i<m){c("live");return}if(r&&i<r){c("pre-slot");return}if(m&&i>=m){c("finished");return}c("error")},[e,u]),a.useEffect(()=>{if(l!=="finished"||!(e!=null&&e.quiz_id)||!(e!=null&&e.category))return;let i=!1;return(async()=>{try{const{slots:r,mode:m}=await z(h,e.category),j=e.end_time?new Date(e.end_time).getTime():Date.now(),v=(r||[]).filter(f=>f.start_time?new Date(f.start_time).getTime()>j:!1).sort((f,S)=>new Date(f.start_time).getTime()-new Date(S.start_time).getTime());!i&&v[0]?s(`/quiz/slot/${v[0].slotId}`):i||s(`/results/${e.quiz_id}`)}catch(r){i||s(`/results/${e.quiz_id}`)}})(),()=>{i=!0}},[l,e==null?void 0:e.quiz_id,e==null?void 0:e.category,e==null?void 0:e.end_time,s]);const g=q(e==null?void 0:e.quiz_id,s,{slotId:n});return t.jsxs("div",{className:"container mx-auto px-4 py-4 text-foreground",children:[t.jsx(y,{title:"Slot Lobby – Quiz Dangal",description:"Live quiz slot lobby"}),d&&t.jsx("div",{className:"text-center py-24",children:"Loading slot…"}),!d&&u&&t.jsx("div",{className:"text-center py-24 text-red-400",children:u}),!d&&!u&&t.jsxs("div",{className:"max-w-xl mx-auto",children:[t.jsx("h1",{className:"text-xl font-bold mb-2",children:"Quiz Slot"}),t.jsxs("div",{className:"text-sm text-slate-400 mb-4",children:["Start: ",e.start_time?_(e.start_time):"—"," • End:"," ",e.end_time?_(e.end_time):"—"]}),l==="paused"&&t.jsx("div",{className:"p-4 rounded-lg bg-amber-700/30 border border-amber-600 text-amber-200 text-sm mb-4",children:"Slot paused by admin. Please wait…"}),l==="pre-slot"&&g.timeLeft>0&&t.jsx(E,{seconds:g.timeLeft}),l==="live"&&t.jsx(D,{quizEngine:g}),l==="error"&&t.jsx("div",{className:"text-center text-red-400",children:"Invalid slot state."})]})]})}function D({quizEngine:n}){var e,x,d;const s=n;return s?s.quizState==="loading"?t.jsx("div",{className:"mt-6",children:"Quiz loading…"}):s.quizState==="waiting"?t.jsx("div",{className:"mt-6",children:"Preparing…"}):t.jsxs("div",{className:"mt-4 border border-slate-700 rounded-xl p-4 bg-slate-900/60",children:[t.jsx("div",{className:"text-sm text-slate-300 mb-2",children:"Live Quiz"}),s.questions&&s.questions.length>0?t.jsxs("div",{children:[t.jsxs("div",{className:"font-semibold mb-2",children:["Q",s.currentQuestionIndex+1,"."," ",(e=s.questions[s.currentQuestionIndex])==null?void 0:e.question_text]}),t.jsx("div",{className:"space-y-2",children:(d=(x=s.questions[s.currentQuestionIndex])==null?void 0:x.options)==null?void 0:d.map(o=>t.jsx("button",{onClick:()=>s.handleAnswerSelect(s.questions[s.currentQuestionIndex].id,o.id),className:"w-full text-left px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 text-sm",children:o.option_text},o.id))})]}):t.jsx("div",{children:"No questions loaded yet."}),s.quizState==="finished"&&t.jsx("div",{className:"mt-4 text-indigo-300 text-sm",children:"Finished – redirecting…"})]}):null}export{M as default};
