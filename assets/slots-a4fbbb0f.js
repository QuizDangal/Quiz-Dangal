import{l as y}from"./index-279d7b71.js";const g=new Map;async function h(t,e){return e.slotId&&!e.isLegacy?t.rpc("pre_join_slot",{p_slot_id:e.slotId}):t.rpc("pre_join_quiz",{p_quiz_id:e.id})}async function j(t,e){return e.slotId&&!e.isLegacy?t.rpc("join_slot",{p_slot_id:e.slotId}):t.rpc("join_quiz",{p_quiz_id:e.id})}async function T({supabase:t,quiz:e,user:l}){const s=(e==null?void 0:e.slotId)||(e==null?void 0:e.id);if(!t||!e||!s)return{status:"error",error:new Error("Missing quiz or supabase client")};if(!l||!l.id)return{status:"error",error:new Error("Not authenticated")};try{const c=e.start_time?new Date(e.start_time).getTime():null,p=e.end_time?new Date(e.end_time).getTime():null,n=Date.now();if(!c||!p){const{error:o}=await h(t,e);return o?{status:"error",error:o}:{status:"pre_joined"}}const u=5e3,m=n>=c-u&&n<p,i=c-(u+1500);if(n<i){const{error:o}=await h(t,e);return o?{status:"error",error:o}:{status:"pre_joined"}}if(!m&&n>=i&&n<c-300){const{error:o}=await h(t,e);if(o)return{status:"error",error:o};if(!g.has(s)){const d=Math.max(50,c-(u-100)-Date.now()),f=setTimeout(async()=>{g.delete(s);try{const{error:r}=await j(t,e);if(r){const a=String(r.message||"").toLowerCase();if(a.includes("already")||a.includes("completed")){y.debug("Scheduled join: already joined/completed",s);return}if(a.includes("not active")){y.debug("Scheduled join: still not active, giving up this cycle",s);return}y.error("Scheduled join error",r.message||r)}else y.debug("Scheduled join success",s)}catch(r){y.error("Scheduled join throw",(r==null?void 0:r.message)||r)}},d);return g.set(s,f),{status:"scheduled_retry",scheduledAt:Date.now()+d}}return{status:"scheduled_retry",scheduledAt:null}}if(m){const{error:o}=await j(t,e);if(!o)return{status:"joined"};const d=String(o.message||"").toLowerCase();if(d.includes("already")||d.includes("completed"))return{status:"already"};if(d.includes("not active")){if(!g.has(s)){const r=setTimeout(async()=>{g.delete(s);try{const{error:a}=await j(t,e);a&&!String(a.message||"").toLowerCase().includes("already")&&y.error("Final join retry failed",a.message||a)}catch(a){y.error("Final join retry throw",(a==null?void 0:a.message)||a)}},600);return g.set(s,r),{status:"scheduled_retry",scheduledAt:Date.now()+600}}return{status:"scheduled_retry",scheduledAt:null}}return{status:"error",error:o}}const{error:_}=await h(t,e);return _?{status:"error",error:_}:{status:"pre_joined"}}catch(c){return{status:"error",error:c}}}function D(t){var c,p,n,u,m,i,_,o,d,f;if(!t)return null;const e=Number((n=(p=(c=t.participants_joined)!=null?c:t.joined_count)!=null?p:t.joined)!=null?n:0),l=Number((i=(m=(u=t.participants_pre)!=null?u:t.pre_joined_count)!=null?m:t.pre_joined)!=null?i:0),s=Number((_=t.participants_total)!=null?_:e+l);return{slotId:t.id||t.slot_id||t.slotid||t.slotID||t.slot_uuid||t.slot_uuid_id||t.slot_uuid_ref||t.quiz_slot_id||t.quiz_slot_uuid||t.slot_uuid_value||t.slot_ref||t.slot_reference||t.slot||null,quizId:t.quiz_id||t.quizid||t.quiz_uuid||t.quiz_uuid_id||t.quiz||null,category:t.category||null,title:t.quiz_title||t.title||t.slot_title||null,start_time:t.start_time||t.slot_start||t.starts_at||null,end_time:t.end_time||t.slot_end||t.ends_at||null,status:t.status||"scheduled",prizes:Array.isArray(t.prizes)?t.prizes:Array.isArray(t.quiz_prizes)?t.quiz_prizes:[],questions:Array.isArray(t.questions)?t.questions:[],prize_type:t.prize_type||t.quiz_prize_type||"coins",participants_joined:e,participants_pre:l,participants_total:s,questions_count:Number((f=(d=(o=t.questions_count)!=null?o:t.question_count)!=null?d:t.q_count)!=null?f:0),auto_enabled:typeof t.auto_enabled=="boolean"?t.auto_enabled:void 0,stop_override:!!t.stop_override}}async function I(t,e){if(!t)return{slots:[],mode:"none",auto:!0};let l=[],s=[],c=!0;try{const{data:i,error:_}=await t.from("quiz_slots_view").select("*").eq("category",e).order("start_time",{ascending:!0});!_&&i&&(l=i.map(D))}catch(i){y.debug("quiz_slots_view error",i.message||i)}try{const{data:i,error:_}=await t.from("quizzes").select("id,title,start_time,end_time,status,prizes,prize_type,slot_id,questions(count)").eq("category",e).order("start_time",{ascending:!0});if(!_&&i){const o=Date.now(),d=(i||[]).filter(r=>!r.slot_id);let f={};if(d.length>0)try{const{data:r}=await t.rpc("get_engagement_counts_many",{p_quiz_ids:d.map(a=>a.id)});if(r)for(const a of r)f[a.quiz_id]=(a.pre_joined||0)+(a.joined||0)}catch(r){}s=d.map(r=>{var a,z;return{slotId:r.id,quizId:r.id,category:e,title:r.title,quiz_title:r.title,start_time:r.start_time,end_time:r.end_time,status:v(r,o),prizes:Array.isArray(r.prizes)?r.prizes:[],prize_type:r.prize_type||"coins",participants_joined:f[r.id]||0,participants_total:f[r.id]||0,questions_count:((z=(a=r.questions)==null?void 0:a[0])==null?void 0:z.count)||0,auto_enabled:!0,isLegacy:!0}})}}catch(i){y.debug("Legacy quizzes fetch error",i.message||i)}try{const{data:i,error:_}=await t.from("category_runtime_overrides").select("category,auto_enabled:is_auto").eq("category",e).maybeSingle();!_&&i&&(c=!!i.auto_enabled)}catch(i){}const p=new Set(l.map(i=>i.quizId).filter(Boolean)),n=s.filter(i=>!p.has(i.quizId)),u=[...l,...n];u.sort((i,_)=>{const o=i.start_time?new Date(i.start_time).getTime():0,d=_.start_time?new Date(_.start_time).getTime():0;return o-d});const m=l.length>0?"slots":n.length>0?"legacy":"none";return{slots:u,mode:m,auto:c}}function v(t,e){const l=t.start_time?new Date(t.start_time).getTime():null,s=t.end_time?new Date(t.end_time).getTime():null;return l&&s&&e>=l&&e<s?"active":l&&e<l?"scheduled":s&&e>=s?"finished":"scheduled"}function A(t){const e=Date.now(),l=t.find(n=>{const u=n!=null&&n.start_time?new Date(n.start_time).getTime():null,m=n!=null&&n.end_time?new Date(n.end_time).getTime():null;return u&&m&&e>=u&&e<m}),s=t.filter(n=>{const u=n!=null&&n.start_time?new Date(n.start_time).getTime():null;return u?e<u:!1});s.sort((n,u)=>new Date(n.start_time).getTime()-new Date(u.start_time).getTime());const c=s[0]||null,p=s[1]||null;return{live:l,next:c,queued:p}}export{A as c,I as f,T as s};
