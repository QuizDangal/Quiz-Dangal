import{e as Se,u as De,k as Te,s as S,j as t,f as ae,d as k,m as Me,p as de,g as le}from"./index-279d7b71.js";import{r as p}from"./react-63c462fe.js";import{f as ke,c as Ee,s as $e}from"./slots-a4fbbb0f.js";import{S as Ce}from"./SEO-7fcbe476.js";import{c as Le,b as Je}from"./router-d6d570a4.js";import{b as Pe,c as Ae,M as ce,B as Ue,T as Oe,a as Qe}from"./icons-1e9e0bae.js";import"./supabase-07ebd5d8.js";const D=new Map;let ue=0;function A(a){if(!(ue%200!==0&&D.size<100))for(const[d,m]of D.entries()){const l=(m.windowMs||8e3)*2;a-m.firstTs>l&&D.delete(d)}}function Be(a,{max:d=5,windowMs:m=8e3}={}){ue+=1;const l=Date.now(),b=D.get(a);return b?l-b.firstTs>b.windowMs?(D.set(a,{count:1,firstTs:l,windowMs:m}),A(l),{allowed:!0,remaining:d-1}):b.count>=d?(A(l),{allowed:!1,remaining:0}):(b.count+=1,A(l),{allowed:!0,remaining:d-b.count}):(D.set(a,{count:1,firstTs:l,windowMs:m}),A(l),{allowed:!0,remaining:d-1})}function qe(a=""){const d=String(a||"").toLowerCase();return d.includes("opinion")?{title:"Opinion Quizzes",emoji:"ðŸ’¬",Icon:ce,from:"from-indigo-600/30",to:"to-fuchsia-600/30",ring:"ring-fuchsia-500/30"}:d.includes("gk")?{title:"GK Quizzes",emoji:"ðŸ§ ",Icon:Ue,from:"from-emerald-600/30",to:"to-teal-600/30",ring:"ring-emerald-500/30"}:d.includes("sport")?{title:"Sports Quizzes",emoji:"ðŸ†",Icon:Oe,from:"from-orange-600/30",to:"to-red-600/30",ring:"ring-orange-500/30"}:d.includes("movie")?{title:"Movie Quizzes",emoji:"ðŸŽ¬",Icon:Qe,from:"from-violet-600/30",to:"to-indigo-600/30",ring:"ring-violet-500/30"}:{title:`${a} Quizzes`,emoji:"â­",Icon:ce,from:"from-sky-600/30",to:"to-indigo-600/30",ring:"ring-sky-500/30"}}const U=a=>a!=null&&a.start_time?new Date(a.start_time).getTime():null,pe=a=>a!=null&&a.end_time?new Date(a.end_time).getTime():null,me=a=>{const d=U(a),m=pe(a);if(!d||!m)return!1;const l=Date.now();return l>=d&&l<m},Fe=a=>{const d=U(a);return d?Date.now()<d:!1},Xe=()=>{const{slug:a}=Le(),d=Je(),{toast:m}=Se(),{user:l}=De(),{isSubscribed:b,subscribeToPush:xe}=Te(),[g]=p.useState([]),[H,K]=p.useState(!0),[E,Y]=p.useState(null),[ge,X]=p.useState({}),[Z,y]=p.useState({}),[fe,ee]=p.useState(0),[f,he]=p.useState([]),[w,O]=p.useState("detect"),[be,ye]=p.useState(!0),we=2e4,$=p.useCallback(async()=>{if(S)try{const{slots:e,mode:i,auto:s}=await ke(S,a);he(e),ye(s),O(i==="slots"||i==="legacy"?"slots":"legacy")}catch(e){O("legacy")}},[a]);p.useEffect(()=>{K(!0),$().finally(()=>{K(!1)})},[$,a]),p.useEffect(()=>{if(w==="none")return;const e=setInterval(()=>{$()},we);return()=>clearInterval(e)},[w,$]),p.useEffect(()=>{const e=Date.now();if(!(g||[]).some(n=>{const o=n.start_time?new Date(n.start_time).getTime():0,r=n.end_time?new Date(n.end_time).getTime():0;return o&&e<o||o&&r&&e>=o&&e<r}))return;const s=setInterval(()=>ee(n=>(n+1)%1e6),1e3);return()=>clearInterval(s)},[g]),p.useEffect(()=>{if(w!=="slots")return;const e=Date.now();if(!(f||[]).some(n=>{const o=n.start_time?new Date(n.start_time).getTime():0,r=n.end_time?new Date(n.end_time).getTime():0;return o&&e<o||o&&r&&e>=o&&e<r}))return;const s=setInterval(()=>ee(n=>(n+1)%1e6),1e3);return()=>clearInterval(s)},[f,w]),p.useEffect(()=>{const e=async()=>{try{const i=(g||[]).map(r=>r.id);if(!i.length){X({});return}const{data:s,error:n}=await S.rpc("get_engagement_counts_many",{p_quiz_ids:i});if(n)throw n;const o={};for(const r of s||[]){const c=r.pre_joined||0,u=r.joined||0;o[r.quiz_id]=c+u}X(o)}catch(i){}};g&&g.length&&e()},[g]),p.useEffect(()=>{(async()=>{const i=(g||[]).map(r=>r.id).filter(Boolean),s=(f||[]).filter(r=>!r.isLegacy).map(r=>r.slotId).filter(Boolean),n=(f||[]).filter(r=>r.isLegacy).map(r=>r.quizId).filter(Boolean),o=[...new Set([...i,...n])];if(!l||!o.length&&!s.length){y({});return}try{const r={};if(o.length){const{data:c,error:u}=await S.from("quiz_participants").select("quiz_id,status").eq("user_id",l.id).in("quiz_id",o);if(!u&&c)for(const x of c)r[x.quiz_id]=x.status==="pre_joined"?"pre":"joined"}if(s.length){const{data:c,error:u}=await S.from("quiz_participants").select("slot_id,status").eq("user_id",l.id).in("slot_id",s);if(!u&&c)for(const x of c)r[x.slot_id]=x.status==="pre_joined"?"pre":"joined"}y(r)}catch(r){y({})}})()},[l,g,f]);const te=async e=>{if(!l){m({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),d("/login");return}const i=e.slotId||e.id;Y(i);try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!b&&Promise.resolve().then(()=>xe()).catch(()=>{})}catch(s){}try{const s=await $e({supabase:S,quiz:e,user:l});if(s.status==="error")throw s.error;s.status==="already"?(y(n=>({...n,[i]:"joined"})),m({title:"Already Joined",description:"You are in this quiz."})):s.status==="joined"?(y(o=>({...o,[i]:"joined"})),Be(`join_${(l==null?void 0:l.id)||"anon"}`,{max:4,windowMs:8e3}).allowed?(m({title:"Joined!",description:"Taking you to the quiz."}),d(e.slotId&&!e.isLegacy?`/quiz/slot/${e.slotId}`:`/quiz/${e.id}`)):m({title:"Slow down",description:"Please wait a moment before trying again.",variant:"destructive"})):s.status==="pre_joined"?(y(n=>({...n,[i]:"pre"})),m({title:"Pre-joined!",description:"We will remind you before start."})):s.status==="scheduled_retry"&&(y(n=>({...n,[i]:"pre"})),m({title:"Pre-joined!",description:"Auto joining at start time."}))}catch(s){m({title:"Error",description:(s==null?void 0:s.message)||"Could not join quiz.",variant:"destructive"})}finally{Y(null)}},se=g.filter(e=>{if(w==="slots")return!1;const i=Date.now(),s=e.start_time?new Date(e.start_time).getTime():0,n=e.end_time?new Date(e.end_time).getTime():0,o=s&&n&&i>=s&&i<n,r=s&&i<s;return o||r}),C=qe(a),_=Date.now(),Q=w==="slots",T=Q?f:g||[],je=Q?T.filter(e=>me(e)).length:T.reduce((e,i)=>{const s=i.start_time?new Date(i.start_time).getTime():0,n=i.end_time?new Date(i.end_time).getTime():0;return e+(s&&n&&_>=s&&_<n?1:0)},0),ve=T.filter(e=>{const i=e.start_time?new Date(e.start_time).getTime():0;return!i||_>=i?!1:e.isLegacy?!0:i-_<=300*1e3}).length,B=Q?T.map(e=>U(e)).filter(e=>e&&e>_).sort((e,i)=>e-i)[0]||null:T.map(e=>e.start_time?new Date(e.start_time).getTime():null).filter(e=>e&&e>_).sort((e,i)=>e-i)[0]||null,{next:L}=Ee(f),Ne=e=>{var ne,re,oe;if(!e)return null;const i=Date.now(),s=U(e),n=pe(e),o=me(e),r=e.status==="paused",c=e.status==="finished"||n&&i>=n,u=Fe(e),x=u&&s?Math.max(0,Math.floor((s-i)/1e3)):o&&n?Math.max(0,Math.floor((n-i)/1e3)):null,j=Array.isArray(e.prizes)?e.prizes:[],q=e.prize_type||"coins",F=(ne=j[0])!=null?ne:0,V=(re=j[1])!=null?re:0,W=(oe=j[2])!=null?oe:0,v=Ie=>le(q,Ie,{fallback:0}).formatted,G=e.participants_total||e.participants_joined||0,J=e.questions_count||10,P=!be&&!o&&!u,N=o&&!c?"LIVE":r?"PAUSED":P?"STOPPED":u?"UPCOMING":c?"FINISHED":(e.status||"").toUpperCase(),M=e.isLegacy?e.quizId:e.slotId,h=!!Z[M],z=E===M,ie=c?"Results":o?h?"Play":"Join Now":u?h?"Joined âœ“":"Pre-Join":"View",ze=async()=>{if(c||h&&!o){d(e.isLegacy?`/quiz/${e.quizId}`:`/quiz/slot/${e.slotId}`);return}if(o){d(e.isLegacy?`/quiz/${e.quizId}`:`/quiz/slot/${e.slotId}`);return}u&&!h&&await te({id:e.quizId,...e})};return t.jsx("div",{className:`p-[1px] rounded-xl sm:rounded-2xl ${o?"bg-gradient-to-r from-emerald-500/60 to-green-500/60":"bg-gradient-to-r from-indigo-500/40 via-violet-500/30 to-fuchsia-500/40"}`,children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4 lg:p-5",children:[t.jsx("div",{className:"flex justify-end mb-1.5 sm:mb-2",children:t.jsx("span",{className:`px-2 sm:px-3 py-0.5 sm:py-1 rounded-md text-[9px] sm:text-[11px] font-bold ${N==="LIVE"?"bg-rose-600 text-white":N==="UPCOMING"?"bg-sky-600 text-white":N==="PAUSED"?"bg-amber-600 text-white":"bg-slate-700 text-slate-300"}`,children:N})}),t.jsx("h3",{className:"text-sm sm:text-base font-bold text-white mb-2 sm:mb-3 line-clamp-2",children:e.quiz_title||e.title||"Quiz"}),t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 text-[10px] sm:text-xs text-slate-400 mb-2 sm:mb-3",children:[t.jsxs("div",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[t.jsx("span",{className:"text-[9px] sm:text-[10px] text-slate-500",children:"Start"})," ",e.start_time?k(e.start_time):"â€”"]}),t.jsxs("div",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[t.jsx("span",{className:"text-[9px] sm:text-[10px] text-slate-500",children:"End"})," ",e.end_time?k(e.end_time):"â€”"]})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 text-[10px] sm:text-xs mb-2 sm:mb-3",children:[t.jsxs("span",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-r from-amber-500/20 to-amber-400/10 text-amber-200 border border-amber-500/30 shadow-sm",children:["ðŸ¥‡ ",v(F)]}),t.jsxs("span",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-r from-sky-500/20 to-sky-400/10 text-sky-200 border border-sky-500/30 shadow-sm",children:["ðŸ¥ˆ ",v(V)]}),t.jsxs("span",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-r from-violet-500/20 to-violet-400/10 text-violet-200 border border-violet-500/30 shadow-sm",children:["ðŸ¥‰ ",v(W)]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2 sm:mb-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-[10px] sm:text-xs",children:[t.jsxs("span",{className:"px-2 py-1 rounded-md bg-slate-800/70 border border-slate-700/50 text-slate-300",children:["ðŸ“ ",J," Questions"]}),t.jsxs("span",{className:"px-2 py-1 rounded-md bg-slate-800/70 border border-slate-700/50 text-slate-300",children:["ðŸ‘¥ ",G," Joined"]})]}),x!==null&&t.jsxs("div",{className:"text-xs sm:text-sm font-semibold text-indigo-300",children:[u?"In":"Ends"," ",Math.floor(x/60).toString().padStart(2,"0"),":",(x%60).toString().padStart(2,"0")]})]}),t.jsx("button",{type:"button",disabled:z||h&&u,onClick:ze,onMouseEnter:()=>de(e.isLegacy?`/quiz/${e.quizId}`:`/quiz/slot/${e.slotId}`),className:`w-full h-9 sm:h-10 lg:h-11 rounded-lg text-xs sm:text-sm font-bold text-white transition ${z?"opacity-50 cursor-wait":h&&u?"bg-gradient-to-r from-emerald-700 to-green-600 cursor-default":o?"bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90":"bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90"}`,children:z?"Joining...":ie})]})},e.slotId)};p.useEffect(()=>{if(!L)return;const e=L.start_time?new Date(L.start_time).getTime():null;if(!e)return;const i=Date.now(),s=e-i-6e4;if(s<=0||s>1800*1e3)return;const n=setTimeout(()=>{try{m({title:"Upcoming Slot",description:"1 minute to start â€“ be ready!",duration:4e3})}catch(o){}},s);return()=>clearTimeout(n)},[L,m]);const _e=typeof window!="undefined"?`${window.location.origin}/category/${a}/`:`https://quizdangal.com/category/${a}/`;return t.jsxs("div",{className:"px-3 sm:px-4 pt-16 sm:pt-20 pb-6",children:[t.jsx(Ce,{title:`${C.title} â€“ Quiz Dangal`,description:`Active and upcoming quizzes in ${C.title}.`,canonical:_e,robots:"index, follow"}),t.jsx("span",{className:"hidden","aria-hidden":!0,children:fe}),t.jsxs("div",{className:"max-w-md sm:max-w-2xl lg:max-w-4xl mx-auto space-y-4",children:[t.jsx("div",{className:"p-[1px] rounded-xl sm:rounded-2xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4 lg:p-5",children:[t.jsxs("div",{className:"flex items-center gap-3 sm:gap-4 mb-2",children:[t.jsx("div",{className:"w-9 h-9 sm:w-12 sm:h-12 lg:w-14 lg:h-14 rounded-lg sm:rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-lg sm:text-2xl lg:text-3xl",children:C.emoji}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("h1",{className:"text-base sm:text-xl lg:text-2xl font-bold text-white truncate",children:C.title}),t.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-[10px] sm:text-xs mt-1",children:[t.jsxs("span",{className:"px-1.5 sm:px-2.5 py-0.5 sm:py-1 rounded sm:rounded-md bg-emerald-600/20 text-emerald-300 border border-emerald-600/30",children:[je," live"]}),t.jsxs("span",{className:"px-1.5 sm:px-2.5 py-0.5 sm:py-1 rounded sm:rounded-md bg-sky-600/20 text-sky-300 border border-sky-600/30",children:[ve," upcoming"]})]})]})]}),B&&t.jsxs("div",{className:"flex items-center gap-1 text-[10px] sm:text-xs text-slate-400",children:[t.jsx(Pe,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Next: ",ae(B)," â€¢ ",k(B)]})]})}),w==="slots"?t.jsx(t.Fragment,{children:H?t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:Array.from({length:3}).map((e,i)=>t.jsx("div",{className:"h-40 sm:h-48 lg:h-52 rounded-xl sm:rounded-2xl bg-slate-800/60 border border-slate-700/60 animate-pulse"},i))}):t.jsx(t.Fragment,{children:f.filter(e=>{const i=Date.now(),s=e.start_time?new Date(e.start_time).getTime():null,n=e.end_time?new Date(e.end_time).getTime():null,o=s&&n&&i>=s&&i<n,r=s&&i<s,c=r&&s-i<=300*1e3;return o||(e.isLegacy?r:c)}).length>0?t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:f.filter(e=>{const i=Date.now(),s=e.start_time?new Date(e.start_time).getTime():null,n=e.end_time?new Date(e.end_time).getTime():null,o=s&&n&&i>=s&&i<n,r=s&&i<s,c=r&&s-i<=300*1e3;return o||(e.isLegacy?r:c)}).map(e=>Ne(e))}):t.jsx("div",{className:"rounded-xl sm:rounded-2xl border border-slate-800 bg-slate-900/50 p-4 sm:p-6 text-center text-sm sm:text-base text-slate-400",children:"No quizzes scheduled yet."})})}):H?t.jsx("div",{className:"grid gap-3 sm:gap-4",children:Array.from({length:4}).map((e,i)=>t.jsx("div",{className:"h-24 sm:h-28 rounded-xl sm:rounded-2xl bg-slate-800/60 border border-slate-700/60 animate-pulse"},i))}):se.length===0?t.jsx("div",{className:"text-center text-muted-foreground py-16",children:"No quizzes in this category yet."}):t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:se.map((e,i)=>{var R,h,z;const s=Date.now(),n=e.start_time?new Date(e.start_time).getTime():null,o=e.end_time?new Date(e.end_time).getTime():null,r=n&&o&&s>=n&&s<o,c=n&&s<n,u=r||c,x=c&&n?Math.max(0,Math.floor((n-s)/1e3)):r&&o?Math.max(0,Math.floor((o-s)/1e3)):null,j=Array.isArray(e.prizes)?e.prizes:[],q=e.prize_type||"coins",F=(R=j[0])!=null?R:0,V=(h=j[1])!=null?h:0,W=(z=j[2])!=null?z:0,v=I=>le(q,I,{fallback:0}).formatted,G=ge[e.id]||0,J=Z[e.id],P=!!J,N=n&&o?Math.max(1,o-n):null,M=r&&N?Math.min(100,Math.max(0,Math.round((s-n)/N*100))):null;return t.jsx(Me.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{delay:i*.02},onClick:()=>d(`/quiz/${e.id}`),className:"cursor-pointer",role:"button",tabIndex:0,onKeyDown:I=>{I.key==="Enter"&&d(`/quiz/${e.id}`)},children:t.jsx("div",{className:`p-[1px] rounded-xl sm:rounded-2xl ${r?"bg-gradient-to-r from-emerald-500/60 to-green-500/60":"bg-gradient-to-r from-indigo-500/40 via-violet-500/30 to-fuchsia-500/40"}`,children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[t.jsx("h3",{className:"text-sm sm:text-base font-bold text-white flex-1 min-w-0 line-clamp-2",children:e.title}),t.jsxs("div",{className:"shrink-0 flex items-center gap-1",children:[r&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-bold bg-rose-600 text-white",children:"LIVE"}),c&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-bold bg-sky-600 text-white",children:"SOON"}),J&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-semibold bg-indigo-600/20 text-indigo-300 border border-indigo-500/40",children:"Joined"})]})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5 text-[10px] sm:text-xs mb-2",children:[t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-amber-500/15 text-amber-300 border border-amber-600/30",children:["ðŸ¥‡ ",v(F)]}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-sky-500/15 text-sky-300 border border-sky-600/30",children:["ðŸ¥ˆ ",v(V)]}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-violet-500/15 text-violet-300 border border-violet-600/30",children:["ðŸ¥‰ ",v(W)]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-[10px] sm:text-xs text-slate-400 mb-2",children:[t.jsx("span",{children:e.start_time?ae(e.start_time):"â€”"}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[e.start_time?k(e.start_time):"â€”"," - ",e.end_time?k(e.end_time):"â€”"]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[t.jsxs("div",{className:"flex items-center gap-1 text-[10px] sm:text-xs text-slate-500",children:[t.jsx(Ae,{className:"w-3 h-3 sm:w-4 sm:h-4"}),G," joined"]}),x!==null&&t.jsxs("div",{className:"text-xs sm:text-sm font-semibold text-indigo-300",children:[c?"In":"Ends"," ",Math.floor(x/60).toString().padStart(2,"0"),":",(x%60).toString().padStart(2,"0")]})]}),M!==null&&t.jsx("div",{className:"mb-2 w-full bg-slate-800 rounded-full h-1 sm:h-1.5 overflow-hidden",children:t.jsx("div",{className:"h-full bg-emerald-500",style:{width:`${M}%`}})}),t.jsx("button",{type:"button",onClick:I=>{I.stopPropagation(),P||!u?d(`/quiz/${e.id}`):te(e)},onMouseEnter:()=>de("/quiz"),disabled:E===e.id,className:`w-full h-9 sm:h-10 rounded-lg text-xs sm:text-sm font-bold text-white transition ${r?"bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90":"bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90"} ${E===e.id?"opacity-80":""}`,children:P?"JOINED":u?E===e.id?"JOININGâ€¦":"JOIN":"VIEW"})]})})},e.id)})})]})]})};export{Xe as default};
