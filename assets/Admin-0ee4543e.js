import{j as e,o as Te,a as ge,u as De,s as g,H as Ae,h as Le,B as q,A as Me,m as ue,q as he}from"./index-93c1c8bc.js";import{a as O,r as f}from"./react-63c462fe.js";import{L as H,I as J}from"./label-f10349f2.js";import{d as Oe,L as Pe}from"./router-d6d570a4.js";import{L as X,N as Ne,O as Be,i as Fe,r as Ue,Q as Ve,V as Ze}from"./icons-1e9e0bae.js";import"./supabase-07ebd5d8.js";const ze=O.forwardRef(({className:o,...h},z)=>e.jsx("textarea",{ref:z,className:Te("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",o),...h}));ze.displayName="Textarea";const ae=["opinion","gk","sports","movies"],Ge=[121,71,51],$e=5,Z=192,_e=10;function He(){const o=[];let h=8,z=0;for(;h<24;)o.push(String(h).padStart(2,"0")+":"+String(z).padStart(2,"0")),z+=$e,z>=60&&(h++,z=z-60);return o}const ne={opinion:{bg:"bg-pink-600/20",border:"border-pink-500",text:"text-pink-400",badge:"bg-pink-600"},gk:{bg:"bg-emerald-600/20",border:"border-emerald-500",text:"text-emerald-400",badge:"bg-emerald-600"},sports:{bg:"bg-blue-600/20",border:"border-blue-500",text:"text-blue-400",badge:"bg-blue-600"},movies:{bg:"bg-amber-600/20",border:"border-amber-500",text:"text-amber-400",badge:"bg-amber-600"}},ke=({category:o,className:h="w-4 h-4"})=>({opinion:e.jsx("svg",{className:h,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),gk:e.jsx("svg",{className:h,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})}),sports:e.jsx("svg",{className:h,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),movies:e.jsx("svg",{className:h,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"})})})[o]||null;function We(){var de;const{toast:o}=ge(),{userProfile:h}=De(),z=String((h==null?void 0:h.role)||"").toLowerCase()==="admin",[D,L]=f.useState(!1),[P,$]=f.useState(null),[E,T]=f.useState(!1),[_,U]=f.useState("gk"),[R,M]=f.useState(()=>new Date().toISOString().slice(0,10)),[Q,x]=f.useState(""),[d,N]=f.useState(!1),[w,l]=f.useState([]),[a,I]=f.useState(null),G=f.useMemo(()=>new Date().toISOString().slice(0,10),[]),K=f.useMemo(()=>{const i=new Date;return i.setDate(i.getDate()+2),i.toISOString().slice(0,10)},[]),Y=f.useCallback(async()=>{L(!0);try{const{data:i,error:n}=await g.rpc("get_scheduler_status");if(!n&&i){$(i);return}console.warn("get_scheduler_status RPC failed, using fallback:",n==null?void 0:n.message);const{data:u}=await g.from("category_runtime_overrides").select("category, is_auto").in("category",ae),{data:p}=await g.from("quiz_slots").select("category, status, target_date").gte("target_date",new Date().toISOString().slice(0,10)),C=new Date().toISOString().slice(0,10),v=ae.map(k=>{var F;const j=u==null?void 0:u.find(A=>A.category===k),y=(p==null?void 0:p.filter(A=>{var t;return A.category===k&&((t=A.target_date)==null?void 0:t.slice(0,10))===C}))||[];return{category:k,is_auto:(F=j==null?void 0:j.is_auto)!=null?F:!0,today:{total:y.length,active:y.filter(A=>A.status==="active").length,finished:y.filter(A=>A.status==="finished").length,scheduled:y.filter(A=>A.status==="scheduled").length,skipped:y.filter(A=>A.status==="skipped").length}}});$({ok:!0,today:C,current_time:new Date().toISOString(),categories:v})}catch(i){console.error("loadStatus error:",i),$({ok:!1,today:new Date().toISOString().slice(0,10),current_time:new Date().toISOString(),categories:ae.map(n=>({category:n,is_auto:!0,today:{total:0,active:0,finished:0,scheduled:0,skipped:0}}))})}finally{L(!1)}},[]);f.useEffect(()=>{Y();const i=setInterval(Y,3e4);return()=>clearInterval(i)},[Y]);const le=async(i,n)=>{if(z)try{const{error:u}=await g.rpc("toggle_category_auto",{p_category:i,p_enabled:!n});if(u)throw u;o({title:n?"â¸ï¸ Paused":"â–¶ï¸ Resumed",description:`${i} quiz scheduling ${n?"paused":"enabled"}.`}),Y()}catch(u){o({title:"Toggle failed",description:u==null?void 0:u.message,variant:"destructive"})}},se=f.useCallback(()=>Array.from({length:Z}).map((i,n)=>({index:n+1,title:"",questions:Array.from({length:_e}).map(()=>({question_text:"",options:Array.from({length:4}).map(()=>({option_text:"",is_correct:!1}))}))})),[]),fe=(i="gk")=>{U(i),M(G),x(""),l(se()),I(null),T(!0)},be=f.useCallback(i=>{var v,k;const n=[],u=[],p=String(i||"").trim();if(!p)return{slots:n,errors:u};if(p.startsWith("[")||p.startsWith("{"))try{const j=JSON.parse(p),y=Array.isArray(j)?j:[j];for(const F of y){const A=F.title||"Untitled",s=(Array.isArray(F.questions)?F.questions:[]).slice(0,10).map(c=>({question_text:c.question_text||c.text||"",options:(c.options||[]).slice(0,4).map((m,r)=>({option_text:m.option_text||m.text||String(m).trim(),is_correct:_==="opinion"?!1:!!(m.is_correct||m.correct||c.correctIndex===r)}))}));n.push({title:A,questions:s})}return{slots:n,errors:u}}catch(j){return u.push("JSON parse failed: "+j.message),{slots:n,errors:u}}const C=p.split(/\n(?=Category:|Title:)/i);for(const j of C){const y=j.split(/\r?\n/).map(c=>c.trim()).filter(Boolean);if(!y.length)continue;let F="Untitled";const A=[];let t=null;for(const c of y){if(/^Category:/i.test(c))continue;if(/^Title:/i.test(c)){F=c.split(/:/).slice(1).join(":").trim();continue}if(/^Prizes?:/i.test(c))continue;const m=c.match(/^Q\d+\.\s*(.+)$/i);if(m){t&&A.push(t),t={question_text:m[1].trim(),options:[],correctIndex:-1};continue}const r=c.match(/^(?:[-*â€¢]|[A-D]\)|[A-D][.:])\s*(.+)$/);if(r&&t){t.options.push({option_text:r[1].trim(),is_correct:!1});continue}const b=c.match(/^Ans(wer)?[:\s]+(.+)$/i);if(b&&t){const V=(k=(v=b[2].trim().match(/^[A-D]/i))==null?void 0:v[0])==null?void 0:k.toUpperCase();V&&(t.correctIndex={A:0,B:1,C:2,D:3}[V])}}t&&A.push(t);const s=A.slice(0,10).map(c=>({question_text:c.question_text,options:c.options.slice(0,4).map((m,r)=>({option_text:m.option_text,is_correct:_==="opinion"?!1:c.correctIndex===r}))}));s.length>0&&n.push({title:F,questions:s})}return{slots:n,errors:u}},[_]),te=()=>{const{slots:i,errors:n}=be(Q);if(n.length){o({title:"Parse errors",description:n[0],variant:"destructive"});return}if(i.length===0){o({title:"No quizzes found",description:"Could not parse any quizzes from the text.",variant:"destructive"});return}if(i.length!==Z){o({title:"Quiz count mismatch",description:`Found ${i.length} quizzes, need exactly ${Z}.`,variant:"destructive"});return}const u=i.map((p,C)=>{const v={index:C+1,title:p.title||`Quiz ${C+1}`,questions:p.questions.slice(0,_e).map(k=>({question_text:k.question_text||"",options:k.options.slice(0,4).map(j=>({option_text:j.option_text||"",is_correct:_==="opinion"?!1:!!j.is_correct}))}))};for(;v.questions.length<_e;)v.questions.push({question_text:"",options:Array.from({length:4}).map(()=>({option_text:"",is_correct:!1}))});for(const k of v.questions)for(;k.options.length<4;)k.options.push({option_text:"",is_correct:!1});return v});l(u),o({title:"âœ… Form populated",description:`${i.length} quizzes loaded into form.`})},ve=(i,n)=>{l(u=>u.map((p,C)=>C===i?{...p,title:n}:p))},je=(i,n,u)=>{l(p=>p.map((C,v)=>{if(v!==i)return C;const k=C.questions.map((j,y)=>y===n?{...j,question_text:u}:j);return{...C,questions:k}}))},ce=(i,n,u,p)=>{l(C=>C.map((v,k)=>{if(k!==i)return v;const j=v.questions.map((y,F)=>{if(F!==n)return y;const A=y.options.map((t,s)=>s===u?{...t,option_text:p}:t);return{...y,options:A}});return{...v,questions:j}}))},ye=(i,n,u)=>{_!=="opinion"&&l(p=>p.map((C,v)=>{if(v!==i)return C;const k=C.questions.map((j,y)=>{if(y!==n)return j;const F=j.options.map((A,t)=>({...A,is_correct:t===u}));return{...j,options:F}});return{...C,questions:k}}))},B=async()=>{if(z){N(!0);try{if(w.length!==Z)throw new Error(`Need exactly ${Z} quizzes, found ${w.length}`);for(const v of w){if(!v.title.trim())throw new Error(`Quiz #${v.index}: Title is empty`);for(let k=0;k<v.questions.length;k++){const j=v.questions[k];if(!j.question_text.trim())throw new Error(`Quiz #${v.index}, Q${k+1}: Question is empty`);for(let y=0;y<j.options.length;y++)if(!j.options[y].option_text.trim())throw new Error(`Quiz #${v.index}, Q${k+1}, Option ${y+1}: Option is empty`);if(_!=="opinion"&&!j.options.some(y=>y.is_correct))throw new Error(`Quiz #${v.index}, Q${k+1}: No correct answer selected`)}}const i=He(),n=w.map((v,k)=>({time:i[k],title:v.title.trim(),prizes:Ge,questions:v.questions.map(j=>({question_text:j.question_text.trim(),options:j.options.map(y=>({option_text:y.option_text.trim(),is_correct:_==="opinion"?!1:y.is_correct}))}))})),u={target_date:R,categories:{[_]:n}},{data:p,error:C}=await g.rpc("admin_seed_quiz_day_multi",{p_payload:u});if(C)throw C;o({title:"ðŸŽ‰ Deployed!",description:`${Z} quizzes deployed for ${_} on ${R}.`}),T(!1),Y()}catch(i){o({title:"Deploy failed",description:i==null?void 0:i.message,variant:"destructive"})}finally{N(!1)}}},ee=f.useCallback(i=>{if(!i.title.trim())return{valid:!1,error:"No title"};for(let n=0;n<i.questions.length;n++){const u=i.questions[n];if(!u.question_text.trim())return{valid:!1,error:`Q${n+1} empty`};for(let p=0;p<u.options.length;p++)if(!u.options[p].option_text.trim())return{valid:!1,error:`Q${n+1} opt ${p+1} empty`};if(_!=="opinion"&&!u.options.some(p=>p.is_correct))return{valid:!1,error:`Q${n+1} no answer`}}return{valid:!0}},[_]),ie=f.useMemo(()=>w.filter(i=>ee(i).valid).length,[w,ee]);return e.jsxs("div",{className:"relative min-h-[600px] rounded-2xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900"}),e.jsx("div",{className:"absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiM2MzY2ZjEiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTM2IDM0djItSDI0di0yaDEyek0zNiAyNHYySDI0di0yaDEyeiIvPjwvZz48L2c+PC9zdmc+')] opacity-50"}),e.jsx("div",{className:"absolute top-0 right-0 w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-80 h-80 bg-purple-600/10 rounded-full blur-3xl"}),e.jsxs("div",{className:"relative z-10 p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx("svg",{className:"w-6 h-6 text-indigo-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),"Quiz Scheduler"]}),e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:[Z," quizzes/day â€¢ 08:00 - 23:55 IST â€¢ ",$e," min quiz"]})]}),D&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-400",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"}),"Loading..."]})]}),P&&e.jsxs("div",{className:"bg-slate-800/50 rounded-xl border border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-300",children:"Today's Status"}),e.jsxs("span",{className:"text-[10px] text-slate-500",children:[P.today," â€¢ ",new Date(P.current_time).toLocaleTimeString("en-IN",{timeZone:"Asia/Kolkata"})," IST"]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:(de=P.categories)==null?void 0:de.map(i=>{const n=ne[i.category]||ne.gk,u=i.today.total>0?(i.today.finished/i.today.total*100).toFixed(0):0;return e.jsxs("div",{className:`rounded-lg border ${n.border} ${n.bg} p-3`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(ke,{category:i.category,className:`w-4 h-4 ${n.text}`}),e.jsx("span",{className:`text-xs font-semibold uppercase ${n.text}`,children:i.category})]}),e.jsx("button",{onClick:()=>le(i.category,i.is_auto),disabled:!z,className:`px-2 py-0.5 rounded text-[10px] font-medium transition-all ${i.is_auto?"bg-emerald-600 text-white hover:bg-emerald-700":"bg-rose-600/80 text-white hover:bg-rose-600"} disabled:opacity-50`,children:i.is_auto?"â–¶ ON":"â¸ OFF"})]}),i.today.total>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-1.5 bg-slate-700 rounded-full overflow-hidden mb-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all duration-500",style:{width:`${u}%`}})}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-400",children:[e.jsxs("span",{children:["âœ“ ",i.today.finished,"/",i.today.total]}),e.jsx("span",{className:"text-emerald-400",children:i.today.active>0?`â— Live: ${i.today.active}`:""})]})]}):e.jsx("div",{className:"text-[10px] text-slate-500 mt-1",children:"No quizzes deployed"})]},i.category)})})]}),z&&e.jsxs("div",{className:"bg-gradient-to-br from-indigo-900/30 to-purple-900/20 rounded-xl border border-indigo-600/30 p-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-indigo-300 mb-3 flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Bulk Deploy Quizzes"]}),e.jsxs("p",{className:"text-[11px] text-slate-400 mb-4",children:["Deploy ",Z," quizzes for any category. You can deploy up to 3 days in advance."]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ae.map(i=>{const n=ne[i];return e.jsxs("button",{onClick:()=>fe(i),className:`flex items-center gap-2 px-4 py-2 rounded-lg border ${n.border} ${n.bg} hover:opacity-90 transition-all`,children:[e.jsx(ke,{category:i,className:`w-4 h-4 ${n.text}`}),e.jsx("span",{className:`text-sm font-medium ${n.text} capitalize`,children:i})]},i)})})]}),E&&e.jsx("div",{className:"fixed inset-0 z-[200] flex items-start justify-center bg-black/70 backdrop-blur-sm overflow-y-auto p-4",children:e.jsxs("div",{className:"w-full max-w-4xl my-8 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl",children:[e.jsx("div",{className:`p-4 rounded-t-2xl border-b border-slate-700 ${ne[_].bg}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ke,{category:_,className:`w-6 h-6 ${ne[_].text}`}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-bold text-white",children:["Bulk Deploy - ",_.toUpperCase()]}),e.jsxs("p",{className:"text-xs text-slate-400",children:[Z," quizzes Ã— 10 questions Ã— 4 options"]})]})]}),e.jsx("button",{onClick:()=>T(!1),className:"p-2 rounded-lg hover:bg-slate-700/50 text-slate-400 hover:text-white transition",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bulk-category-select",className:"block text-[10px] text-slate-500 mb-1",children:"CATEGORY"}),e.jsx("select",{id:"bulk-category-select",value:_,onChange:i=>U(i.target.value),className:"bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200",children:ae.map(i=>e.jsx("option",{value:i,children:i.toUpperCase()},i))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bulk-date-input",className:"block text-[10px] text-slate-500 mb-1",children:"DATE (Max 3 days)"}),e.jsx("input",{id:"bulk-date-input",type:"date",value:R,min:G,max:K,onChange:i=>M(i.target.value),className:"bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200"})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-[10px] text-slate-500",children:"VALID QUIZZES"}),e.jsxs("div",{className:`text-2xl font-bold ${ie===Z?"text-emerald-400":"text-amber-400"}`,children:[ie,"/",Z]})]})]}),e.jsxs("div",{className:"bg-slate-800/50 rounded-xl border border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-slate-300",children:"Paste Quiz Data"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:te,disabled:!Q.trim(),className:"px-3 py-1.5 rounded-lg text-xs font-medium bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-40 transition",children:"Fill Form â†’"}),e.jsx("button",{onClick:()=>x(""),className:"px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition",children:"Clear"})]})]}),e.jsx("textarea",{value:Q,onChange:i=>x(i.target.value),className:"w-full h-28 rounded-lg border border-slate-600 bg-slate-900 text-slate-200 text-xs p-3 font-mono resize-none",placeholder:`Paste ${Z} quiz blocks in format:

Title: Morning Quiz
Q1. Question text?
- A) Option A
- B) Option B
- C) Option C
- D) Option D
Answer: A
...`})]}),e.jsxs("div",{className:"space-y-2 max-h-[50vh] overflow-y-auto pr-2",children:[e.jsx("div",{className:"sticky top-0 bg-slate-900 py-2 z-10",children:e.jsx("h4",{className:"text-sm font-semibold text-slate-300",children:"Quiz Editor"})}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2",children:w.map((i,n)=>{const u=ee(i),p=a===n;return e.jsxs("button",{onClick:()=>I(p?null:n),className:`p-2 rounded-lg border text-left transition-all ${u.valid?"border-emerald-600/50 bg-emerald-900/20 hover:bg-emerald-900/30":"border-slate-600 bg-slate-800/50 hover:bg-slate-800"} ${p?"ring-2 ring-indigo-500":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("span",{className:"text-[10px] font-medium text-slate-400",children:["#",i.index]}),u.valid?e.jsx("svg",{className:"w-3 h-3 text-emerald-400",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}):e.jsx("svg",{className:"w-3 h-3 text-amber-400",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})]}),e.jsx("div",{className:"text-[9px] text-slate-300 truncate",children:i.title||"Untitled"})]},n)})}),a!==null&&w[a]&&e.jsxs("div",{className:"mt-4 p-4 rounded-xl border border-indigo-600/50 bg-indigo-900/20",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h5",{className:"text-sm font-semibold text-indigo-300",children:["Quiz #",a+1]}),e.jsx("button",{onClick:()=>I(null),className:"text-xs text-slate-400 hover:text-white",children:"Close"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"expanded-quiz-title",className:"block text-[10px] text-slate-500 mb-1",children:"TITLE"}),e.jsx("input",{id:"expanded-quiz-title",value:w[a].title,onChange:i=>ve(a,i.target.value),placeholder:"Enter quiz title...",className:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-600 text-sm text-slate-200"})]}),w[a].questions.map((i,n)=>e.jsxs("div",{className:"p-3 rounded-lg bg-slate-800/50 border border-slate-700",children:[e.jsxs("span",{className:"block text-[10px] text-slate-500 mb-1",children:["Q",n+1]}),e.jsx("input",{value:i.question_text,onChange:u=>je(a,n,u.target.value),placeholder:`Question ${n+1}...`,className:"w-full px-2 py-1.5 rounded border border-slate-600 bg-slate-900 text-xs text-slate-200 mb-2"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:i.options.map((u,p)=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded border border-slate-600 bg-slate-900/50",children:[_!=="opinion"&&e.jsx("input",{type:"radio",name:`q-${a}-${n}`,checked:u.is_correct,onChange:()=>ye(a,n,p),className:"w-3 h-3"}),e.jsx("input",{value:u.option_text,onChange:C=>ce(a,n,p,C.target.value),placeholder:`Option ${p+1}`,className:"flex-1 bg-transparent outline-none text-xs text-slate-200"})]},p))})]},n))]})]})]})]}),e.jsxs("div",{className:"p-4 border-t border-slate-700 flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-slate-400",children:_==="opinion"&&e.jsx("span",{className:"text-pink-400",children:"âš  Opinion: No correct answers needed"})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{l(se()),I(null)},className:"px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition",children:"Reset All"}),e.jsx("button",{onClick:()=>T(!1),className:"px-4 py-2 rounded-lg text-sm font-medium bg-slate-600 text-slate-200 hover:bg-slate-500 transition",children:"Cancel"}),e.jsx("button",{onClick:B,disabled:d||ie!==Z,className:"px-6 py-2 rounded-lg text-sm font-semibold bg-gradient-to-r from-emerald-600 to-emerald-500 text-white hover:from-emerald-500 hover:to-emerald-400 disabled:opacity-40 disabled:cursor-not-allowed transition-all",children:d?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Deploying..."]}):`ðŸš€ Deploy ${Z} Quizzes`})]})]})]})})]})]})}const Ee=[{value:"opinion",label:"Opinion"},{value:"gk",label:"General Knowledge"},{value:"sports",label:"Sports"},{value:"movies",label:"Movies"}],Qe=o=>{var h;return((h=Ee.find(z=>z.value===o))==null?void 0:h.label)||o},oe=()=>({text:"",options:["","",""],correctIndex:0});function pe(o,h,{fallback:z=0}={}){return h==null&&(h=z),o==="coins"?`${h} coins`:o==="others"?`${h}`:`â‚¹${h}`}function Ye(o,{allowZeroCorrect:h=!1}={}){var E,T;const z=String(o||"").trim().split(/\n\s*\n+/),D=[],L=[],P=[];let $=0;for(const _ of z){const U=_.split(/\r?\n/).map(d=>d.trim()).filter(Boolean);if(!U.length)continue;$+=1;const R=U[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),M=[];let Q="";for(let d=1;d<U.length;d++){const N=U[d];if(/^ans(wer)?\s*[:-]/i.test(N)){Q=N;continue}const w=N.match(/^[-*â€¢]?\s*\[(x|X| )\]\s*(.+)$/);if(w){M.push({option_text:w[2].trim(),is_correct:/x/i.test(w[1])});continue}const l=N.match(/^(?:[-*â€¢]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/),a=l?l[1].trim():N.replace(/^[*]\s*/,"").trim();a&&M.push({option_text:a,is_correct:/^\*/.test(N)})}if(Q){const d=Q.split(/[:-]/).slice(1).join(":").trim(),N=(T=(E=d.match(/^[A-D]/i))==null?void 0:E[0])==null?void 0:T.toUpperCase(),w=N?{A:0,B:1,C:2,D:3}[N]:NaN,l=parseInt(d,10);if(!Number.isNaN(w)&&M[w])M.forEach((a,I)=>a.is_correct=I===w);else if(!Number.isNaN(l)&&M[l-1])M.forEach((a,I)=>a.is_correct=I===l-1);else{const a=d.toLowerCase(),I=M.findIndex(G=>G.option_text.toLowerCase()===a||G.option_text.toLowerCase().includes(a));I>=0&&M.forEach((G,K)=>G.is_correct=K===I)}}let x=M.filter(d=>d.option_text);if(x.length>4){const d=x.findIndex(N=>N.is_correct);if(d>=0){const N=x[d],w=x.filter((l,a)=>a!==d);x=[N,...w.slice(0,3)]}else x=x.slice(0,4);P.push(`Q${$}: Trimmed to 4 options.`)}if(!R){L.push(`Q${$}: Missing question text.`);continue}if(x.length<2){L.push(`Q${$}: Need at least 2 options.`);continue}if(h)x=x.map(d=>({...d,is_correct:!1}));else{const d=x.filter(N=>N.is_correct).length;if(d===0)x[0].is_correct=!0;else if(d>1){let N=!1;x=x.map(w=>w.is_correct&&!N?(N=!0,w):{...w,is_correct:!1})}}D.push({question_text:R,options:x})}return{items:D,errors:L,warnings:P}}function at(){var A;const{toast:o}=ge(),{userProfile:h,loading:z,user:D}=De(),[L,P]=Oe(),$=L.get("tab")||"overview",E=t=>{L.set("tab",t),P(L,{replace:!0})},[T,_]=f.useState([]),[U,R]=f.useState(!1),[M,Q]=f.useState(!1),[x,d]=f.useState({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),[N,w]=f.useState("form"),[l,a]=f.useState([oe()]),[I,G]=f.useState(null),[K,Y]=f.useState([]),[le,se]=f.useState(null),[fe,be]=f.useState(!1),te=x.category==="opinion",ve=f.useMemo(()=>{try{const t=String({}.VITE_ADMIN_EMAILS||"").trim();return t?new Set(t.split(/[\s,]+/).map(s=>s.trim().toLowerCase()).filter(Boolean)):new Set}catch(t){return new Set}},[]),je=String((h==null?void 0:h.role)||"").trim().toLowerCase(),ce=String((D==null?void 0:D.email)||"").trim().toLowerCase(),ye=String(((A=D==null?void 0:D.app_metadata)==null?void 0:A.role)||"").trim().toLowerCase(),B=je==="admin"||ye==="admin"||ce&&ve.has(ce),ee=f.useCallback(async()=>{if(!B){R(!1),_([]);return}if(R(!0),!g){_([]),R(!1);return}const{data:t,error:s}=await g.from("quizzes").select("id,title,category,prizes,prize_pool,prize_type,start_time,end_time").order("start_time",{ascending:!1});s?o({title:"Fetch failed",description:s.message,variant:"destructive"}):_(t||[]),R(!1)},[o,B]),ie=f.useCallback(async t=>{if(!B){Y([]);return}if(!g){Y([]);return}const{data:s,error:c}=await g.from("questions").select("id,question_text,options(id,option_text,is_correct)").eq("quiz_id",t);c?o({title:"Questions failed",description:c.message,variant:"destructive"}):Y(s||[])},[o,B]);f.useEffect(()=>{z||ee()},[ee,z]);const de=async t=>{t.preventDefault();try{if(!B){o({title:"Access denied",description:"Only admins can create quizzes.",variant:"destructive"});return}const s=[];x.category||s.push("Select category"),x.title.trim()||s.push("Title required"),(!x.start_time||!x.end_time)&&s.push("Start & End time required");const c=new Date(x.start_time);new Date(x.end_time)<=c&&s.push("End after start");const r=parseInt(x.prizes[0]||"",10);if((Number.isNaN(r)||r<=0)&&s.push("1st prize invalid"),s.length){o({title:"Fix form",description:s[0],variant:"destructive"});return}const b=l.map(W=>{const re=(W.options||[]).map(we=>we.trim()).filter(Boolean).slice(0,4);if(!W.text.trim()||re.length<2)return null;const Re=Math.min(Math.max(W.correctIndex||0,0),re.length-1);return{question_text:W.text.trim(),options:re.map((we,qe)=>({option_text:we,is_correct:te?!1:qe===Re}))}}).filter(Boolean);if(!b.length){o({title:"Add questions",variant:"destructive"});return}const S=x.prizes.filter(W=>W).map(W=>parseInt(W,10)),V=S.reduce((W,re)=>W+re,0),me=x.prize_type==="money"&&V>0?"coins":x.prize_type,xe={title:x.title.trim(),category:x.category,start_time:new Date(x.start_time).toISOString(),end_time:new Date(x.end_time).toISOString(),prizes:S,prize_pool:V,prize_type:me};if(!g)throw new Error("Supabase config missing");const{data:Ce,error:Se}=await g.from("quizzes").insert([xe]).select().single();if(Se)throw Se;o({title:"Quiz created",description:Ce.title});const Ie=await i(Ce.id,b,"replace");Ie.ok?o({title:"Questions added",description:`${b.length} questions`}):o({title:"Question insert fallback",description:Ie.message||"Failed",variant:"destructive"}),Q(!1),d({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),a([oe()]),ee()}catch(s){o({title:"Create failed",description:s.message,variant:"destructive"})}},i=async(t,s,c="append")=>{var m;if(!B)return{ok:!1,message:"Admin access required"};if(!g)return{ok:!1,message:"No Supabase client"};try{const{data:r}=await g.auth.getSession(),b=(m=r==null?void 0:r.session)==null?void 0:m.access_token,S=await fetch("/functions/v1/admin-upsert-questions",{method:"POST",headers:{"Content-Type":"application/json",...b?{Authorization:`Bearer ${b}`}:{}},body:JSON.stringify({quizId:t,items:s,mode:c})});if(S.ok)return{ok:!0};if(S.status!==404){const V=await S.json().catch(()=>({}));throw new Error((V==null?void 0:V.error)||`HTTP ${S.status}`)}}catch(r){console.warn("Edge bulk insert failed, falling back to direct RPC path",r)}try{const{error:r}=await g.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:c});if(!r)return{ok:!0};console.warn("admin_bulk_upsert_questions RPC returned error, using manual inserts",r==null?void 0:r.message)}catch(r){console.warn("admin_bulk_upsert_questions RPC threw, using manual inserts",r)}c==="replace"&&await g.from("questions").delete().eq("quiz_id",t);for(const r of s){const{data:b,error:S}=await g.from("questions").insert({quiz_id:t,question_text:r.question_text}).select("id").single();if(S)return{ok:!1,message:S.message};const V=r.options.map(xe=>({question_id:b.id,option_text:xe.option_text,is_correct:!!xe.is_correct})),{error:me}=await g.from("options").insert(V);if(me)return{ok:!1,message:me.message}}return{ok:!0}},n=async t=>{if(!window.confirm("Delete this quiz?"))return;if(!B){o({title:"Access denied",description:"Only admins can delete quizzes.",variant:"destructive"});return}if(!g)return;const{error:s}=await g.from("quizzes").delete().eq("id",t);s?o({title:"Delete failed",description:s.message,variant:"destructive"}):(o({title:"Deleted"}),ee())},u=async t=>{if(!B){o({title:"Access denied",description:"Only admins can recompute results.",variant:"destructive"});return}if(g)try{se(t);const{error:s}=await g.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;try{await g.rpc("compute_results_if_due",{p_quiz_id:t})}catch(c){}o({title:"Recomputed"})}catch(s){o({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{se(null)}},p=f.useMemo(()=>{const t=Date.now(),s=[],c=[];for(const m of T){const r=m.end_time?new Date(m.end_time).getTime():null;r!==null&&t>r?c.push(m):s.push(m)}return c.sort((m,r)=>{const b=m.end_time?new Date(m.end_time).getTime():0;return(r.end_time?new Date(r.end_time).getTime():0)-b}),{active:s,finished:c.slice(0,10)}},[T]),[C,v]=f.useState([]),[k,j]=f.useState(!1),y=f.useCallback(async()=>{if(!B){v([]);return}if(!g){v([]);return}j(!0);try{const{data:t,error:s}=await g.from("redemptions").select("id,user_id,reward_value,reward_type,coins_required,payout_identifier,payout_channel,requested_at, profiles(username,full_name)").eq("status","pending").order("requested_at",{ascending:!1});if(s)throw s;v(t||[])}catch(t){v([])}finally{j(!1)}},[B]),F=f.useCallback(async t=>{if(B&&g){v(s=>s.filter(c=>c.id!==t));try{const{error:s}=await g.rpc("admin_approve_redemption",{p_redemption_id:t});if(s)throw s;o({title:"Approved",description:"Redemption approved."})}catch(s){o({title:"Approve failed",description:s.message,variant:"destructive"}),y()}}},[B,y,o]);return f.useEffect(()=>{y();const t=setInterval(y,3e4);return()=>clearInterval(t)},[y]),z?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(X,{className:"w-8 h-8 text-indigo-600 animate-spin"})}):B?e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl bg-white text-gray-900 rounded-2xl shadow-sm",children:[e.jsxs(Ae,{children:[e.jsx("meta",{name:"robots",content:"noindex, nofollow"}),e.jsx("link",{rel:"canonical",href:"https://quizdangal.com/admin/"})]}),e.jsx("h1",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Admin Dashboard"}),!Le&&e.jsx("div",{className:"mb-6 text-sm text-amber-600",children:"Supabase env keys missing. Read-only UI only."}),e.jsx("div",{className:"flex gap-2 mb-6 flex-wrap",children:["overview","rewards","approvals","notifications","scheduler"].map(t=>e.jsx("button",{onClick:()=>E(t),className:`px-3 py-1.5 rounded border text-sm transition-colors ${t===$?"bg-indigo-600 text-white border-indigo-600":"bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200"}`,children:t},t))}),$==="scheduler"&&e.jsx("div",{className:"mb-10",children:e.jsx(We,{})}),$==="overview"&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{children:e.jsxs(q,{onClick:()=>Q(!0),className:"bg-indigo-600 hover:bg-indigo-700 text-white",children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"New Quiz"]})}),e.jsx(Me,{children:M&&e.jsxs(ue.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:"bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg mb-4",children:"Create Quiz"}),e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"Category"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Ee.map(({value:t,label:s})=>e.jsx("button",{type:"button",onClick:()=>d(c=>({...c,category:t})),className:`px-3 py-1 rounded-full text-xs border ${x.category===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:s},t))})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(H,{children:"Title"}),e.jsx(J,{value:x.title,onChange:t=>d(s=>({...s,title:t.target.value})),placeholder:"Daily Quiz",required:!0})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Prize Type"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>d(s=>({...s,prize_type:t})),className:`px-2 py-1 rounded text-xs border ${x.prize_type===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-2",children:x.prizes.map((t,s)=>e.jsx(J,{value:t,placeholder:`${s+1}${["st","nd","rd"][s]||"th"} Prize`,onChange:c=>d(m=>{const r=[...m.prizes];return r[s]=c.target.value,{...m,prizes:r}})},s))}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(H,{children:"Start Time"}),e.jsx(J,{type:"datetime-local",value:x.start_time,onChange:t=>d(s=>({...s,start_time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(H,{children:"End Time"}),e.jsx(J,{type:"datetime-local",value:x.end_time,onChange:t=>d(s=>({...s,end_time:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Questions Mode"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["form","paste"].map(t=>e.jsx("button",{type:"button",onClick:()=>w(t),className:`px-3 py-1 rounded text-xs border ${N===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]}),N==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-600",children:te?"Opinion: no correct option stored.":"Mark one correct option with radio."}),l.map((t,s)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 space-y-2 bg-white",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-6",children:["Q",s+1]}),e.jsx(J,{value:t.text,onChange:c=>a(m=>{const r=[...m];return r[s]={...r[s],text:c.target.value},r}),placeholder:"Question text",className:"flex-1"}),e.jsx(q,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-500",onClick:()=>a(c=>c.length===1?[oe()]:c.filter((m,r)=>r!==s)),children:"Del"})]}),(t.options||[]).slice(0,4).map((c,m)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!te&&e.jsx("input",{type:"radio",name:`q-${s}`,checked:(t.correctIndex||0)===m,onChange:()=>a(r=>{const b=[...r];return b[s]={...b[s],correctIndex:m},b})}),e.jsx(J,{value:c,onChange:r=>a(b=>{const S=[...b],V=[...S[s].options];return V[m]=r.target.value,S[s]={...S[s],options:V},S}),placeholder:`Option ${m+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(q,{type:"button",size:"sm",variant:"outline",className:"border-red-300 text-red-500",onClick:()=>a(r=>{const b=[...r],S=[...b[s].options];return S.splice(m,1),b[s]={...b[s],options:S},b}),children:"X"})]},m)),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(q,{type:"button",size:"sm",disabled:(t.options||[]).length>=4,onClick:()=>a(c=>{const m=[...c],r=[...m[s].options];return r.length<4&&r.push(""),m[s]={...m[s],options:r},m}),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"Option"]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Max 4 options"})]})]},s)),e.jsxs(q,{type:"button",onClick:()=>a(t=>[...t,oe()]),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"Question"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{children:"Paste Questions"}),e.jsx(ze,{className:"h-40",value:x.bulk,onChange:t=>d(s=>({...s,bulk:t.target.value})),placeholder:`Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. ...`}),(()=>{const{items:t,errors:s,warnings:c}=Ye(x.bulk,{allowZeroCorrect:te});return e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[t.length," parsed"]}),c[0]&&e.jsx("div",{className:"text-amber-500",children:c[0]}),s[0]&&e.jsx("div",{className:"text-red-500",children:s[0]}),e.jsx(q,{type:"button",size:"sm",disabled:!!s.length||!t.length,onClick:()=>{if(s.length||!t.length)return;const m=t.map(r=>({text:r.question_text,options:r.options.map(b=>b.option_text),correctIndex:te?0:r.options.findIndex(b=>b.is_correct)>=0?r.options.findIndex(b=>b.is_correct):0}));a(m.length?m:[oe()]),w("form"),o({title:"Loaded",description:`${m.length} questions moved to form.`})},children:"Load into form"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(q,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create"}),e.jsx(q,{type:"button",variant:"outline",onClick:()=>Q(!1),children:"Cancel"})]})]})]})}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(Be,{className:"w-5 h-5"}),"All Quizzes"]}),U?e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(X,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4",children:p.active.map(t=>{const s=t.prize_type||"money",c=pe(s,t.prize_pool,{fallback:0}),m=Array.isArray(t.prizes)?t.prizes.map(r=>pe(s,r,{fallback:0})).join(", "):"";return e.jsxs(ue.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",Qe(t.category)||"â€”"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",c]}),e.jsxs("span",{children:["Prizes: ",m]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:["Start: ",t.start_time?he(t.start_time):"â€”"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?he(t.end_time):"â€”"]})]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(q,{size:"sm",variant:"outline",onClick:()=>u(t.id),disabled:le===t.id,children:le===t.id?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4 mr-1 animate-spin"}),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"w-4 h-4 mr-1"}),"Recompute"]})}),e.jsxs(Pe,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100 text-indigo-600",children:[e.jsx(Ue,{className:"w-4 h-4"}),"Results"]}),e.jsxs(q,{size:"sm",variant:"outline",onClick:()=>{G(t),ie(t.id),be(!0)},className:"text-blue-400",children:[e.jsx(Ve,{className:"w-4 h-4 mr-1"}),"Questions"]}),e.jsx(q,{size:"sm",variant:"outline",onClick:()=>n(t.id),className:"text-red-500",children:e.jsx(Ze,{className:"w-4 h-4"})})]})]}),e.jsx(Me,{children:fe&&(I==null?void 0:I.id)===t.id&&e.jsxs(ue.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 space-y-2",children:[e.jsxs("h5",{className:"font-medium flex items-center gap-2",children:["Questions for ",t.title]}),K.length===0&&e.jsx("div",{className:"text-xs text-gray-500",children:"No questions."}),K.map((r,b)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 bg-white",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Q",b+1,": ",r.question_text]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:(r.options||[]).map(S=>e.jsxs("div",{className:`px-2 py-0.5 text-xs rounded-full ${S.is_correct?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[S.option_text,S.is_correct&&e.jsx("span",{className:"ml-1",children:"âœ“"})]},S.id))})]},r.id))]})})]},t.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:p.finished.map(t=>{const s=t.prize_type||"money",c=pe(s,t.prize_pool,{fallback:0}),m=Array.isArray(t.prizes)?t.prizes.map(r=>pe(s,r,{fallback:0})).join(", "):"";return e.jsxs(ue.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",Qe(t.category)||"â€”"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",c]}),e.jsxs("span",{children:["Prizes: ",m]})]})]},t.id)})})]})]})]})]}),$==="approvals"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Pending Redemptions"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Approve user reward payouts after verifying their UPI ID / phone number."}),k&&e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(X,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading pending requests..."]}),!k&&C.length===0&&e.jsx("div",{className:"py-6 text-center text-gray-500 border border-gray-200 rounded-xl bg-gray-50",children:"No pending redemptions."}),C.length>0&&e.jsx("div",{className:"space-y-4",children:C.map(t=>{var s;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 bg-white shadow-sm flex flex-col md:flex-row md:items-center gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 to-yellow-500 flex items-center justify-center text-white font-semibold shadow",children:e.jsx("span",{className:"text-sm",children:"â‚¹"})}),(()=>{var b,S;const c=t.reward_value,m=c&&String(c).trim().length?c:`${t.reward_type||""}`.trim()||"Reward",r=((b=t.profiles)==null?void 0:b.username)||((S=t.profiles)==null?void 0:S.full_name)||"Anonymous";return e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 truncate",children:m}),e.jsxs("div",{className:"text-[11px] text-gray-600",children:["@",r]})]})})()]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600 flex flex-wrap gap-3",children:[e.jsxs("span",{children:["Type: ",t.reward_type||"â€”"]}),e.jsxs("span",{children:["Coins: ",(s=t.coins_required)!=null?s:0]}),e.jsxs("span",{children:["Requested: ",t.requested_at?he(t.requested_at):"â€”"]})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Payout:"," ",t.payout_identifier?`${t.payout_identifier} (${t.payout_channel||"upi"})`:"â€”"]})]}),e.jsx("div",{className:"flex items-center gap-2 self-start md:self-center",children:e.jsx(q,{size:"sm",onClick:()=>F(t.id),className:"bg-green-600 hover:bg-green-700 text-white",children:"Approve"})})]},t.id)})})]}),$==="notifications"&&e.jsx(Xe,{}),$==="rewards"&&e.jsx(Je,{})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Ae,{children:[e.jsx("meta",{name:"robots",content:"noindex, nofollow"}),e.jsx("link",{rel:"canonical",href:"https://quizdangal.com/admin/"})]}),e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-6 max-w-md w-full text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-500 mb-2",children:"Admin access required"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{children:"Supabase "}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" table mein aapke record ka "}),e.jsx("strong",{children:"role"}),e.jsx("span",{children:" field admin hona chahiye."})]}),e.jsxs("ul",{className:"text-left text-sm text-gray-600 mt-4 space-y-2 list-disc list-inside",children:[e.jsxs("li",{children:[e.jsx("span",{children:"Supabase dashboard"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"â†’"}),e.jsx("span",{children:"Table editor"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"â†’"}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:"Â me role update karein."})]}),e.jsx("li",{children:"Update ke baad login session refresh karein."}),e.jsxs("li",{children:["Dev bypass (",e.jsx("code",{children:"VITE_BYPASS_AUTH=1"}),") mein mock admin auto-enable hota hai."]})]})]})})]})}function Je(){const{toast:o}=ge(),[h,z]=O.useState([]),[D,L]=O.useState(!1),[P,$]=O.useState(!1),[E,T]=O.useState({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),[_,U]=O.useState(!1),[R,M]=O.useState(null),Q=O.useCallback(async()=>{if(!g)return;L(!0);const{data:l,error:a}=await g.from("reward_catalog").select("id,reward_type,reward_value,coins_required,is_active").order("id",{ascending:!1}).limit(200);a?o({title:"Rewards load failed",description:a.message,variant:"destructive"}):z(l||[]),L(!1)},[o]);O.useEffect(()=>{Q()},[Q]);const x=()=>T({reward_type:"cash",reward_value:"",coins_required:"",is_active:!0}),d=async l=>{if(l.preventDefault(),!!g){U(!0);try{const a={reward_type:String(E.reward_type||"").trim()||"cash",reward_value:String(E.reward_value||"").trim(),coins_required:E.coins_required!==""&&E.coins_required!==null?parseInt(E.coins_required,10):null,is_active:!!E.is_active};if(!a.reward_value)throw new Error("Value required");if(a.coins_required===null||Number.isNaN(a.coins_required))throw new Error("Coins required");let I;if(R?I=await g.from("reward_catalog").update(a).eq("id",R).select().single():I=await g.from("reward_catalog").insert([a]).select().single(),I.error)throw I.error;o({title:R?"Reward updated":"Reward created"}),x(),$(!1),M(null),Q()}catch(a){o({title:"Save failed",description:a.message,variant:"destructive"})}finally{U(!1)}}},N=async l=>{if(!g)return;const{error:a}=await g.from("reward_catalog").update({is_active:!l.is_active}).eq("id",l.id);a?o({title:"Toggle failed",description:a.message,variant:"destructive"}):(o({title:l.is_active?"Deactivated":"Activated"}),Q())},w=l=>{var a;M(l.id),$(!0),T({reward_type:l.reward_type||"cash",reward_value:l.reward_value||"",coins_required:((a=l.coins_required)!=null?a:"").toString(),is_active:!!l.is_active})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Redemptions auto-approved hain. Neeche sirf Rewards Catalog manage karna hai."}),e.jsxs("div",{className:"pt-10 border-t border-gray-200 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Rewards Catalog"}),e.jsx(q,{size:"sm",onClick:()=>{$(l=>!l),P||(x(),M(null))},children:P?"Close":"New Reward"}),e.jsx(q,{size:"sm",variant:"outline",onClick:Q,disabled:D,children:D?e.jsx(X,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),P&&e.jsxs("form",{onSubmit:d,className:"space-y-3 bg-gray-50 border border-gray-200 rounded-lg p-4 max-w-3xl",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(H,{children:"Type"}),e.jsx("div",{className:"flex gap-2 flex-wrap mt-1",children:["cash","voucher"].map(l=>e.jsx("button",{type:"button",onClick:()=>T(a=>({...a,reward_type:l})),className:`px-2 py-1 rounded text-xs border ${E.reward_type===l?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:l==="cash"?"ðŸ’µ Cash (UPI/Phone)":"ðŸŽŸï¸ Voucher (WhatsApp)"},l))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:E.reward_type==="cash"?"User will provide UPI ID or Phone number":"User will provide WhatsApp number"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Value"}),e.jsx(J,{value:E.reward_value,onChange:l=>T(a=>({...a,reward_value:l.target.value})),placeholder:"e.g. 100 / AMAZON100 / â‚¹100"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Coins Required"}),e.jsx(J,{type:"number",value:E.coins_required,onChange:l=>T(a=>({...a,coins_required:l.target.value})),placeholder:"coins needed"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_active",type:"checkbox",checked:!!E.is_active,onChange:l=>T(a=>({...a,is_active:l.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{type:"submit",disabled:_,children:_?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4 mr-1 animate-spin"}),"Saving"]}):R?"Update":"Create"}),e.jsx(q,{type:"button",variant:"outline",onClick:()=>{x(),M(null)},children:R?"Cancel Edit":"Reset"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Type"}),e.jsx("th",{className:"p-2 text-left",children:"Value"}),e.jsx("th",{className:"p-2 text-left",children:"Coins Required"}),e.jsx("th",{className:"p-2 text-left",children:"Active"}),e.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[h.map(l=>{var a;return e.jsxs("tr",{className:"border-t border-gray-200 hover:bg-gray-100",children:[e.jsx("td",{className:"p-2 capitalize",children:l.reward_type}),e.jsx("td",{className:"p-2 max-w-[260px] truncate",title:l.reward_value,children:l.reward_value}),e.jsx("td",{className:"p-2",children:(a=l.coins_required)!=null?a:"â€”"}),e.jsx("td",{className:"p-2",children:l.is_active?e.jsx("span",{className:"text-green-500",children:"Yes"}):e.jsx("span",{className:"text-gray-500",children:"No"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(q,{size:"sm",variant:"outline",onClick:()=>w(l),children:"Edit"}),e.jsx(q,{size:"sm",variant:"outline",onClick:()=>N(l),children:l.is_active?"Deactivate":"Activate"})]})})]},l.id)}),!h.length&&!D&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"p-4 text-center text-gray-500",children:"No rewards."})}),D&&e.jsx("tr",{children:e.jsxs("td",{colSpan:8,className:"p-6 text-center text-gray-500",children:[e.jsx(X,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading rewards..."]})})]})]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Catalog: inactive rewards are hidden from users."})]})]})}function Xe(){const{toast:o}=ge(),[h,z]=O.useState(""),[D,L]=O.useState(""),[P,$]=O.useState("all"),[E,T]=O.useState(!1),[_,U]=O.useState([]),[R,M]=O.useState(!1),Q=O.useCallback(async()=>{if(!g)return;M(!0);const{data:d,error:N}=await g.from("notifications").select("id,title,message,type,segment,created_at").order("created_at",{ascending:!1}).limit(100);N?o({title:"Fetch failed",description:N.message,variant:"destructive"}):U(d||[]),M(!1)},[o]);O.useEffect(()=>{Q()},[Q]);const x=async d=>{var N;if(d.preventDefault(),!h.trim()||!D.trim()){o({title:"Missing fields",variant:"destructive"});return}if(!g){o({title:"No backend client",variant:"destructive"});return}T(!0);try{const w={title:h.trim(),message:D.trim(),segment:P},{data:l}=await g.auth.getSession(),a=(N=l==null?void 0:l.session)==null?void 0:N.access_token,{data:I,error:G}=await g.functions.invoke("send-notifications",{body:w,headers:a?{Authorization:`Bearer ${a}`}:void 0});if(G)throw new Error(G.message||G.error||"Failed to send notification");const K=typeof I=="object"&&(I!=null&&I.message)?I.message:h.trim();o({title:"Sent",description:K}),z(""),L(""),Q()}catch(w){o({title:"Send failed",description:w.message,variant:"destructive"})}finally{T(!1)}};return e.jsxs("div",{className:"space-y-8 max-w-3xl",children:[e.jsxs("form",{onSubmit:x,className:"space-y-4 bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Send Notification"}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"notification-title",children:"Title"}),e.jsx(J,{id:"notification-title",name:"notificationTitle",value:h,onChange:d=>z(d.target.value),maxLength:80,placeholder:"Short title"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 80 chars â€¢ ",h.length,"/80"]})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"notification-message",children:"Message"}),e.jsx(ze,{id:"notification-message",name:"notificationMessage",value:D,onChange:d=>L(d.target.value),className:"h-28",maxLength:280,placeholder:"Body shown in push notification"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 280 chars â€¢ ",D.length,"/280"]})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Segment"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["all"].map(d=>e.jsx("button",{type:"button",onClick:()=>$(d),className:`px-3 py-1 rounded text-xs border ${P===d?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:d},d))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{type:"submit",disabled:E,children:E?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4 mr-1 animate-spin"}),"Sending"]}):"Send"}),e.jsx(q,{type:"button",variant:"outline",onClick:()=>{z(""),L("")},children:"Reset"})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Recent Notifications"}),e.jsx(q,{size:"sm",variant:"outline",onClick:Q,disabled:R,children:R?e.jsx(X,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),e.jsxs("div",{className:"space-y-3",children:[_.map(d=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:d.title}),e.jsx("div",{className:"text-xs text-gray-600 whitespace-pre-wrap max-w-xl break-words",children:d.message})]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:he(d.created_at)})]}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Segment: ",d.segment||"â€”",d.type?` â€¢ ${d.type}`:""]})]},d.id)),!_.length&&!R&&e.jsx("div",{className:"text-xs text-gray-500",children:"No notifications yet."})]})]})]})}export{at as default};
