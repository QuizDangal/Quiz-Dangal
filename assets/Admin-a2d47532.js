import{j as e,o as Ee,a as ge,u as Be,s as g,H as Oe,h as $e,B as M,A as De,m as me,q as he}from"./index-e5d81da9.js";import{a as R,r as f}from"./react-63c462fe.js";import{L as H,I as J}from"./label-5ed4f1f7.js";import{d as Re,L as Le}from"./router-d6d570a4.js";import{L as X,N as Ne,O as Pe,i as Fe,r as Ue,Q as Ve,V as Ze}from"./icons-1e9e0bae.js";import"./supabase-07ebd5d8.js";const ke=R.forwardRef(({className:o,...h},k)=>e.jsx("textarea",{ref:k,className:Ee("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",o),...h}));ke.displayName="Textarea";const ae=["opinion","gk","sports","movies"],Ge=[121,71,51],Qe=5,He=10,U=96,_e=10;function Ye(){const o=[];let h=8,k=0;for(;h<24;)o.push(String(h).padStart(2,"0")+":"+String(k).padStart(2,"0")),k+=He,k>=60&&(h++,k=k-60);return o}const ne={opinion:{bg:"bg-pink-600/20",border:"border-pink-500",text:"text-pink-400",badge:"bg-pink-600"},gk:{bg:"bg-emerald-600/20",border:"border-emerald-500",text:"text-emerald-400",badge:"bg-emerald-600"},sports:{bg:"bg-blue-600/20",border:"border-blue-500",text:"text-blue-400",badge:"bg-blue-600"},movies:{bg:"bg-amber-600/20",border:"border-amber-500",text:"text-amber-400",badge:"bg-amber-600"}},Ce=({category:o,className:h="w-4 h-4"})=>({opinion:e.jsx("svg",{className:h,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),gk:e.jsx("svg",{className:h,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})}),sports:e.jsx("svg",{className:h,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),movies:e.jsx("svg",{className:h,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"})})})[o]||null;function We(){var de;const{toast:o}=ge(),{userProfile:h}=Be(),k=String((h==null?void 0:h.role)||"").toLowerCase()==="admin",[I,$]=f.useState(!1),[L,B]=f.useState(null),[q,E]=f.useState(!1),[N,V]=f.useState("gk"),[T,D]=f.useState(()=>new Date().toISOString().slice(0,10)),[Q,u]=f.useState(""),[d,_]=f.useState(!1),[w,l]=f.useState([]),[a,A]=f.useState(null),G=f.useMemo(()=>new Date().toISOString().slice(0,10),[]),K=f.useMemo(()=>{const i=new Date;return i.setDate(i.getDate()+2),i.toISOString().slice(0,10)},[]),W=f.useCallback(async()=>{$(!0);try{const{data:i,error:n}=await g.rpc("get_scheduler_status");if(!n&&i){B(i);return}console.warn("get_scheduler_status RPC failed, using fallback:",n==null?void 0:n.message);const{data:m}=await g.from("category_runtime_overrides").select("category, is_auto").in("category",ae),{data:x}=await g.from("quiz_slots").select("category, status, target_date").gte("target_date",new Date().toISOString().slice(0,10)),z=new Date().toISOString().slice(0,10),v=ae.map(C=>{var F;const j=m==null?void 0:m.find(O=>O.category===C),y=(x==null?void 0:x.filter(O=>{var t;return O.category===C&&((t=O.target_date)==null?void 0:t.slice(0,10))===z}))||[];return{category:C,is_auto:(F=j==null?void 0:j.is_auto)!=null?F:!0,today:{total:y.length,active:y.filter(O=>O.status==="active").length,finished:y.filter(O=>O.status==="finished").length,scheduled:y.filter(O=>O.status==="scheduled").length,skipped:y.filter(O=>O.status==="skipped").length}}});B({ok:!0,today:z,current_time:new Date().toISOString(),categories:v})}catch(i){console.error("loadStatus error:",i),B({ok:!1,today:new Date().toISOString().slice(0,10),current_time:new Date().toISOString(),categories:ae.map(n=>({category:n,is_auto:!0,today:{total:0,active:0,finished:0,scheduled:0,skipped:0}}))})}finally{$(!1)}},[]);f.useEffect(()=>{W();const i=setInterval(W,3e4);return()=>clearInterval(i)},[W]);const le=async(i,n)=>{if(k)try{const{error:m}=await g.rpc("toggle_category_auto",{p_category:i,p_enabled:!n});if(m)throw m;o({title:n?"â¸ï¸ Paused":"â–¶ï¸ Resumed",description:`${i} quiz scheduling ${n?"paused":"enabled"}.`}),W()}catch(m){o({title:"Toggle failed",description:m==null?void 0:m.message,variant:"destructive"})}},se=f.useCallback(()=>Array.from({length:U}).map((i,n)=>({index:n+1,title:"",questions:Array.from({length:_e}).map(()=>({question_text:"",options:Array.from({length:4}).map(()=>({option_text:"",is_correct:!1}))}))})),[]),fe=(i="gk")=>{V(i),D(G),u(""),l(se()),A(null),E(!0)},be=f.useCallback(i=>{var v,C;const n=[],m=[],x=String(i||"").trim();if(!x)return{slots:n,errors:m};if(x.startsWith("[")||x.startsWith("{"))try{const j=JSON.parse(x),y=Array.isArray(j)?j:[j];for(const F of y){const O=F.title||"Untitled",s=(Array.isArray(F.questions)?F.questions:[]).slice(0,10).map(c=>({question_text:c.question_text||c.text||"",options:(c.options||[]).slice(0,4).map((p,r)=>({option_text:p.option_text||p.text||String(p).trim(),is_correct:N==="opinion"?!1:!!(p.is_correct||p.correct||c.correctIndex===r)}))}));n.push({title:O,questions:s})}return{slots:n,errors:m}}catch(j){return m.push("JSON parse failed: "+j.message),{slots:n,errors:m}}const z=x.split(/\n(?=Category:|Title:)/i);for(const j of z){const y=j.split(/\r?\n/).map(c=>c.trim()).filter(Boolean);if(!y.length)continue;let F="Untitled";const O=[];let t=null;for(const c of y){if(/^Category:/i.test(c))continue;if(/^Title:/i.test(c)){F=c.split(/:/).slice(1).join(":").trim();continue}if(/^Prizes?:/i.test(c))continue;const p=c.match(/^Q\d+\.\s*(.+)$/i);if(p){t&&O.push(t),t={question_text:p[1].trim(),options:[],correctIndex:-1};continue}const r=c.match(/^(?:[-*â€¢]|[A-D]\)|[A-D][.:])\s*(.+)$/);if(r&&t){t.options.push({option_text:r[1].trim(),is_correct:!1});continue}const b=c.match(/^Ans(wer)?[:\s]+(.+)$/i);if(b&&t){const Z=(C=(v=b[2].trim().match(/^[A-D]/i))==null?void 0:v[0])==null?void 0:C.toUpperCase();Z&&(t.correctIndex={A:0,B:1,C:2,D:3}[Z])}}t&&O.push(t);const s=O.slice(0,10).map(c=>({question_text:c.question_text,options:c.options.slice(0,4).map((p,r)=>({option_text:p.option_text,is_correct:N==="opinion"?!1:c.correctIndex===r}))}));s.length>0&&n.push({title:F,questions:s})}return{slots:n,errors:m}},[N]),te=()=>{const{slots:i,errors:n}=be(Q);if(n.length){o({title:"Parse errors",description:n[0],variant:"destructive"});return}if(i.length===0){o({title:"No quizzes found",description:"Could not parse any quizzes from the text.",variant:"destructive"});return}if(i.length!==U){o({title:"Quiz count mismatch",description:`Found ${i.length} quizzes, need exactly ${U}.`,variant:"destructive"});return}const m=i.map((x,z)=>{const v={index:z+1,title:x.title||`Quiz ${z+1}`,questions:x.questions.slice(0,_e).map(C=>({question_text:C.question_text||"",options:C.options.slice(0,4).map(j=>({option_text:j.option_text||"",is_correct:N==="opinion"?!1:!!j.is_correct}))}))};for(;v.questions.length<_e;)v.questions.push({question_text:"",options:Array.from({length:4}).map(()=>({option_text:"",is_correct:!1}))});for(const C of v.questions)for(;C.options.length<4;)C.options.push({option_text:"",is_correct:!1});return v});l(m),o({title:"âœ… Form populated",description:`${i.length} quizzes loaded into form.`})},ve=(i,n)=>{l(m=>m.map((x,z)=>z===i?{...x,title:n}:x))},je=(i,n,m)=>{l(x=>x.map((z,v)=>{if(v!==i)return z;const C=z.questions.map((j,y)=>y===n?{...j,question_text:m}:j);return{...z,questions:C}}))},ce=(i,n,m,x)=>{l(z=>z.map((v,C)=>{if(C!==i)return v;const j=v.questions.map((y,F)=>{if(F!==n)return y;const O=y.options.map((t,s)=>s===m?{...t,option_text:x}:t);return{...y,options:O}});return{...v,questions:j}}))},ye=(i,n,m)=>{N!=="opinion"&&l(x=>x.map((z,v)=>{if(v!==i)return z;const C=z.questions.map((j,y)=>{if(y!==n)return j;const F=j.options.map((O,t)=>({...O,is_correct:t===m}));return{...j,options:F}});return{...z,questions:C}}))},P=async()=>{if(k){_(!0);try{if(w.length!==U)throw new Error(`Need exactly ${U} quizzes, found ${w.length}`);for(const v of w){if(!v.title.trim())throw new Error(`Quiz #${v.index}: Title is empty`);for(let C=0;C<v.questions.length;C++){const j=v.questions[C];if(!j.question_text.trim())throw new Error(`Quiz #${v.index}, Q${C+1}: Question is empty`);for(let y=0;y<j.options.length;y++)if(!j.options[y].option_text.trim())throw new Error(`Quiz #${v.index}, Q${C+1}, Option ${y+1}: Option is empty`);if(N!=="opinion"&&!j.options.some(y=>y.is_correct))throw new Error(`Quiz #${v.index}, Q${C+1}: No correct answer selected`)}}const i=Ye(),n=w.map((v,C)=>({time:i[C],title:v.title.trim(),prizes:Ge,questions:v.questions.map(j=>({question_text:j.question_text.trim(),options:j.options.map(y=>({option_text:y.option_text.trim(),is_correct:N==="opinion"?!1:y.is_correct}))}))})),m={target_date:T,categories:{[N]:n}},{data:x,error:z}=await g.rpc("admin_seed_quiz_day_multi",{p_payload:m});if(z)throw z;o({title:"ðŸŽ‰ Deployed!",description:`${U} quizzes deployed for ${N} on ${T}.`}),E(!1),W()}catch(i){o({title:"Deploy failed",description:i==null?void 0:i.message,variant:"destructive"})}finally{_(!1)}}},ee=f.useCallback(i=>{if(!i.title.trim())return{valid:!1,error:"No title"};for(let n=0;n<i.questions.length;n++){const m=i.questions[n];if(!m.question_text.trim())return{valid:!1,error:`Q${n+1} empty`};for(let x=0;x<m.options.length;x++)if(!m.options[x].option_text.trim())return{valid:!1,error:`Q${n+1} opt ${x+1} empty`};if(N!=="opinion"&&!m.options.some(x=>x.is_correct))return{valid:!1,error:`Q${n+1} no answer`}}return{valid:!0}},[N]),ie=f.useMemo(()=>w.filter(i=>ee(i).valid).length,[w,ee]);return e.jsxs("div",{className:"relative min-h-[600px] rounded-2xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900"}),e.jsx("div",{className:"absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiM2MzY2ZjEiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTM2IDM0djItSDI0di0yaDEyek0zNiAyNHYySDI0di0yaDEyeiIvPjwvZz48L2c+PC9zdmc+')] opacity-50"}),e.jsx("div",{className:"absolute top-0 right-0 w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-80 h-80 bg-purple-600/10 rounded-full blur-3xl"}),e.jsxs("div",{className:"relative z-10 p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx("svg",{className:"w-6 h-6 text-indigo-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),"Quiz Scheduler"]}),e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:[U," quizzes/day Ã— 4 categories â€¢ 08:00 - 23:50 IST â€¢ ",Qe," min quiz + ",Qe," min gap"]})]}),I&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-400",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"}),"Loading..."]})]}),L&&e.jsxs("div",{className:"bg-slate-800/50 rounded-xl border border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-slate-300",children:"Today's Status"}),e.jsxs("span",{className:"text-[10px] text-slate-500",children:[L.today," â€¢ ",new Date(L.current_time).toLocaleTimeString("en-IN",{timeZone:"Asia/Kolkata"})," IST"]})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-3",children:(de=L.categories)==null?void 0:de.map(i=>{const n=ne[i.category]||ne.gk,m=i.today.total>0?(i.today.finished/i.today.total*100).toFixed(0):0;return e.jsxs("div",{className:`rounded-lg border ${n.border} ${n.bg} p-3`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ce,{category:i.category,className:`w-4 h-4 ${n.text}`}),e.jsx("span",{className:`text-xs font-semibold uppercase ${n.text}`,children:i.category})]}),e.jsx("button",{onClick:()=>le(i.category,i.is_auto),disabled:!k,className:`px-2 py-0.5 rounded text-[10px] font-medium transition-all ${i.is_auto?"bg-emerald-600 text-white hover:bg-emerald-700":"bg-rose-600/80 text-white hover:bg-rose-600"} disabled:opacity-50`,children:i.is_auto?"â–¶ ON":"â¸ OFF"})]}),i.today.total>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-1.5 bg-slate-700 rounded-full overflow-hidden mb-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-emerald-500 to-emerald-400 transition-all duration-500",style:{width:`${m}%`}})}),e.jsxs("div",{className:"flex justify-between text-[10px] text-slate-400",children:[e.jsxs("span",{children:["âœ“ ",i.today.finished,"/",i.today.total]}),e.jsx("span",{className:"text-emerald-400",children:i.today.active>0?`â— Live: ${i.today.active}`:""})]})]}):e.jsx("div",{className:"text-[10px] text-slate-500 mt-1",children:"No quizzes deployed"})]},i.category)})})]}),k&&e.jsxs("div",{className:"bg-gradient-to-br from-indigo-900/30 to-purple-900/20 rounded-xl border border-indigo-600/30 p-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-indigo-300 mb-3 flex items-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})}),"Bulk Deploy Quizzes"]}),e.jsxs("p",{className:"text-[11px] text-slate-400 mb-4",children:["Deploy ",U," quizzes for any category. You can deploy up to 3 days in advance."]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ae.map(i=>{const n=ne[i];return e.jsxs("button",{onClick:()=>fe(i),className:`flex items-center gap-2 px-4 py-2 rounded-lg border ${n.border} ${n.bg} hover:opacity-90 transition-all`,children:[e.jsx(Ce,{category:i,className:`w-4 h-4 ${n.text}`}),e.jsx("span",{className:`text-sm font-medium ${n.text} capitalize`,children:i})]},i)})})]}),q&&e.jsx("div",{className:"fixed inset-0 z-[200] flex items-start justify-center bg-black/70 backdrop-blur-sm overflow-y-auto p-4",children:e.jsxs("div",{className:"w-full max-w-4xl my-8 bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl",children:[e.jsx("div",{className:`p-4 rounded-t-2xl border-b border-slate-700 ${ne[N].bg}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ce,{category:N,className:`w-6 h-6 ${ne[N].text}`}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-bold text-white",children:["Bulk Deploy - ",N.toUpperCase()]}),e.jsxs("p",{className:"text-xs text-slate-400",children:[U," quizzes Ã— 10 questions Ã— 4 options"]})]})]}),e.jsx("button",{onClick:()=>E(!1),className:"p-2 rounded-lg hover:bg-slate-700/50 text-slate-400 hover:text-white transition",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bulk-category-select",className:"block text-[10px] text-slate-500 mb-1",children:"CATEGORY"}),e.jsx("select",{id:"bulk-category-select",value:N,onChange:i=>V(i.target.value),className:"bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200",children:ae.map(i=>e.jsx("option",{value:i,children:i.toUpperCase()},i))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bulk-date-input",className:"block text-[10px] text-slate-500 mb-1",children:"DATE (Max 3 days)"}),e.jsx("input",{id:"bulk-date-input",type:"date",value:T,min:G,max:K,onChange:i=>D(i.target.value),className:"bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200"})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-[10px] text-slate-500",children:"VALID QUIZZES"}),e.jsxs("div",{className:`text-2xl font-bold ${ie===U?"text-emerald-400":"text-amber-400"}`,children:[ie,"/",U]})]})]}),e.jsxs("div",{className:"bg-slate-800/50 rounded-xl border border-slate-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-slate-300",children:"Paste Quiz Data"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{const i=N==="opinion"?`Quiz 1
Title: Quiz Title Here
Q1. Question text here?
A) Option A
B) Option B
C) Option C
D) Option D

Q2. Second question?
A) Option A
B) Option B
C) Option C
D) Option D

Q3. Third question?
A) Option A
B) Option B
C) Option C
D) Option D

Q4. Fourth question?
A) Option A
B) Option B
C) Option C
D) Option D

Q5. Fifth question?
A) Option A
B) Option B
C) Option C
D) Option D

Q6. Sixth question?
A) Option A
B) Option B
C) Option C
D) Option D

Q7. Seventh question?
A) Option A
B) Option B
C) Option C
D) Option D

Q8. Eighth question?
A) Option A
B) Option B
C) Option C
D) Option D

Q9. Ninth question?
A) Option A
B) Option B
C) Option C
D) Option D

Q10. Tenth question?
A) Option A
B) Option B
C) Option C
D) Option D

Quiz 2
Title: Next Quiz Title
...`:`Quiz 1
Title: Quiz Title Here
Q1. Question text here?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: A

Q2. Second question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: B

Q3. Third question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: C

Q4. Fourth question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: D

Q5. Fifth question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: A

Q6. Sixth question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: B

Q7. Seventh question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: C

Q8. Eighth question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: D

Q9. Ninth question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: A

Q10. Tenth question?
A) Option A
B) Option B
C) Option C
D) Option D
Answer: B

Quiz 2
Title: Next Quiz Title
...`;navigator.clipboard.writeText(i),o({title:"ðŸ“‹ Format Copied!",description:"Paste in Notepad, fill data, then paste here."})},className:"px-3 py-1.5 rounded-lg text-xs font-medium bg-emerald-600 text-white hover:bg-emerald-700 transition",children:"ðŸ“‹ Copy Format"}),e.jsx("button",{onClick:te,disabled:!Q.trim(),className:"px-3 py-1.5 rounded-lg text-xs font-medium bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-40 transition",children:"Fill Form â†’"}),e.jsx("button",{onClick:()=>u(""),className:"px-3 py-1.5 rounded-lg text-xs font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition",children:"Clear"})]})]}),e.jsx("textarea",{value:Q,onChange:i=>u(i.target.value),className:"w-full h-28 rounded-lg border border-slate-600 bg-slate-900 text-slate-200 text-xs p-3 font-mono resize-none",placeholder:N==="opinion"?`Paste ${U} quiz blocks (No Answer needed for Opinion):

Quiz 1
Title: Aaj Ka Sawaal
Q1. Aapko kaunsa color pasand hai?
A) Red  B) Blue  C) Green  D) Yellow
...10 questions...

Quiz 2
Title: Evening Poll
...`:`Paste ${U} quiz blocks:

Quiz 1
Title: GK Morning Quiz
Q1. Bharat ki rajdhani?
A) Mumbai  B) Delhi  C) Kolkata  D) Chennai
Answer: B
...10 questions with answers...

Quiz 2
Title: Sports Quiz
...`})]}),e.jsxs("div",{className:"space-y-2 max-h-[50vh] overflow-y-auto pr-2",children:[e.jsx("div",{className:"sticky top-0 bg-slate-900 py-2 z-10",children:e.jsx("h4",{className:"text-sm font-semibold text-slate-300",children:"Quiz Editor"})}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2",children:w.map((i,n)=>{const m=ee(i),x=a===n;return e.jsxs("button",{onClick:()=>A(x?null:n),className:`p-2 rounded-lg border text-left transition-all ${m.valid?"border-emerald-600/50 bg-emerald-900/20 hover:bg-emerald-900/30":"border-slate-600 bg-slate-800/50 hover:bg-slate-800"} ${x?"ring-2 ring-indigo-500":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("span",{className:"text-[10px] font-medium text-slate-400",children:["#",i.index]}),m.valid?e.jsx("svg",{className:"w-3 h-3 text-emerald-400",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}):e.jsx("svg",{className:"w-3 h-3 text-amber-400",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})})]}),e.jsx("div",{className:"text-[9px] text-slate-300 truncate",children:i.title||"Untitled"})]},n)})}),a!==null&&w[a]&&e.jsxs("div",{className:"mt-4 p-4 rounded-xl border border-indigo-600/50 bg-indigo-900/20",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h5",{className:"text-sm font-semibold text-indigo-300",children:["Quiz #",a+1]}),e.jsx("button",{onClick:()=>A(null),className:"text-xs text-slate-400 hover:text-white",children:"Close"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"expanded-quiz-title",className:"block text-[10px] text-slate-500 mb-1",children:"TITLE"}),e.jsx("input",{id:"expanded-quiz-title",value:w[a].title,onChange:i=>ve(a,i.target.value),placeholder:"Enter quiz title...",className:"w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-600 text-sm text-slate-200"})]}),w[a].questions.map((i,n)=>e.jsxs("div",{className:"p-3 rounded-lg bg-slate-800/50 border border-slate-700",children:[e.jsxs("span",{className:"block text-[10px] text-slate-500 mb-1",children:["Q",n+1]}),e.jsx("input",{value:i.question_text,onChange:m=>je(a,n,m.target.value),placeholder:`Question ${n+1}...`,className:"w-full px-2 py-1.5 rounded border border-slate-600 bg-slate-900 text-xs text-slate-200 mb-2"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:i.options.map((m,x)=>e.jsxs("label",{className:"flex items-center gap-2 p-2 rounded border border-slate-600 bg-slate-900/50",children:[N!=="opinion"&&e.jsx("input",{type:"radio",name:`q-${a}-${n}`,checked:m.is_correct,onChange:()=>ye(a,n,x),className:"w-3 h-3"}),e.jsx("input",{value:m.option_text,onChange:z=>ce(a,n,x,z.target.value),placeholder:`Option ${x+1}`,className:"flex-1 bg-transparent outline-none text-xs text-slate-200"})]},x))})]},n))]})]})]})]}),e.jsxs("div",{className:"p-4 border-t border-slate-700 flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-slate-400",children:N==="opinion"&&e.jsx("span",{className:"text-pink-400",children:"âš  Opinion: No correct answers needed"})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{l(se()),A(null)},className:"px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-slate-300 hover:bg-slate-600 transition",children:"Reset All"}),e.jsx("button",{onClick:()=>E(!1),className:"px-4 py-2 rounded-lg text-sm font-medium bg-slate-600 text-slate-200 hover:bg-slate-500 transition",children:"Cancel"}),e.jsx("button",{onClick:P,disabled:d||ie!==U,className:"px-6 py-2 rounded-lg text-sm font-semibold bg-gradient-to-r from-emerald-600 to-emerald-500 text-white hover:from-emerald-500 hover:to-emerald-400 disabled:opacity-40 disabled:cursor-not-allowed transition-all",children:d?e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Deploying..."]}):`ðŸš€ Deploy ${U} Quizzes`})]})]})]})})]})]})}const qe=[{value:"opinion",label:"Opinion"},{value:"gk",label:"General Knowledge"},{value:"sports",label:"Sports"},{value:"movies",label:"Movies"}],Ie=o=>{var h;return((h=qe.find(k=>k.value===o))==null?void 0:h.label)||o},oe=()=>({text:"",options:["","",""],correctIndex:0});function xe(o,h,{fallback:k=0}={}){return h==null&&(h=k),o==="coins"?`${h} coins`:o==="others"?`${h}`:`â‚¹${h}`}function Je(o,{allowZeroCorrect:h=!1}={}){var q,E;const k=String(o||"").trim().split(/\n\s*\n+/),I=[],$=[],L=[];let B=0;for(const N of k){const V=N.split(/\r?\n/).map(d=>d.trim()).filter(Boolean);if(!V.length)continue;B+=1;const T=V[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),D=[];let Q="";for(let d=1;d<V.length;d++){const _=V[d];if(/^ans(wer)?\s*[:-]/i.test(_)){Q=_;continue}const w=_.match(/^[-*â€¢]?\s*\[(x|X| )\]\s*(.+)$/);if(w){D.push({option_text:w[2].trim(),is_correct:/x/i.test(w[1])});continue}const l=_.match(/^(?:[-*â€¢]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/),a=l?l[1].trim():_.replace(/^[*]\s*/,"").trim();a&&D.push({option_text:a,is_correct:/^\*/.test(_)})}if(Q){const d=Q.split(/[:-]/).slice(1).join(":").trim(),_=(E=(q=d.match(/^[A-D]/i))==null?void 0:q[0])==null?void 0:E.toUpperCase(),w=_?{A:0,B:1,C:2,D:3}[_]:NaN,l=parseInt(d,10);if(!Number.isNaN(w)&&D[w])D.forEach((a,A)=>a.is_correct=A===w);else if(!Number.isNaN(l)&&D[l-1])D.forEach((a,A)=>a.is_correct=A===l-1);else{const a=d.toLowerCase(),A=D.findIndex(G=>G.option_text.toLowerCase()===a||G.option_text.toLowerCase().includes(a));A>=0&&D.forEach((G,K)=>G.is_correct=K===A)}}let u=D.filter(d=>d.option_text);if(u.length>4){const d=u.findIndex(_=>_.is_correct);if(d>=0){const _=u[d],w=u.filter((l,a)=>a!==d);u=[_,...w.slice(0,3)]}else u=u.slice(0,4);L.push(`Q${B}: Trimmed to 4 options.`)}if(!T){$.push(`Q${B}: Missing question text.`);continue}if(u.length<2){$.push(`Q${B}: Need at least 2 options.`);continue}if(h)u=u.map(d=>({...d,is_correct:!1}));else{const d=u.filter(_=>_.is_correct).length;if(d===0)u[0].is_correct=!0;else if(d>1){let _=!1;u=u.map(w=>w.is_correct&&!_?(_=!0,w):{...w,is_correct:!1})}}I.push({question_text:T,options:u})}return{items:I,errors:$,warnings:L}}function nt(){var O;const{toast:o}=ge(),{userProfile:h,loading:k,user:I}=Be(),[$,L]=Re(),B=$.get("tab")||"overview",q=t=>{$.set("tab",t),L($,{replace:!0})},[E,N]=f.useState([]),[V,T]=f.useState(!1),[D,Q]=f.useState(!1),[u,d]=f.useState({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),[_,w]=f.useState("form"),[l,a]=f.useState([oe()]),[A,G]=f.useState(null),[K,W]=f.useState([]),[le,se]=f.useState(null),[fe,be]=f.useState(!1),te=u.category==="opinion",ve=f.useMemo(()=>{try{const t=String({}.VITE_ADMIN_EMAILS||"").trim();return t?new Set(t.split(/[\s,]+/).map(s=>s.trim().toLowerCase()).filter(Boolean)):new Set}catch(t){return new Set}},[]),je=String((h==null?void 0:h.role)||"").trim().toLowerCase(),ce=String((I==null?void 0:I.email)||"").trim().toLowerCase(),ye=String(((O=I==null?void 0:I.app_metadata)==null?void 0:O.role)||"").trim().toLowerCase(),P=je==="admin"||ye==="admin"||ce&&ve.has(ce),ee=f.useCallback(async()=>{if(!P){T(!1),N([]);return}if(T(!0),!g){N([]),T(!1);return}const{data:t,error:s}=await g.from("quizzes").select("id,title,category,prizes,prize_pool,prize_type,start_time,end_time").order("start_time",{ascending:!1});s?o({title:"Fetch failed",description:s.message,variant:"destructive"}):N(t||[]),T(!1)},[o,P]),ie=f.useCallback(async t=>{if(!P){W([]);return}if(!g){W([]);return}const{data:s,error:c}=await g.from("questions").select("id,question_text,options(id,option_text,is_correct)").eq("quiz_id",t);c?o({title:"Questions failed",description:c.message,variant:"destructive"}):W(s||[])},[o,P]);f.useEffect(()=>{k||ee()},[ee,k]);const de=async t=>{t.preventDefault();try{if(!P){o({title:"Access denied",description:"Only admins can create quizzes.",variant:"destructive"});return}const s=[];u.category||s.push("Select category"),u.title.trim()||s.push("Title required"),(!u.start_time||!u.end_time)&&s.push("Start & End time required");const c=new Date(u.start_time);new Date(u.end_time)<=c&&s.push("End after start");const r=parseInt(u.prizes[0]||"",10);if((Number.isNaN(r)||r<=0)&&s.push("1st prize invalid"),s.length){o({title:"Fix form",description:s[0],variant:"destructive"});return}const b=l.map(Y=>{const re=(Y.options||[]).map(we=>we.trim()).filter(Boolean).slice(0,4);if(!Y.text.trim()||re.length<2)return null;const Te=Math.min(Math.max(Y.correctIndex||0,0),re.length-1);return{question_text:Y.text.trim(),options:re.map((we,Me)=>({option_text:we,is_correct:te?!1:Me===Te}))}}).filter(Boolean);if(!b.length){o({title:"Add questions",variant:"destructive"});return}const S=u.prizes.filter(Y=>Y).map(Y=>parseInt(Y,10)),Z=S.reduce((Y,re)=>Y+re,0),pe=u.prize_type==="money"&&Z>0?"coins":u.prize_type,ue={title:u.title.trim(),category:u.category,start_time:new Date(u.start_time).toISOString(),end_time:new Date(u.end_time).toISOString(),prizes:S,prize_pool:Z,prize_type:pe};if(!g)throw new Error("Supabase config missing");const{data:ze,error:Se}=await g.from("quizzes").insert([ue]).select().single();if(Se)throw Se;o({title:"Quiz created",description:ze.title});const Ae=await i(ze.id,b,"replace");Ae.ok?o({title:"Questions added",description:`${b.length} questions`}):o({title:"Question insert fallback",description:Ae.message||"Failed",variant:"destructive"}),Q(!1),d({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),a([oe()]),ee()}catch(s){o({title:"Create failed",description:s.message,variant:"destructive"})}},i=async(t,s,c="append")=>{var p;if(!P)return{ok:!1,message:"Admin access required"};if(!g)return{ok:!1,message:"No Supabase client"};try{const{data:r}=await g.auth.getSession(),b=(p=r==null?void 0:r.session)==null?void 0:p.access_token,S=await fetch("/functions/v1/admin-upsert-questions",{method:"POST",headers:{"Content-Type":"application/json",...b?{Authorization:`Bearer ${b}`}:{}},body:JSON.stringify({quizId:t,items:s,mode:c})});if(S.ok)return{ok:!0};if(S.status!==404){const Z=await S.json().catch(()=>({}));throw new Error((Z==null?void 0:Z.error)||`HTTP ${S.status}`)}}catch(r){console.warn("Edge bulk insert failed, falling back to direct RPC path",r)}try{const{error:r}=await g.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:c});if(!r)return{ok:!0};console.warn("admin_bulk_upsert_questions RPC returned error, using manual inserts",r==null?void 0:r.message)}catch(r){console.warn("admin_bulk_upsert_questions RPC threw, using manual inserts",r)}c==="replace"&&await g.from("questions").delete().eq("quiz_id",t);for(const r of s){const{data:b,error:S}=await g.from("questions").insert({quiz_id:t,question_text:r.question_text}).select("id").single();if(S)return{ok:!1,message:S.message};const Z=r.options.map(ue=>({question_id:b.id,option_text:ue.option_text,is_correct:!!ue.is_correct})),{error:pe}=await g.from("options").insert(Z);if(pe)return{ok:!1,message:pe.message}}return{ok:!0}},n=async t=>{if(!window.confirm("Delete this quiz?"))return;if(!P){o({title:"Access denied",description:"Only admins can delete quizzes.",variant:"destructive"});return}if(!g)return;const{error:s}=await g.from("quizzes").delete().eq("id",t);s?o({title:"Delete failed",description:s.message,variant:"destructive"}):(o({title:"Deleted"}),ee())},m=async t=>{if(!P){o({title:"Access denied",description:"Only admins can recompute results.",variant:"destructive"});return}if(g)try{se(t);const{error:s}=await g.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;try{await g.rpc("compute_results_if_due",{p_quiz_id:t})}catch(c){}o({title:"Recomputed"})}catch(s){o({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{se(null)}},x=f.useMemo(()=>{const t=Date.now(),s=[],c=[];for(const p of E){const r=p.end_time?new Date(p.end_time).getTime():null;r!==null&&t>r?c.push(p):s.push(p)}return c.sort((p,r)=>{const b=p.end_time?new Date(p.end_time).getTime():0;return(r.end_time?new Date(r.end_time).getTime():0)-b}),{active:s,finished:c.slice(0,10)}},[E]),[z,v]=f.useState([]),[C,j]=f.useState(!1),y=f.useCallback(async()=>{if(!P){v([]);return}if(!g){v([]);return}j(!0);try{const{data:t,error:s}=await g.from("redemptions").select("id,user_id,reward_value,reward_type,coins_required,payout_identifier,payout_channel,requested_at, profiles(username,full_name)").eq("status","pending").order("requested_at",{ascending:!1});if(s)throw s;v(t||[])}catch(t){v([])}finally{j(!1)}},[P]),F=f.useCallback(async t=>{if(P&&g){v(s=>s.filter(c=>c.id!==t));try{const{error:s}=await g.rpc("admin_approve_redemption",{p_redemption_id:t});if(s)throw s;o({title:"Approved",description:"Redemption approved."})}catch(s){o({title:"Approve failed",description:s.message,variant:"destructive"}),y()}}},[P,y,o]);return f.useEffect(()=>{y();const t=setInterval(y,3e4);return()=>clearInterval(t)},[y]),k?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(X,{className:"w-8 h-8 text-indigo-600 animate-spin"})}):P?e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl bg-white text-gray-900 rounded-2xl shadow-sm",children:[e.jsxs(Oe,{children:[e.jsx("meta",{name:"robots",content:"noindex, nofollow"}),e.jsx("link",{rel:"canonical",href:"https://quizdangal.com/admin/"})]}),e.jsx("h1",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Admin Dashboard"}),!$e&&e.jsx("div",{className:"mb-6 text-sm text-amber-600",children:"Supabase env keys missing. Read-only UI only."}),e.jsx("div",{className:"flex gap-2 mb-6 flex-wrap",children:["overview","rewards","approvals","notifications","scheduler"].map(t=>e.jsx("button",{onClick:()=>q(t),className:`px-3 py-1.5 rounded border text-sm transition-colors ${t===B?"bg-indigo-600 text-white border-indigo-600":"bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200"}`,children:t},t))}),B==="scheduler"&&e.jsx("div",{className:"mb-10",children:e.jsx(We,{})}),B==="overview"&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{children:e.jsxs(M,{onClick:()=>Q(!0),className:"bg-indigo-600 hover:bg-indigo-700 text-white",children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"New Quiz"]})}),e.jsx(De,{children:D&&e.jsxs(me.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:"bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg mb-4",children:"Create Quiz"}),e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(H,{className:"mb-1 block",children:"Category"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:qe.map(({value:t,label:s})=>e.jsx("button",{type:"button",onClick:()=>d(c=>({...c,category:t})),className:`px-3 py-1 rounded-full text-xs border ${u.category===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:s},t))})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(H,{children:"Title"}),e.jsx(J,{value:u.title,onChange:t=>d(s=>({...s,title:t.target.value})),placeholder:"Daily Quiz",required:!0})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Prize Type"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>d(s=>({...s,prize_type:t})),className:`px-2 py-1 rounded text-xs border ${u.prize_type===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-2",children:u.prizes.map((t,s)=>e.jsx(J,{value:t,placeholder:`${s+1}${["st","nd","rd"][s]||"th"} Prize`,onChange:c=>d(p=>{const r=[...p.prizes];return r[s]=c.target.value,{...p,prizes:r}})},s))}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(H,{children:"Start Time"}),e.jsx(J,{type:"datetime-local",value:u.start_time,onChange:t=>d(s=>({...s,start_time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(H,{children:"End Time"}),e.jsx(J,{type:"datetime-local",value:u.end_time,onChange:t=>d(s=>({...s,end_time:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Questions Mode"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["form","paste"].map(t=>e.jsx("button",{type:"button",onClick:()=>w(t),className:`px-3 py-1 rounded text-xs border ${_===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]}),_==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-600",children:te?"Opinion: no correct option stored.":"Mark one correct option with radio."}),l.map((t,s)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 space-y-2 bg-white",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-6",children:["Q",s+1]}),e.jsx(J,{value:t.text,onChange:c=>a(p=>{const r=[...p];return r[s]={...r[s],text:c.target.value},r}),placeholder:"Question text",className:"flex-1"}),e.jsx(M,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-500",onClick:()=>a(c=>c.length===1?[oe()]:c.filter((p,r)=>r!==s)),children:"Del"})]}),(t.options||[]).slice(0,4).map((c,p)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!te&&e.jsx("input",{type:"radio",name:`q-${s}`,checked:(t.correctIndex||0)===p,onChange:()=>a(r=>{const b=[...r];return b[s]={...b[s],correctIndex:p},b})}),e.jsx(J,{value:c,onChange:r=>a(b=>{const S=[...b],Z=[...S[s].options];return Z[p]=r.target.value,S[s]={...S[s],options:Z},S}),placeholder:`Option ${p+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(M,{type:"button",size:"sm",variant:"outline",className:"border-red-300 text-red-500",onClick:()=>a(r=>{const b=[...r],S=[...b[s].options];return S.splice(p,1),b[s]={...b[s],options:S},b}),children:"X"})]},p)),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(M,{type:"button",size:"sm",disabled:(t.options||[]).length>=4,onClick:()=>a(c=>{const p=[...c],r=[...p[s].options];return r.length<4&&r.push(""),p[s]={...p[s],options:r},p}),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"Option"]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Max 4 options"})]})]},s)),e.jsxs(M,{type:"button",onClick:()=>a(t=>[...t,oe()]),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"Question"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(H,{children:"Paste Questions"}),e.jsx(ke,{className:"h-40",value:u.bulk,onChange:t=>d(s=>({...s,bulk:t.target.value})),placeholder:`Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. ...`}),(()=>{const{items:t,errors:s,warnings:c}=Je(u.bulk,{allowZeroCorrect:te});return e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[t.length," parsed"]}),c[0]&&e.jsx("div",{className:"text-amber-500",children:c[0]}),s[0]&&e.jsx("div",{className:"text-red-500",children:s[0]}),e.jsx(M,{type:"button",size:"sm",disabled:!!s.length||!t.length,onClick:()=>{if(s.length||!t.length)return;const p=t.map(r=>({text:r.question_text,options:r.options.map(b=>b.option_text),correctIndex:te?0:r.options.findIndex(b=>b.is_correct)>=0?r.options.findIndex(b=>b.is_correct):0}));a(p.length?p:[oe()]),w("form"),o({title:"Loaded",description:`${p.length} questions moved to form.`})},children:"Load into form"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(M,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create"}),e.jsx(M,{type:"button",variant:"outline",onClick:()=>Q(!1),children:"Cancel"})]})]})]})}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(Pe,{className:"w-5 h-5"}),"All Quizzes"]}),V?e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(X,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4",children:x.active.map(t=>{const s=t.prize_type||"money",c=xe(s,t.prize_pool,{fallback:0}),p=Array.isArray(t.prizes)?t.prizes.map(r=>xe(s,r,{fallback:0})).join(", "):"";return e.jsxs(me.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",Ie(t.category)||"â€”"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",c]}),e.jsxs("span",{children:["Prizes: ",p]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:["Start: ",t.start_time?he(t.start_time):"â€”"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?he(t.end_time):"â€”"]})]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(M,{size:"sm",variant:"outline",onClick:()=>m(t.id),disabled:le===t.id,children:le===t.id?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4 mr-1 animate-spin"}),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"w-4 h-4 mr-1"}),"Recompute"]})}),e.jsxs(Le,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100 text-indigo-600",children:[e.jsx(Ue,{className:"w-4 h-4"}),"Results"]}),e.jsxs(M,{size:"sm",variant:"outline",onClick:()=>{G(t),ie(t.id),be(!0)},className:"text-blue-400",children:[e.jsx(Ve,{className:"w-4 h-4 mr-1"}),"Questions"]}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>n(t.id),className:"text-red-500",children:e.jsx(Ze,{className:"w-4 h-4"})})]})]}),e.jsx(De,{children:fe&&(A==null?void 0:A.id)===t.id&&e.jsxs(me.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 space-y-2",children:[e.jsxs("h5",{className:"font-medium flex items-center gap-2",children:["Questions for ",t.title]}),K.length===0&&e.jsx("div",{className:"text-xs text-gray-500",children:"No questions."}),K.map((r,b)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 bg-white",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Q",b+1,": ",r.question_text]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:(r.options||[]).map(S=>e.jsxs("div",{className:`px-2 py-0.5 text-xs rounded-full ${S.is_correct?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[S.option_text,S.is_correct&&e.jsx("span",{className:"ml-1",children:"âœ“"})]},S.id))})]},r.id))]})})]},t.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:x.finished.map(t=>{const s=t.prize_type||"money",c=xe(s,t.prize_pool,{fallback:0}),p=Array.isArray(t.prizes)?t.prizes.map(r=>xe(s,r,{fallback:0})).join(", "):"";return e.jsxs(me.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",Ie(t.category)||"â€”"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",c]}),e.jsxs("span",{children:["Prizes: ",p]})]})]},t.id)})})]})]})]})]}),B==="approvals"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Pending Redemptions"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Approve user reward payouts after verifying their UPI ID / phone number."}),C&&e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(X,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading pending requests..."]}),!C&&z.length===0&&e.jsx("div",{className:"py-6 text-center text-gray-500 border border-gray-200 rounded-xl bg-gray-50",children:"No pending redemptions."}),z.length>0&&e.jsx("div",{className:"space-y-4",children:z.map(t=>{var s;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 bg-white shadow-sm flex flex-col md:flex-row md:items-center gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 to-yellow-500 flex items-center justify-center text-white font-semibold shadow",children:e.jsx("span",{className:"text-sm",children:"â‚¹"})}),(()=>{var b,S;const c=t.reward_value,p=c&&String(c).trim().length?c:`${t.reward_type||""}`.trim()||"Reward",r=((b=t.profiles)==null?void 0:b.username)||((S=t.profiles)==null?void 0:S.full_name)||"Anonymous";return e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 truncate",children:p}),e.jsxs("div",{className:"text-[11px] text-gray-600",children:["@",r]})]})})()]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600 flex flex-wrap gap-3",children:[e.jsxs("span",{children:["Type: ",t.reward_type||"â€”"]}),e.jsxs("span",{children:["Coins: ",(s=t.coins_required)!=null?s:0]}),e.jsxs("span",{children:["Requested: ",t.requested_at?he(t.requested_at):"â€”"]})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Payout:"," ",t.payout_identifier?`${t.payout_identifier} (${t.payout_channel||"upi"})`:"â€”"]})]}),e.jsx("div",{className:"flex items-center gap-2 self-start md:self-center",children:e.jsx(M,{size:"sm",onClick:()=>F(t.id),className:"bg-green-600 hover:bg-green-700 text-white",children:"Approve"})})]},t.id)})})]}),B==="notifications"&&e.jsx(Ke,{}),B==="rewards"&&e.jsx(Xe,{})]}):e.jsxs(e.Fragment,{children:[e.jsxs(Oe,{children:[e.jsx("meta",{name:"robots",content:"noindex, nofollow"}),e.jsx("link",{rel:"canonical",href:"https://quizdangal.com/admin/"})]}),e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-6 max-w-md w-full text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-500 mb-2",children:"Admin access required"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{children:"Supabase "}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" table mein aapke record ka "}),e.jsx("strong",{children:"role"}),e.jsx("span",{children:" field admin hona chahiye."})]}),e.jsxs("ul",{className:"text-left text-sm text-gray-600 mt-4 space-y-2 list-disc list-inside",children:[e.jsxs("li",{children:[e.jsx("span",{children:"Supabase dashboard"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"â†’"}),e.jsx("span",{children:"Table editor"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"â†’"}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:"Â me role update karein."})]}),e.jsx("li",{children:"Update ke baad login session refresh karein."}),e.jsxs("li",{children:["Dev bypass (",e.jsx("code",{children:"VITE_BYPASS_AUTH=1"}),") mein mock admin auto-enable hota hai."]})]})]})})]})}function Xe(){const{toast:o}=ge(),[h,k]=R.useState([]),[I,$]=R.useState(!1),[L,B]=R.useState(!1),[q,E]=R.useState({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),[N,V]=R.useState(!1),[T,D]=R.useState(null),Q=R.useCallback(async()=>{if(!g)return;$(!0);const{data:l,error:a}=await g.from("reward_catalog").select("id,reward_type,reward_value,coins_required,is_active").order("id",{ascending:!1}).limit(200);a?o({title:"Rewards load failed",description:a.message,variant:"destructive"}):k(l||[]),$(!1)},[o]);R.useEffect(()=>{Q()},[Q]);const u=()=>E({reward_type:"cash",reward_value:"",coins_required:"",is_active:!0}),d=async l=>{if(l.preventDefault(),!!g){V(!0);try{const a={reward_type:String(q.reward_type||"").trim()||"cash",reward_value:String(q.reward_value||"").trim(),coins_required:q.coins_required!==""&&q.coins_required!==null?parseInt(q.coins_required,10):null,is_active:!!q.is_active};if(!a.reward_value)throw new Error("Value required");if(a.coins_required===null||Number.isNaN(a.coins_required))throw new Error("Coins required");let A;if(T?A=await g.from("reward_catalog").update(a).eq("id",T).select().single():A=await g.from("reward_catalog").insert([a]).select().single(),A.error)throw A.error;o({title:T?"Reward updated":"Reward created"}),u(),B(!1),D(null),Q()}catch(a){o({title:"Save failed",description:a.message,variant:"destructive"})}finally{V(!1)}}},_=async l=>{if(!g)return;const{error:a}=await g.from("reward_catalog").update({is_active:!l.is_active}).eq("id",l.id);a?o({title:"Toggle failed",description:a.message,variant:"destructive"}):(o({title:l.is_active?"Deactivated":"Activated"}),Q())},w=l=>{var a;D(l.id),B(!0),E({reward_type:l.reward_type||"cash",reward_value:l.reward_value||"",coins_required:((a=l.coins_required)!=null?a:"").toString(),is_active:!!l.is_active})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Redemptions auto-approved hain. Neeche sirf Rewards Catalog manage karna hai."}),e.jsxs("div",{className:"pt-10 border-t border-gray-200 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Rewards Catalog"}),e.jsx(M,{size:"sm",onClick:()=>{B(l=>!l),L||(u(),D(null))},children:L?"Close":"New Reward"}),e.jsx(M,{size:"sm",variant:"outline",onClick:Q,disabled:I,children:I?e.jsx(X,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),L&&e.jsxs("form",{onSubmit:d,className:"space-y-3 bg-gray-50 border border-gray-200 rounded-lg p-4 max-w-3xl",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(H,{children:"Type"}),e.jsx("div",{className:"flex gap-2 flex-wrap mt-1",children:["cash","voucher"].map(l=>e.jsx("button",{type:"button",onClick:()=>E(a=>({...a,reward_type:l})),className:`px-2 py-1 rounded text-xs border ${q.reward_type===l?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:l==="cash"?"ðŸ’µ Cash (UPI/Phone)":"ðŸŽŸï¸ Voucher (WhatsApp)"},l))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:q.reward_type==="cash"?"User will provide UPI ID or Phone number":"User will provide WhatsApp number"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Value"}),e.jsx(J,{value:q.reward_value,onChange:l=>E(a=>({...a,reward_value:l.target.value})),placeholder:"e.g. 100 / AMAZON100 / â‚¹100"})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Coins Required"}),e.jsx(J,{type:"number",value:q.coins_required,onChange:l=>E(a=>({...a,coins_required:l.target.value})),placeholder:"coins needed"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_active",type:"checkbox",checked:!!q.is_active,onChange:l=>E(a=>({...a,is_active:l.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{type:"submit",disabled:N,children:N?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4 mr-1 animate-spin"}),"Saving"]}):T?"Update":"Create"}),e.jsx(M,{type:"button",variant:"outline",onClick:()=>{u(),D(null)},children:T?"Cancel Edit":"Reset"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Type"}),e.jsx("th",{className:"p-2 text-left",children:"Value"}),e.jsx("th",{className:"p-2 text-left",children:"Coins Required"}),e.jsx("th",{className:"p-2 text-left",children:"Active"}),e.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[h.map(l=>{var a;return e.jsxs("tr",{className:"border-t border-gray-200 hover:bg-gray-100",children:[e.jsx("td",{className:"p-2 capitalize",children:l.reward_type}),e.jsx("td",{className:"p-2 max-w-[260px] truncate",title:l.reward_value,children:l.reward_value}),e.jsx("td",{className:"p-2",children:(a=l.coins_required)!=null?a:"â€”"}),e.jsx("td",{className:"p-2",children:l.is_active?e.jsx("span",{className:"text-green-500",children:"Yes"}):e.jsx("span",{className:"text-gray-500",children:"No"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(M,{size:"sm",variant:"outline",onClick:()=>w(l),children:"Edit"}),e.jsx(M,{size:"sm",variant:"outline",onClick:()=>_(l),children:l.is_active?"Deactivate":"Activate"})]})})]},l.id)}),!h.length&&!I&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"p-4 text-center text-gray-500",children:"No rewards."})}),I&&e.jsx("tr",{children:e.jsxs("td",{colSpan:8,className:"p-6 text-center text-gray-500",children:[e.jsx(X,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading rewards..."]})})]})]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Catalog: inactive rewards are hidden from users."})]})]})}function Ke(){const{toast:o}=ge(),[h,k]=R.useState(""),[I,$]=R.useState(""),[L,B]=R.useState("all"),[q,E]=R.useState(!1),[N,V]=R.useState([]),[T,D]=R.useState(!1),Q=R.useCallback(async()=>{if(!g)return;D(!0);const{data:d,error:_}=await g.from("notifications").select("id,title,message,type,segment,created_at").order("created_at",{ascending:!1}).limit(100);_?o({title:"Fetch failed",description:_.message,variant:"destructive"}):V(d||[]),D(!1)},[o]);R.useEffect(()=>{Q()},[Q]);const u=async d=>{var _;if(d.preventDefault(),!h.trim()||!I.trim()){o({title:"Missing fields",variant:"destructive"});return}if(!g){o({title:"No backend client",variant:"destructive"});return}E(!0);try{const w={title:h.trim(),message:I.trim(),segment:L},{data:l}=await g.auth.getSession(),a=(_=l==null?void 0:l.session)==null?void 0:_.access_token,{data:A,error:G}=await g.functions.invoke("send-notifications",{body:w,headers:a?{Authorization:`Bearer ${a}`}:void 0});if(G)throw new Error(G.message||G.error||"Failed to send notification");const K=typeof A=="object"&&(A!=null&&A.message)?A.message:h.trim();o({title:"Sent",description:K}),k(""),$(""),Q()}catch(w){o({title:"Send failed",description:w.message,variant:"destructive"})}finally{E(!1)}};return e.jsxs("div",{className:"space-y-8 max-w-3xl",children:[e.jsxs("form",{onSubmit:u,className:"space-y-4 bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Send Notification"}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"notification-title",children:"Title"}),e.jsx(J,{id:"notification-title",name:"notificationTitle",value:h,onChange:d=>k(d.target.value),maxLength:80,placeholder:"Short title"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 80 chars â€¢ ",h.length,"/80"]})]}),e.jsxs("div",{children:[e.jsx(H,{htmlFor:"notification-message",children:"Message"}),e.jsx(ke,{id:"notification-message",name:"notificationMessage",value:I,onChange:d=>$(d.target.value),className:"h-28",maxLength:280,placeholder:"Body shown in push notification"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 280 chars â€¢ ",I.length,"/280"]})]}),e.jsxs("div",{children:[e.jsx(H,{children:"Segment"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["all"].map(d=>e.jsx("button",{type:"button",onClick:()=>B(d),className:`px-3 py-1 rounded text-xs border ${L===d?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:d},d))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(M,{type:"submit",disabled:q,children:q?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4 mr-1 animate-spin"}),"Sending"]}):"Send"}),e.jsx(M,{type:"button",variant:"outline",onClick:()=>{k(""),$("")},children:"Reset"})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Recent Notifications"}),e.jsx(M,{size:"sm",variant:"outline",onClick:Q,disabled:T,children:T?e.jsx(X,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),e.jsxs("div",{className:"space-y-3",children:[N.map(d=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:d.title}),e.jsx("div",{className:"text-xs text-gray-600 whitespace-pre-wrap max-w-xl break-words",children:d.message})]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:he(d.created_at)})]}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Segment: ",d.segment||"â€”",d.type?` â€¢ ${d.type}`:""]})]},d.id)),!N.length&&!T&&e.jsx("div",{className:"text-xs text-gray-500",children:"No notifications yet."})]})]})]})}export{nt as default};
