import{l as o}from"./index-e7111140.js";const a=new Map;async function j({supabase:i,quiz:r,user:l}){if(!i||!r||!r.id)return{status:"error",error:new Error("Missing quiz or supabase client")};if(!l||!l.id)return{status:"error",error:new Error("Not authenticated")};try{const n=r.start_time?new Date(r.start_time).getTime():null,_=r.end_time?new Date(r.end_time).getTime():null,c=Date.now();if(!n||!_){const{error:t}=await i.rpc("pre_join_quiz",{p_quiz_id:r.id});return t?{status:"error",error:t}:{status:"pre_joined"}}const u=5e3,p=c>=n-u&&c<_,h=n-(u+1500);if(c<h){const{error:t}=await i.rpc("pre_join_quiz",{p_quiz_id:r.id});return t?{status:"error",error:t}:{status:"pre_joined"}}if(!p&&c>=h&&c<n-300){const{error:t}=await i.rpc("pre_join_quiz",{p_quiz_id:r.id});if(t)return{status:"error",error:t};if(!a.has(r.id)){const d=Math.max(50,n-(u-100)-Date.now()),y=setTimeout(async()=>{a.delete(r.id);try{const{error:s}=await i.rpc("join_quiz",{p_quiz_id:r.id});if(s){const e=String(s.message||"").toLowerCase();if(e.includes("already")||e.includes("completed")){o.debug("Scheduled join: already joined/completed",r.id);return}if(e.includes("not active")){o.debug("Scheduled join: still not active, giving up this cycle",r.id);return}o.error("Scheduled join error",s.message||s)}else o.debug("Scheduled join success",r.id)}catch(s){o.error("Scheduled join throw",(s==null?void 0:s.message)||s)}},d);return a.set(r.id,y),{status:"scheduled_retry",scheduledAt:Date.now()+d}}return{status:"scheduled_retry",scheduledAt:null}}if(p){const{error:t}=await i.rpc("join_quiz",{p_quiz_id:r.id});if(!t)return{status:"joined"};const d=String(t.message||"").toLowerCase();if(d.includes("already")||d.includes("completed"))return{status:"already"};if(d.includes("not active")){if(!a.has(r.id)){const s=setTimeout(async()=>{a.delete(r.id);try{const{error:e}=await i.rpc("join_quiz",{p_quiz_id:r.id});e&&!String(e.message||"").toLowerCase().includes("already")&&o.error("Final join retry failed",e.message||e)}catch(e){o.error("Final join retry throw",(e==null?void 0:e.message)||e)}},600);return a.set(r.id,s),{status:"scheduled_retry",scheduledAt:Date.now()+600}}return{status:"scheduled_retry",scheduledAt:null}}return{status:"error",error:t}}const{error:m}=await i.rpc("pre_join_quiz",{p_quiz_id:r.id});return m?{status:"error",error:m}:{status:"pre_joined"}}catch(n){return{status:"error",error:n}}}export{j as s};
