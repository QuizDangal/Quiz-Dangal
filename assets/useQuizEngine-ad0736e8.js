import{r as i}from"./react-63c462fe.js";import{a as ce,u as le,k as de,s as d,Q as fe,c as Z}from"./index-93c1c8bc.js";import{s as me}from"./smartJoinQuiz-f8b04c3a.js";function B(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function ge(u,_,K={}){const{slotId:S=null}=K,{toast:c}=ce(),{user:s}=le(),{isSubscribed:P,subscribeToPush:J}=de(),[a,X]=i.useState(null),[q,O]=i.useState([]),[D,R]=i.useState(0),[F,$]=i.useState({}),[l,E]=i.useState("loading"),[I,C]=i.useState(0),[p,ee]=i.useState(null),[x,te]=i.useState(!1),[re,ne]=i.useState(!!S),L=i.useCallback(async()=>{if(!(!S||!d))try{const{data:t,error:r}=await d.from("quiz_slots_view").select("*").eq("id",S).maybeSingle();!r&&t&&(ee(t),te(t.status==="paused"))}catch(t){}finally{ne(!1)}},[S]);i.useEffect(()=>{L();const t=S?setInterval(L,15e3):null;return()=>{t&&clearInterval(t)}},[L,S]);const[v,H]=i.useState(!1),[Q,U]=i.useState({joined:0,pre_joined:0}),[M,g]=i.useState(!1),[m,y]=i.useState(null),f=i.useRef(null),G=i.useRef(!0),w=i.useRef([]),k=i.useRef(null);i.useEffect(()=>()=>{G.current=!1,f.current&&clearTimeout(f.current),k.current&&clearTimeout(k.current)},[]),i.useEffect(()=>()=>{try{a&&l==="active"&&m!=="completed"&&(s!=null&&s.id)&&d.from("quiz_participants").update({status:"completed"}).eq("user_id",s.id).eq("quiz_id",u).then(()=>{}).catch(()=>{})}catch(t){}},[a,u,l,m,s==null?void 0:s.id]);const z=i.useCallback(()=>{if(k.current||w.current.length===0)return;const t=w.current[0],r=2e3*Math.pow(2,(t.attempt||1)-1),e=Math.min(r,3e4);k.current=setTimeout(()=>{k.current=null,A()},e)},[]),A=i.useCallback(async()=>{if(w.current.length===0)return;const t=[...w.current];w.current=[];for(const r of t)if(!(!s||m==="completed"))try{const{error:e}=await d.from("user_answers").upsert({user_id:s.id,question_id:r.questionId,selected_option_id:r.optionId},{onConflict:"user_id,question_id"});if(e)throw e;$(n=>({...n,[r.questionId]:r.optionId}))}catch(e){const n=(r.attempt||1)+1;n<=6?w.current.push({...r,attempt:n}):c({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}w.current.length>0&&z()},[m,s,c,z]);i.useEffect(()=>{const t=()=>A(),r=()=>{B()||A()};return window.addEventListener("online",t),document.addEventListener("visibilitychange",r),()=>{window.removeEventListener("online",t),document.removeEventListener("visibilitychange",r)}},[A]);const W=(Q.joined||0)+(Q.pre_joined||0),ie=l==="active"?Q.joined||0:W,j=i.useCallback(async()=>{const{data:t,error:r}=await d.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",u).order("id");O(r?[]:t||[])},[u]),T=i.useCallback(async()=>{var t,r;try{const{data:e,error:n}=await d.rpc("get_engagement_counts",{p_quiz_id:u});if(n)console.warn("Engagement counts fetch failed:",n),U({joined:0,pre_joined:0});else{const o=Array.isArray(e)?e[0]:e,h=Number((t=o==null?void 0:o.joined)!=null?t:0),b=Number((r=o==null?void 0:o.pre_joined)!=null?r:0);U({joined:isNaN(h)?0:h,pre_joined:isNaN(b)?0:b})}}catch(e){console.warn("Engagement refresh failed",e)}},[u]),V=i.useCallback(async()=>{try{const{data:t,error:r}=await d.from("quizzes").select("*").eq("id",u).single();if(r||!t){c({title:"Error",description:"Quiz not found.",variant:"destructive"}),_("/");return}X(t);let e=null;if(s&&s.id){const{data:n,error:o}=await d.from("quiz_participants").select("status").eq("user_id",s.id).eq("quiz_id",u).maybeSingle();!o&&n?(e=n,g(!0),y(n.status||null),e.status==="completed"&&E("completed")):(g(!1),y(null))}else g(!1),y(null);e&&e.status!=="completed"&&await j(),await T()}catch(t){console.error("Error fetching quiz data:",t),c({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),_("/")}},[u,s,_,c,j,T]);i.useEffect(()=>{V()},[V]),i.useEffect(()=>{if(!a||l==="completed")return;const t=()=>{const e=new Date,n=p!=null&&p.start_time?new Date(p.start_time):a.start_time?new Date(a.start_time):null,o=p!=null&&p.end_time?new Date(p.end_time):a.end_time?new Date(a.end_time):null,h=n&&e<n,b=n&&o&&e>=n&&e<o;if(x){E("waiting"),C(h&&n?Math.max(0,Math.round((n.getTime()-e.getTime())/1e3)):b&&o?Math.max(0,Math.round((o.getTime()-e.getTime())/1e3)):0);return}if(h){E("waiting"),C(Math.max(0,Math.round((n.getTime()-e.getTime())/1e3)));return}if(b){E("active"),C(Math.max(0,Math.round((o.getTime()-e.getTime())/1e3)));return}E("finished"),C(0)};t();const r=setInterval(t,1e3);return()=>clearInterval(r)},[a,l,p,x]),i.useEffect(()=>{if(!a||!(l==="waiting"||l==="active"))return;const r=setInterval(()=>{B()||T()},fe);return()=>clearInterval(r)},[a,l,T]),i.useEffect(()=>{(async()=>{var r,e;if(a&&l==="active"&&s)try{if(!M||m==="pre_joined"){let n=!1,o=null;for(let h=0;h<2&&!n;h++){const{error:b}=await d.rpc("join_quiz",{p_quiz_id:u});if(!b){n=!0;break}o=b;const N=String(b.message||"").toLowerCase();if(N.includes("not active")){await new Promise(ue=>setTimeout(ue,1500));continue}if(N.includes("already")||N.includes("completed")){n=!0;break}break}if(n)g(!0),y("joined");else if(o){const{error:h}=await d.rpc("pre_join_quiz",{p_quiz_id:u});if(!h)g(!0),y("pre_joined");else throw o}}q.length===0&&await j()}catch(n){!((r=n==null?void 0:n.message)!=null&&r.includes("already"))&&!((e=n==null?void 0:n.message)!=null&&e.includes("completed"))&&console.error("Quiz join error:",n)}})()},[a,l,s,M,m,u,j,q.length,c]),i.useEffect(()=>{l==="finished"&&Object.keys(F).length>0&&!v&&Y()},[l]),i.useEffect(()=>{if(f.current&&(clearTimeout(f.current),f.current=null),!a||!a.end_time||!(l==="finished"||l==="completed"))return;const t=()=>{(async()=>{try{await Z(d,u)}catch(r){}_(`/results/${u}`)})()};try{const r=new Date(a.end_time).getTime(),e=Date.now(),n=Math.max(0,r-e);n===0?t():f.current=setTimeout(()=>{f.current=null,t()},n)}catch(r){console.error("Error calculating redirect time:",r),f.current=setTimeout(()=>{f.current=null,t()},5e3)}return()=>{f.current&&(clearTimeout(f.current),f.current=null)}},[a,u,l,_]);const se=i.useCallback(async()=>{var t,r;if(a){if(!s){c({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),_("/login");return}if(m!=="completed"){try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!P&&await J()}catch(e){}try{const e=await me({supabase:d,quiz:a,user:s});if(e.status==="error")throw e.error;e.status==="already"?(g(!0),y("joined"),c({title:"Already Joined",description:"Starting shortly."})):e.status==="joined"?(g(!0),y("joined"),c({title:"Joined!",description:"Starting now."})):e.status==="pre_joined"?(g(!0),y("pre_joined"),c({title:"Pre-joined!",description:"We will remind you before start."})):e.status==="scheduled_retry"&&(g(!0),y("pre_joined"),c({title:"Pre-joined!",description:"Auto join near start time."})),a.status==="active"&&(e.status==="joined"||e.status==="already")&&(await j(),E("active")),T()}catch(e){!((t=e==null?void 0:e.message)!=null&&t.includes("already"))&&!((r=e==null?void 0:e.message)!=null&&r.includes("completed"))&&(console.error("Join quiz error:",e),c({title:"Error",description:"Could not join quiz. Please try again.",variant:"destructive"}))}}}},[a,s,m,P,J,c,_,T,j,E]),ae=i.useCallback(async(t,r)=>{if(!(v||l!=="active"||m==="completed")&&s!=null&&s.id)try{const{error:e}=await d.from("user_answers").upsert({user_id:s.id,question_id:t,selected_option_id:r},{onConflict:"user_id,question_id"});if(e)throw e;$(n=>({...n,[t]:r})),D<q.length-1&&(typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>R(n=>n+1)):setTimeout(()=>R(n=>n+1),250))}catch(e){console.error("Error saving answer:",e),w.current.some(o=>o.questionId===t)||c({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),w.current.push({questionId:t,optionId:r,attempt:1}),z()}},[v,l,m,s==null?void 0:s.id,D,q.length,c,z]),Y=i.useCallback(async()=>{if(!v){H(!0);try{const{error:t}=await d.from("quiz_participants").update({status:"completed"}).eq("user_id",s.id).eq("quiz_id",u);if(t)throw t;c({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),E("completed");try{await Z(d,u)}catch(r){}_(`/results/${u}`)}catch(t){console.error("Error submitting quiz:",t),c({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{G.current&&H(!1)}}},[v,s==null?void 0:s.id,u,c,_]),oe=i.useCallback(t=>{const r=Math.floor(t/60),e=t%60;return`${r.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`},[]);return{quiz:a,questions:q,currentQuestionIndex:D,answers:F,quizState:l,timeLeft:I,submitting:v,engagement:Q,joined:M,participantStatus:m,totalJoined:W,displayJoined:ie,slotMeta:p,slotPaused:x,slotLoading:re,setCurrentQuestionIndex:R,handleJoinOrPrejoin:se,handleAnswerSelect:ae,handleSubmit:Y,formatTime:oe}}export{ge as u};
