import{a as de,u as le,k as ce,s as v,j as t,f as B,e as E,m as me,p as G,R as ue,g as pe}from"./index-2a250dd7.js";import{r as u}from"./react-63c462fe.js";import{s as xe}from"./smartJoinQuiz-4e68b9a7.js";import{S as ge}from"./SEO-11706b8c.js";import{c as fe,b as he}from"./router-d6d570a4.js";import{c as be,b as we,M as U,B as je,T as ye,a as ve}from"./icons-dca16fb3.js";import"./supabase-07ebd5d8.js";const h=new Map;let W=0;function N(d){if(!(W%200!==0&&h.size<100))for(const[a,c]of h.entries()){const l=(c.windowMs||8e3)*2;d-c.firstTs>l&&h.delete(a)}}function Ne(d,{max:a=5,windowMs:c=8e3}={}){W+=1;const l=Date.now(),x=h.get(d);return x?l-x.firstTs>x.windowMs?(h.set(d,{count:1,firstTs:l,windowMs:c}),N(l),{allowed:!0,remaining:a-1}):x.count>=a?(N(l),{allowed:!1,remaining:0}):(x.count+=1,N(l),{allowed:!0,remaining:a-x.count}):(h.set(d,{count:1,firstTs:l,windowMs:c}),N(l),{allowed:!0,remaining:a-1})}function _e(d){const a="px-2 py-0.5 rounded-full text-xs font-semibold";return d==="active"?a+" bg-green-600/15 text-green-400 border border-green-700/40":d==="upcoming"?a+" bg-blue-600/15 text-blue-300 border border-blue-700/40":a+" bg-slate-600/20 text-slate-300 border border-slate-700/40"}function ze(d=""){const a=String(d||"").toLowerCase();return a.includes("opinion")?{title:"Opinion Quizzes",emoji:"ðŸ’¬",Icon:U,from:"from-indigo-600/30",to:"to-fuchsia-600/30",ring:"ring-fuchsia-500/30"}:a.includes("gk")?{title:"GK Quizzes",emoji:"ðŸ§ ",Icon:je,from:"from-emerald-600/30",to:"to-teal-600/30",ring:"ring-emerald-500/30"}:a.includes("sport")?{title:"Sports Quizzes",emoji:"ðŸ†",Icon:ye,from:"from-orange-600/30",to:"to-red-600/30",ring:"ring-orange-500/30"}:a.includes("movie")?{title:"Movie Quizzes",emoji:"ðŸŽ¬",Icon:ve,from:"from-violet-600/30",to:"to-indigo-600/30",ring:"ring-violet-500/30"}:{title:`${d} Quizzes`,emoji:"â­",Icon:U,from:"from-sky-600/30",to:"to-indigo-600/30",ring:"ring-sky-500/30"}}const Ie=()=>{const{slug:d}=fe(),a=he(),{toast:c}=de(),{user:l}=le(),{isSubscribed:x,subscribeToPush:K}=ce(),[m,V]=u.useState([]),[F,S]=u.useState(!0),[w,D]=u.useState(null),[H,M]=u.useState({}),[Y,g]=u.useState({}),[X,Z]=u.useState(0),C=u.useCallback(async()=>{try{const{data:e,error:s}=await v.from("quizzes").select("id,title,category,start_time,end_time,status,prize_pool,prizes,prize_type").eq("category",d).order("start_time",{ascending:!0});if(s)throw s;V(e||[])}catch(e){c({title:"Error",description:"Could not load quizzes.",variant:"destructive"})}finally{S(!1)}},[d,c]);u.useEffect(()=>{S(!0),C()},[C]),u.useEffect(()=>{const e=Date.now();if(!(m||[]).some(r=>{const o=r.start_time?new Date(r.start_time).getTime():0,n=r.end_time?new Date(r.end_time).getTime():0;return o&&e<o||o&&n&&e>=o&&e<n}))return;const i=setInterval(()=>Z(r=>(r+1)%1e6),1e3);return()=>clearInterval(i)},[m]),u.useEffect(()=>{const e=async()=>{try{const s=(m||[]).map(n=>n.id);if(!s.length){M({});return}const{data:i,error:r}=await v.rpc("get_engagement_counts_many",{p_quiz_ids:s});if(r)throw r;const o={};for(const n of i||[]){const p=n.pre_joined||0,y=n.joined||0;o[n.quiz_id]=p+y}M(o)}catch(s){}};m&&m.length&&e()},[m]),u.useEffect(()=>{(async()=>{if(!l||!(m!=null&&m.length)){g({});return}try{const s=m.map(n=>n.id),{data:i,error:r}=await v.from("quiz_participants").select("quiz_id,status").eq("user_id",l.id).in("quiz_id",s);if(r)throw r;const o={};for(const n of i||[])o[n.quiz_id]=n.status==="pre_joined"?"pre":"joined";g(o)}catch(s){g({})}})()},[l,m]);const q=async e=>{if(!l){c({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),a("/login");return}D(e.id);try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!x&&Promise.resolve().then(()=>K()).catch(()=>{})}catch(s){}try{const s=await xe({supabase:v,quiz:e,user:l});if(s.status==="error")throw s.error;s.status==="already"?(g(i=>({...i,[e.id]:"joined"})),c({title:"Already Joined",description:"You are in this quiz."})):s.status==="joined"?(g(r=>({...r,[e.id]:"joined"})),Ne(`join_${(l==null?void 0:l.id)||"anon"}`,{max:4,windowMs:8e3}).allowed?(c({title:"Joined!",description:"Taking you to the quiz."}),a(`/quiz/${e.id}`)):c({title:"Slow down",description:"Please wait a moment before trying again.",variant:"destructive"})):s.status==="pre_joined"?(g(i=>({...i,[e.id]:"pre"})),c({title:"Pre-joined!",description:"We will remind you before start."})):s.status==="scheduled_retry"&&(g(i=>({...i,[e.id]:"pre"})),c({title:"Pre-joined!",description:"Auto joining at start time."}))}catch(s){c({title:"Error",description:(s==null?void 0:s.message)||"Could not join quiz.",variant:"destructive"})}finally{D(null)}},$=m.filter(e=>{const s=Date.now(),i=e.start_time?new Date(e.start_time).getTime():0,r=e.end_time?new Date(e.end_time).getTime():0,o=i&&r&&s>=i&&s<r,n=i&&s<i;return o||n}),f=ze(d),j=Date.now(),ee=(m||[]).reduce((e,s)=>{const i=s.start_time?new Date(s.start_time).getTime():0,r=s.end_time?new Date(s.end_time).getTime():0;return e+(i&&r&&j>=i&&j<r?1:0)},0),te=(m||[]).reduce((e,s)=>{const i=s.start_time?new Date(s.start_time).getTime():0;return e+(i&&j<i?1:0)},0),_=(m||[]).map(e=>e.start_time?new Date(e.start_time).getTime():null).filter(e=>e&&e>j).sort((e,s)=>e-s)[0]||null,se=typeof window!="undefined"?`${window.location.origin}/category/${d}/`:`https://quizdangal.com/category/${d}/`;return t.jsxs("div",{className:"container mx-auto px-4 py-3 text-foreground",children:[t.jsx(ge,{title:`${f.title} â€“ Quiz Dangal`,description:`Active and upcoming quizzes in ${f.title}.`,canonical:se,robots:"index, follow"}),t.jsx("span",{className:"hidden","aria-hidden":!0,children:X}),t.jsxs("div",{className:`relative overflow-hidden rounded-2xl border border-slate-800 bg-gradient-to-r ${f.from} ${f.to} shadow-xl mb-4`,children:[t.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(700px 180px at -10% -20%, rgba(255,255,255,0.07), transparent), radial-gradient(420px 100px at 110% 10%, rgba(255,255,255,0.05), transparent)"}}),t.jsx("div",{className:"px-4 py-4 sm:px-5 sm:py-5",children:t.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:t.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[t.jsx("div",{className:"shrink-0 grid place-items-center w-10 h-10 sm:w-12 sm:h-12 rounded-xl ring-2 ring-white/20 bg-white/10 text-white text-xl sm:text-2xl shadow","aria-hidden":!0,children:f.emoji}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("h1",{className:"truncate text-base sm:text-xl font-extrabold text-white tracking-tight drop-shadow-sm",children:f.title}),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-white/85",children:[t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-600/20 text-emerald-200 border border-emerald-500/30",children:[ee," live"]}),t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-sky-600/20 text-sky-200 border border-sky-500/30",children:[te," upcoming"]}),_&&t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/10 text-white/90 border border-white/20",children:[t.jsx(be,{className:"w-3.5 h-3.5"})," Next: ",B(_)," â€¢ ",E(_)]})]})]})]})})})]}),F?t.jsx("div",{className:"grid gap-3",children:Array.from({length:4}).map((e,s)=>t.jsx("div",{className:"h-24 rounded-xl bg-slate-800/60 border border-slate-700/60 animate-pulse"},s))}):$.length===0?t.jsx("div",{className:"text-center text-muted-foreground py-16",children:"No quizzes in this category yet."}):t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4",children:$.map((e,s)=>{var Q,L,R;const i=Date.now(),r=e.start_time?new Date(e.start_time).getTime():null,o=e.end_time?new Date(e.end_time).getTime():null,n=r&&o&&i>=r&&i<o,p=r&&i<r,y=o&&i>=o&&i-o<=ue*60*1e3,I=n||p,z=p&&r?Math.max(0,Math.floor((r-i)/1e3)):n&&o?Math.max(0,Math.floor((o-i)/1e3)):null,k=Array.isArray(e.prizes)?e.prizes:[],ie=e.prize_type||"coins",re=(Q=k[0])!=null?Q:0,ne=(L=k[1])!=null?L:0,ae=(R=k[2])!=null?R:0,T=b=>pe(ie,b,{fallback:0}).formatted,oe=H[e.id]||0,P=Y[e.id],J=!!P,A=r&&o?Math.max(1,o-r):null,O=n&&A?Math.min(100,Math.max(0,Math.round((i-r)/A*100))):null;return t.jsxs(me.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:s*.03},onClick:()=>a(`/quiz/${e.id}`),className:`relative overflow-hidden rounded-2xl border ${n?"border-emerald-700/50":"border-slate-800"} bg-gradient-to-br from-slate-950/90 via-slate-900/85 to-slate-900/60 shadow-xl cursor-pointer group hover:-translate-y-0.5 transition-transform`,role:"button",tabIndex:0,onKeyDown:b=>{b.key==="Enter"&&a(`/quiz/${e.id}`)},children:[t.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(1200px 300px at -10% -10%, rgba(99,102,241,0.06), transparent), radial-gradient(900px 200px at 110% 20%, rgba(16,185,129,0.05), transparent)"}}),t.jsxs("div",{className:"absolute top-3 right-3 z-10 flex gap-2",children:[n&&t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-extrabold tracking-widest bg-rose-600 text-white ring-1 ring-rose-300/50 shadow",children:"LIVE"}),p&&t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-extrabold tracking-widest bg-sky-600 text-white ring-1 ring-sky-300/50 shadow",children:"SOON"}),!n&&!p&&y&&t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-extrabold tracking-widest bg-slate-700 text-white ring-1 ring-slate-400/40 shadow",children:"RECENT"})]}),t.jsxs("div",{className:"p-4 sm:p-5",children:[t.jsx("div",{className:"flex items-center justify-between gap-3",children:t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsx("div",{className:"w-full font-semibold text-slate-100 text-base sm:text-lg whitespace-normal break-words leading-snug pr-12 sm:pr-16",children:e.title}),t.jsxs("span",{className:_e(n?"active":p?"upcoming":"finished"),children:[n?"active":p?"upcoming":"finished",!n&&!p&&y?" (recent)":""]}),P&&t.jsx("span",{className:`px-2 py-0.5 rounded-full text-[10px] font-semibold border ${n?"bg-emerald-500/15 text-emerald-300 border-emerald-700/40":"bg-indigo-500/15 text-indigo-300 border-indigo-700/40"}`,children:"Joined"})]}),t.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[t.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-amber-500/20 to-amber-400/10 text-amber-200 border border-amber-500/30 shadow-sm",children:["ðŸ¥‡ ",T(re)]}),t.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-sky-500/20 to-sky-400/10 text-sky-200 border border-sky-500/30 shadow-sm",children:["ðŸ¥ˆ ",T(ne)]}),t.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-violet-500/20 to-violet-400/10 text-violet-200 border border-violet-500/30 shadow-sm",children:["ðŸ¥‰ ",T(ae)]})]}),t.jsxs("div",{className:"mt-2",children:[t.jsx("div",{className:"text-[11px] text-slate-400",children:e.start_time?B(e.start_time):"â€”"}),t.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2 text-[11px] text-slate-300",children:[t.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-md px-2 py-1",children:[t.jsx("span",{className:"uppercase text-[9px] text-slate-400",children:"Start"}),t.jsx("div",{children:e.start_time?E(e.start_time):"â€”"})]}),t.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-md px-2 py-1",children:[t.jsx("span",{className:"uppercase text-[9px] text-slate-400",children:"End"}),t.jsx("div",{children:e.end_time?E(e.end_time):"â€”"})]})]})]}),z!==null&&t.jsxs("div",{className:"mt-2 text-sm font-semibold text-indigo-300",children:[p?"Starts in":"Ends in"," ",Math.floor(z/60).toString().padStart(2,"0"),":",(z%60).toString().padStart(2,"0")]}),t.jsx("div",{className:"mt-1 flex items-center gap-4 text-xs text-slate-400",children:t.jsxs("span",{className:"inline-flex items-center",children:[t.jsx(we,{className:"w-3.5 h-3.5 mr-1"}),oe," joined"]})}),O!==null&&t.jsx("div",{className:"mt-2 w-full bg-slate-800/50 border border-slate-700/70 rounded-full h-1 overflow-hidden",children:t.jsx("div",{className:"h-1 bg-emerald-500/80",style:{width:`${O}%`}})})]})}),t.jsx("div",{className:"mt-3 flex",children:t.jsx("button",{type:"button",onClick:b=>{b.stopPropagation(),J||!I?a(`/quiz/${e.id}`):q(e)},onMouseEnter:()=>G("/quiz"),onFocus:()=>G("/quiz"),disabled:w===e.id,"aria-disabled":w===e.id,className:`relative z-20 pointer-events-auto w-full px-4 py-2.5 rounded-lg text-sm sm:text-base font-extrabold border text-white transition focus:outline-none focus:ring-2 focus:ring-fuchsia-300 overflow-hidden ${w===e.id?"opacity-80 cursor-wait":"hover:scale-[1.015] active:scale-[0.99] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)]"} shadow-[0_8px_18px_rgba(139,92,246,0.4)] border-violet-500/40 bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]`,children:t.jsx("span",{className:"inline-flex items-center justify-center gap-2",children:J?"JOINED":I?w===e.id?"JOININGâ€¦":"JOIN":"VIEW"})})})]})]},e.id)})})]})};export{Ie as default};
