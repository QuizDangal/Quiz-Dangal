import{a as _e,u as ze,k as Se,s as N,j as t,f as ne,e as k,m as De,p as re,g as Ie}from"./index-e7111140.js";import{r as m}from"./react-63c462fe.js";import{f as Me,c as Te}from"./slots-42960951.js";import{s as Ee}from"./smartJoinQuiz-dd29b6b8.js";import{S as ke}from"./SEO-9de033b6.js";import{c as Ce,b as $e}from"./router-d6d570a4.js";import{b as Ae,c as Pe,M as oe,B as Je,T as Le,a as Oe}from"./icons-1e9e0bae.js";import"./supabase-07ebd5d8.js";const _=new Map;let le=0;function Q(r){if(!(le%200!==0&&_.size<100))for(const[d,c]of _.entries()){const l=(c.windowMs||8e3)*2;r-c.firstTs>l&&_.delete(d)}}function Qe(r,{max:d=5,windowMs:c=8e3}={}){le+=1;const l=Date.now(),p=_.get(r);return p?l-p.firstTs>p.windowMs?(_.set(r,{count:1,firstTs:l,windowMs:c}),Q(l),{allowed:!0,remaining:d-1}):p.count>=d?(Q(l),{allowed:!1,remaining:0}):(p.count+=1,Q(l),{allowed:!0,remaining:d-p.count}):(_.set(r,{count:1,firstTs:l,windowMs:c}),Q(l),{allowed:!0,remaining:d-1})}function Ue(r=""){const d=String(r||"").toLowerCase();return d.includes("opinion")?{title:"Opinion Quizzes",emoji:"ðŸ’¬",Icon:oe,from:"from-indigo-600/30",to:"to-fuchsia-600/30",ring:"ring-fuchsia-500/30"}:d.includes("gk")?{title:"GK Quizzes",emoji:"ðŸ§ ",Icon:Je,from:"from-emerald-600/30",to:"to-teal-600/30",ring:"ring-emerald-500/30"}:d.includes("sport")?{title:"Sports Quizzes",emoji:"ðŸ†",Icon:Le,from:"from-orange-600/30",to:"to-red-600/30",ring:"ring-orange-500/30"}:d.includes("movie")?{title:"Movie Quizzes",emoji:"ðŸŽ¬",Icon:Oe,from:"from-violet-600/30",to:"to-indigo-600/30",ring:"ring-violet-500/30"}:{title:`${r} Quizzes`,emoji:"â­",Icon:oe,from:"from-sky-600/30",to:"to-indigo-600/30",ring:"ring-sky-500/30"}}const U=r=>r!=null&&r.start_time?new Date(r.start_time).getTime():null,ce=r=>r!=null&&r.end_time?new Date(r.end_time).getTime():null,ae=r=>{const d=U(r),c=ce(r);if(!d||!c)return!1;const l=Date.now();return l>=d&&l<c},de=r=>{const d=U(r);return d?Date.now()<d:!1},Xe=()=>{const{slug:r}=Ce(),d=$e(),{toast:c}=_e(),{user:l}=ze(),{isSubscribed:p,subscribeToPush:me}=Se(),[u,ue]=m.useState([]),[K,F]=m.useState(!0),[V,Y]=m.useState(null),[xe,X]=m.useState({}),[pe,b]=m.useState({}),[ge,Z]=m.useState(0),[C,fe]=m.useState([]),[g,$]=m.useState("detect"),[he,be]=m.useState(!0),ye=2e4,A=m.useCallback(async()=>{if(N)try{const{slots:e,mode:s,auto:i}=await Me(N,r);s==="slots"?(fe(e),$("slots"),be(i)):(s==="legacy"||s==="error")&&$("legacy")}catch(e){$("legacy")}},[r]),q=m.useCallback(async()=>{try{const{data:e,error:s}=await N.from("quizzes").select("id,title,category,start_time,end_time,status,prize_pool,prizes,prize_type").eq("category",r).order("start_time",{ascending:!0});if(s)throw s;ue(e||[])}catch(e){c({title:"Error",description:"Could not load quizzes.",variant:"destructive"})}finally{F(!1)}},[r,c]);m.useEffect(()=>{F(!0),A().finally(()=>{g!=="slots"?q():F(!1)})},[q,A,r]),m.useEffect(()=>{if(g!=="slots")return;const e=setInterval(()=>{A()},ye);return()=>clearInterval(e)},[g,A]),m.useEffect(()=>{const e=Date.now();if(!(u||[]).some(n=>{const a=n.start_time?new Date(n.start_time).getTime():0,o=n.end_time?new Date(n.end_time).getTime():0;return a&&e<a||a&&o&&e>=a&&e<o}))return;const i=setInterval(()=>Z(n=>(n+1)%1e6),1e3);return()=>clearInterval(i)},[u]),m.useEffect(()=>{if(g!=="slots")return;const e=Date.now();if(!(C||[]).some(n=>{const a=n.start_time?new Date(n.start_time).getTime():0,o=n.end_time?new Date(n.end_time).getTime():0;return a&&e<a||a&&o&&e>=a&&e<o}))return;const i=setInterval(()=>Z(n=>(n+1)%1e6),1e3);return()=>clearInterval(i)},[C,g]),m.useEffect(()=>{const e=async()=>{try{const s=(u||[]).map(o=>o.id);if(!s.length){X({});return}const{data:i,error:n}=await N.rpc("get_engagement_counts_many",{p_quiz_ids:s});if(n)throw n;const a={};for(const o of i||[]){const f=o.pre_joined||0,h=o.joined||0;a[o.quiz_id]=f+h}X(a)}catch(s){}};u&&u.length&&e()},[u]),m.useEffect(()=>{(async()=>{if(!l||!(u!=null&&u.length)){b({});return}try{const s=u.map(o=>o.id),{data:i,error:n}=await N.from("quiz_participants").select("quiz_id,status").eq("user_id",l.id).in("quiz_id",s);if(n)throw n;const a={};for(const o of i||[])a[o.quiz_id]=o.status==="pre_joined"?"pre":"joined";b(a)}catch(s){b({})}})()},[l,u]);const we=async e=>{if(!l){c({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),d("/login");return}Y(e.id);try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!p&&Promise.resolve().then(()=>me()).catch(()=>{})}catch(s){}try{const s=await Ee({supabase:N,quiz:e,user:l});if(s.status==="error")throw s.error;s.status==="already"?(b(i=>({...i,[e.id]:"joined"})),c({title:"Already Joined",description:"You are in this quiz."})):s.status==="joined"?(b(n=>({...n,[e.id]:"joined"})),Qe(`join_${(l==null?void 0:l.id)||"anon"}`,{max:4,windowMs:8e3}).allowed?(c({title:"Joined!",description:"Taking you to the quiz."}),d(`/quiz/${e.id}`)):c({title:"Slow down",description:"Please wait a moment before trying again.",variant:"destructive"})):s.status==="pre_joined"?(b(i=>({...i,[e.id]:"pre"})),c({title:"Pre-joined!",description:"We will remind you before start."})):s.status==="scheduled_retry"&&(b(i=>({...i,[e.id]:"pre"})),c({title:"Pre-joined!",description:"Auto joining at start time."}))}catch(s){c({title:"Error",description:(s==null?void 0:s.message)||"Could not join quiz.",variant:"destructive"})}finally{Y(null)}},ee=u.filter(e=>{if(g==="slots")return!1;const s=Date.now(),i=e.start_time?new Date(e.start_time).getTime():0,n=e.end_time?new Date(e.end_time).getTime():0,a=i&&n&&s>=i&&s<n,o=i&&s<i;return a||o}),P=Ue(r),z=Date.now(),J=g==="slots",j=J?C:u||[],je=J?j.filter(e=>ae(e)).length:j.reduce((e,s)=>{const i=s.start_time?new Date(s.start_time).getTime():0,n=s.end_time?new Date(s.end_time).getTime():0;return e+(i&&n&&z>=i&&z<n?1:0)},0),ve=J?j.filter(e=>de(e)).length:j.reduce((e,s)=>{const i=s.start_time?new Date(s.start_time).getTime():0;return e+(i&&z<i?1:0)},0),W=J?j.map(e=>U(e)).filter(e=>e&&e>z).sort((e,s)=>e-s)[0]||null:j.map(e=>e.start_time?new Date(e.start_time).getTime():null).filter(e=>e&&e>z).sort((e,s)=>e-s)[0]||null,{live:te,next:v}=Te(C),se=(e,s)=>{var I,M,T;if(!e)return null;const i=Date.now(),n=U(e),a=ce(e),o=ae(e),f=e.status==="paused",h=e.status==="finished"||a&&i>=a,x=de(e),y=x&&n?Math.max(0,Math.floor((n-i)/1e3)):o&&a?Math.max(0,Math.floor((a-i)/1e3)):null,S=Array.isArray(e.prizes)?e.prizes:[],B=(I=S[0])!=null?I:0,G=(M=S[1])!=null?M:0,R=(T=S[2])!=null?T:0,D=e.participants_total||e.participants_joined||0,H=e.questions_count||10,L=!he&&!o&&!x,w=o&&!h?"LIVE":f?"PAUSED":L?"STOPPED":x?"UPCOMING":h?"FINISHED":(e.status||"").toUpperCase(),O=h?"Results":o?"Join":x?"Preview":"View";return t.jsx("div",{className:`p-[1px] rounded-xl sm:rounded-2xl ${o?"bg-gradient-to-r from-emerald-500/60 to-green-500/60":"bg-gradient-to-r from-indigo-500/40 via-violet-500/30 to-fuchsia-500/40"}`,children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4 lg:p-5",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2 sm:mb-3",children:[t.jsx("span",{className:"px-2 sm:px-3 py-0.5 sm:py-1 rounded-md bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 text-[10px] sm:text-xs font-semibold",children:s}),t.jsx("span",{className:`px-2 sm:px-3 py-0.5 sm:py-1 rounded-md text-[9px] sm:text-[11px] font-bold ${w==="LIVE"?"bg-rose-600 text-white":w==="UPCOMING"?"bg-sky-600 text-white":w==="PAUSED"?"bg-amber-600 text-white":"bg-slate-700 text-slate-300"}`,children:w})]}),t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 text-[10px] sm:text-xs text-slate-400 mb-2 sm:mb-3",children:[t.jsxs("div",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[t.jsx("span",{className:"text-[9px] sm:text-[10px] text-slate-500",children:"Start"})," ",e.start_time?k(e.start_time):"â€”"]}),t.jsxs("div",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[t.jsx("span",{className:"text-[9px] sm:text-[10px] text-slate-500",children:"End"})," ",e.end_time?k(e.end_time):"â€”"]})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 text-[10px] sm:text-xs mb-2 sm:mb-3",children:[t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-amber-500/15 text-amber-300 border border-amber-600/30",children:["ðŸ¥‡ ",B]}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-sky-500/15 text-sky-300 border border-sky-600/30",children:["ðŸ¥ˆ ",G]}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-violet-500/15 text-violet-300 border border-violet-600/30",children:["ðŸ¥‰ ",R]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2 sm:mb-3",children:[t.jsxs("div",{className:"text-[10px] sm:text-xs text-slate-500",children:[H," Qs â€¢ ",D," joined"]}),y!==null&&t.jsxs("div",{className:"text-xs sm:text-sm font-semibold text-indigo-300",children:[x?"In":"Ends"," ",Math.floor(y/60).toString().padStart(2,"0"),":",(y%60).toString().padStart(2,"0")]})]}),t.jsx("button",{type:"button",onClick:()=>d(`/quiz/slot/${e.slotId}`),onMouseEnter:()=>re(`/quiz/slot/${e.slotId}`),className:`w-full h-9 sm:h-10 lg:h-11 rounded-lg text-xs sm:text-sm font-bold text-white transition ${o?"bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90":"bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90"}`,children:O})]})},e.slotId)};m.useEffect(()=>{if(!v)return;const e=v.start_time?new Date(v.start_time).getTime():null;if(!e)return;const s=Date.now(),i=e-s-6e4;if(i<=0||i>1800*1e3)return;const n=setTimeout(()=>{try{c({title:"Upcoming Slot",description:"1 minute to start â€“ be ready!",duration:4e3})}catch(a){}},i);return()=>clearTimeout(n)},[v,c]);const Ne=typeof window!="undefined"?`${window.location.origin}/category/${r}/`:`https://quizdangal.com/category/${r}/`;return t.jsxs("div",{className:"px-3 sm:px-4 pt-16 sm:pt-20 pb-6",children:[t.jsx(ke,{title:`${P.title} â€“ Quiz Dangal`,description:`Active and upcoming quizzes in ${P.title}.`,canonical:Ne,robots:"index, follow"}),t.jsx("span",{className:"hidden","aria-hidden":!0,children:ge}),t.jsxs("div",{className:"max-w-md sm:max-w-2xl lg:max-w-4xl mx-auto space-y-4",children:[t.jsx("div",{className:"p-[1px] rounded-xl sm:rounded-2xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4 lg:p-5",children:[t.jsxs("div",{className:"flex items-center gap-3 sm:gap-4 mb-2",children:[t.jsx("div",{className:"w-9 h-9 sm:w-12 sm:h-12 lg:w-14 lg:h-14 rounded-lg sm:rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-lg sm:text-2xl lg:text-3xl",children:P.emoji}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("h1",{className:"text-base sm:text-xl lg:text-2xl font-bold text-white truncate",children:P.title}),t.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-[10px] sm:text-xs mt-1",children:[t.jsxs("span",{className:"px-1.5 sm:px-2.5 py-0.5 sm:py-1 rounded sm:rounded-md bg-emerald-600/20 text-emerald-300 border border-emerald-600/30",children:[je," live"]}),t.jsxs("span",{className:"px-1.5 sm:px-2.5 py-0.5 sm:py-1 rounded sm:rounded-md bg-sky-600/20 text-sky-300 border border-sky-600/30",children:[ve," upcoming"]})]})]})]}),W&&t.jsxs("div",{className:"flex items-center gap-1 text-[10px] sm:text-xs text-slate-400",children:[t.jsx(Ae,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Next: ",ne(W)," â€¢ ",k(W)]})]})}),g==="slots"?t.jsx(t.Fragment,{children:K?t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:Array.from({length:2}).map((e,s)=>t.jsx("div",{className:"h-40 sm:h-48 lg:h-52 rounded-xl sm:rounded-2xl bg-slate-800/60 border border-slate-700/60 animate-pulse"},s))}):t.jsx(t.Fragment,{children:te||v?t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4",children:[se(te,"Live now"),se(v,"Upcoming")]}):t.jsx("div",{className:"rounded-xl sm:rounded-2xl border border-slate-800 bg-slate-900/50 p-4 sm:p-6 text-center text-sm sm:text-base text-slate-400",children:"Schedule will appear once todayâ€™s slots go live."})})}):K?t.jsx("div",{className:"grid gap-3 sm:gap-4",children:Array.from({length:4}).map((e,s)=>t.jsx("div",{className:"h-24 sm:h-28 rounded-xl sm:rounded-2xl bg-slate-800/60 border border-slate-700/60 animate-pulse"},s))}):ee.length===0?t.jsx("div",{className:"text-center text-muted-foreground py-16",children:"No quizzes in this category yet."}):t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:ee.map((e,s)=>{var M,T,ie;const i=Date.now(),n=e.start_time?new Date(e.start_time).getTime():null,a=e.end_time?new Date(e.end_time).getTime():null,o=n&&a&&i>=n&&i<a,f=n&&i<n,h=o||f,x=f&&n?Math.max(0,Math.floor((n-i)/1e3)):o&&a?Math.max(0,Math.floor((a-i)/1e3)):null,y=Array.isArray(e.prizes)?e.prizes:[],S=e.prize_type||"coins",B=(M=y[0])!=null?M:0,G=(T=y[1])!=null?T:0,R=(ie=y[2])!=null?ie:0,D=E=>Ie(S,E,{fallback:0}).formatted,H=xe[e.id]||0,L=pe[e.id],w=!!L,O=n&&a?Math.max(1,a-n):null,I=o&&O?Math.min(100,Math.max(0,Math.round((i-n)/O*100))):null;return t.jsx(De.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{delay:s*.02},onClick:()=>d(`/quiz/${e.id}`),className:"cursor-pointer",role:"button",tabIndex:0,onKeyDown:E=>{E.key==="Enter"&&d(`/quiz/${e.id}`)},children:t.jsx("div",{className:`p-[1px] rounded-xl sm:rounded-2xl ${o?"bg-gradient-to-r from-emerald-500/60 to-green-500/60":"bg-gradient-to-r from-indigo-500/40 via-violet-500/30 to-fuchsia-500/40"}`,children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[t.jsx("h3",{className:"text-sm sm:text-base font-bold text-white flex-1 min-w-0 line-clamp-2",children:e.title}),t.jsxs("div",{className:"shrink-0 flex items-center gap-1",children:[o&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-bold bg-rose-600 text-white",children:"LIVE"}),f&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-bold bg-sky-600 text-white",children:"SOON"}),L&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-semibold bg-indigo-600/20 text-indigo-300 border border-indigo-500/40",children:"Joined"})]})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5 text-[10px] sm:text-xs mb-2",children:[t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-amber-500/15 text-amber-300 border border-amber-600/30",children:["ðŸ¥‡ ",D(B)]}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-sky-500/15 text-sky-300 border border-sky-600/30",children:["ðŸ¥ˆ ",D(G)]}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-violet-500/15 text-violet-300 border border-violet-600/30",children:["ðŸ¥‰ ",D(R)]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-[10px] sm:text-xs text-slate-400 mb-2",children:[t.jsx("span",{children:e.start_time?ne(e.start_time):"â€”"}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[e.start_time?k(e.start_time):"â€”"," - ",e.end_time?k(e.end_time):"â€”"]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[t.jsxs("div",{className:"flex items-center gap-1 text-[10px] sm:text-xs text-slate-500",children:[t.jsx(Pe,{className:"w-3 h-3 sm:w-4 sm:h-4"}),H," joined"]}),x!==null&&t.jsxs("div",{className:"text-xs sm:text-sm font-semibold text-indigo-300",children:[f?"In":"Ends"," ",Math.floor(x/60).toString().padStart(2,"0"),":",(x%60).toString().padStart(2,"0")]})]}),I!==null&&t.jsx("div",{className:"mb-2 w-full bg-slate-800 rounded-full h-1 sm:h-1.5 overflow-hidden",children:t.jsx("div",{className:"h-full bg-emerald-500",style:{width:`${I}%`}})}),t.jsx("button",{type:"button",onClick:E=>{E.stopPropagation(),w||!h?d(`/quiz/${e.id}`):we(e)},onMouseEnter:()=>re("/quiz"),disabled:V===e.id,className:`w-full h-9 sm:h-10 rounded-lg text-xs sm:text-sm font-bold text-white transition ${o?"bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90":"bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90"} ${V===e.id?"opacity-80":""}`,children:w?"JOINED":h?V===e.id?"JOININGâ€¦":"JOIN":"VIEW"})]})})},e.id)})})]})]})};export{Xe as default};
