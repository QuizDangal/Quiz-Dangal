import{a as de,u as ue,k as me,s as b,Q as xe,c as K,j as e,m as Q,B as X,A as fe,f as pe,e as I,g as he}from"./index-2a250dd7.js";import{r as o}from"./react-63c462fe.js";import{s as ge}from"./smartJoinQuiz-4e68b9a7.js";import{S as H}from"./SEO-11706b8c.js";import{c as be,b as we}from"./router-d6d570a4.js";import{L as ee,X as te,c as se,b as ie,u as ne}from"./icons-dca16fb3.js";import"./supabase-07ebd5d8.js";function ae(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function je(d,p){const{toast:t}=de(),{user:r}=ue(),{isSubscribed:C,subscribeToPush:P}=me(),[l,R]=o.useState(null),[_,W]=o.useState([]),[M,J]=o.useState(0),[U,B]=o.useState({}),[m,N]=o.useState("loading"),[O,T]=o.useState(0),[y,G]=o.useState(!1),[D,F]=o.useState({joined:0,pre_joined:0}),[z,j]=o.useState(!1),[g,u]=o.useState(null),c=o.useRef(null),h=o.useRef(!0),x=o.useRef([]),q=o.useRef(null);o.useEffect(()=>()=>{h.current=!1,c.current&&clearTimeout(c.current),q.current&&clearTimeout(q.current)},[]),o.useEffect(()=>()=>{try{l&&m==="active"&&g!=="completed"&&(r!=null&&r.id)&&b.from("quiz_participants").update({status:"completed"}).eq("user_id",r.id).eq("quiz_id",d).then(()=>{}).catch(()=>{})}catch(i){}},[l,d,m,g,r==null?void 0:r.id]);const v=o.useCallback(()=>{if(q.current||x.current.length===0)return;const i=x.current[0],n=2e3*Math.pow(2,(i.attempt||1)-1),s=Math.min(n,3e4);q.current=setTimeout(()=>{q.current=null,w()},s)},[]),w=o.useCallback(async()=>{if(x.current.length===0)return;const i=[...x.current];x.current=[];for(const n of i)if(!(!r||g==="completed"))try{const{error:s}=await b.from("user_answers").upsert({user_id:r.id,question_id:n.questionId,selected_option_id:n.optionId},{onConflict:"user_id,question_id"});if(s)throw s;B(a=>({...a,[n.questionId]:n.optionId}))}catch(s){const a=(n.attempt||1)+1;a<=6?x.current.push({...n,attempt:a}):t({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}x.current.length>0&&v()},[g,r,t,v]);o.useEffect(()=>{const i=()=>w(),n=()=>{ae()||w()};return window.addEventListener("online",i),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("online",i),document.removeEventListener("visibilitychange",n)}},[w]);const A=(D.joined||0)+(D.pre_joined||0),L=m==="active"?D.joined||0:A,E=o.useCallback(async()=>{const{data:i,error:n}=await b.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",d).order("id");W(n?[]:i||[])},[d]),$=o.useCallback(async()=>{var i,n;try{const{data:s,error:a}=await b.rpc("get_engagement_counts",{p_quiz_id:d});if(a)console.warn("Engagement counts fetch failed:",a),F({joined:0,pre_joined:0});else{const f=Array.isArray(s)?s[0]:s,S=Number((i=f==null?void 0:f.joined)!=null?i:0),k=Number((n=f==null?void 0:f.pre_joined)!=null?n:0);F({joined:isNaN(S)?0:S,pre_joined:isNaN(k)?0:k})}}catch(s){console.warn("Engagement refresh failed",s)}},[d]),Y=o.useCallback(async()=>{try{const{data:i,error:n}=await b.from("quizzes").select("*").eq("id",d).single();if(n||!i){t({title:"Error",description:"Quiz not found.",variant:"destructive"}),p("/");return}R(i);let s=null;if(r&&r.id){const{data:a,error:f}=await b.from("quiz_participants").select("status").eq("user_id",r.id).eq("quiz_id",d).maybeSingle();!f&&a?(s=a,j(!0),u(a.status||null),s.status==="completed"&&N("completed")):(j(!1),u(null))}else j(!1),u(null);s&&s.status!=="completed"&&await E(),await $()}catch(i){console.error("Error fetching quiz data:",i),t({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),p("/")}},[d,r,p,t,E,$]);o.useEffect(()=>{Y()},[Y]),o.useEffect(()=>{if(!l||m==="completed")return;const i=()=>{const s=new Date,a=l.start_time?new Date(l.start_time):null,f=l.end_time?new Date(l.end_time):null,S=a&&s<a,k=a&&f&&s>=a&&s<f;if(S){N("waiting"),T(Math.max(0,Math.round((a.getTime()-s.getTime())/1e3)));return}if(k){N("active"),T(Math.max(0,Math.round((f.getTime()-s.getTime())/1e3)));return}N("finished"),T(0)};i();const n=setInterval(i,1e3);return()=>clearInterval(n)},[l,m]),o.useEffect(()=>{if(!l||!(m==="waiting"||m==="active"))return;const n=setInterval(()=>{ae()||$()},xe);return()=>clearInterval(n)},[l,m,$]),o.useEffect(()=>{(async()=>{var n,s;if(l&&m==="active"&&r)try{if(!z||g==="pre_joined"){let a=!1,f=null;for(let S=0;S<2&&!a;S++){const{error:k}=await b.rpc("join_quiz",{p_quiz_id:d});if(!k){a=!0;break}f=k;const V=String(k.message||"").toLowerCase();if(V.includes("not active")){await new Promise(ce=>setTimeout(ce,1500));continue}if(V.includes("already")||V.includes("completed")){a=!0;break}break}if(a)j(!0),u("joined");else if(f){const{error:S}=await b.rpc("pre_join_quiz",{p_quiz_id:d});if(!S)j(!0),u("pre_joined");else throw f}}_.length===0&&await E()}catch(a){!((n=a==null?void 0:a.message)!=null&&n.includes("already"))&&!((s=a==null?void 0:a.message)!=null&&s.includes("completed"))&&console.error("Quiz join error:",a)}})()},[l,m,r,z,g,d,E,_.length,t]),o.useEffect(()=>{m==="finished"&&Object.keys(U).length>0&&!y&&Z()},[m]),o.useEffect(()=>{if(c.current&&(clearTimeout(c.current),c.current=null),!l||!l.end_time||!(m==="finished"||m==="completed"))return;const i=()=>{(async()=>{try{await K(b,d)}catch(n){}p(`/results/${d}`)})()};try{const n=new Date(l.end_time).getTime(),s=Date.now(),a=Math.max(0,n-s);a===0?i():c.current=setTimeout(()=>{c.current=null,i()},a)}catch(n){console.error("Error calculating redirect time:",n),c.current=setTimeout(()=>{c.current=null,i()},5e3)}return()=>{c.current&&(clearTimeout(c.current),c.current=null)}},[l,d,m,p]);const re=o.useCallback(async()=>{var i,n;if(l){if(!r){t({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),p("/login");return}if(g!=="completed"){try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!C&&await P()}catch(s){}try{const s=await ge({supabase:b,quiz:l,user:r});if(s.status==="error")throw s.error;s.status==="already"?(j(!0),u("joined"),t({title:"Already Joined",description:"Starting shortly."})):s.status==="joined"?(j(!0),u("joined"),t({title:"Joined!",description:"Starting now."})):s.status==="pre_joined"?(j(!0),u("pre_joined"),t({title:"Pre-joined!",description:"We will remind you before start."})):s.status==="scheduled_retry"&&(j(!0),u("pre_joined"),t({title:"Pre-joined!",description:"Auto join near start time."})),l.status==="active"&&(s.status==="joined"||s.status==="already")&&(await E(),N("active")),$()}catch(s){!((i=s==null?void 0:s.message)!=null&&i.includes("already"))&&!((n=s==null?void 0:s.message)!=null&&n.includes("completed"))&&(console.error("Join quiz error:",s),t({title:"Error",description:"Could not join quiz. Please try again.",variant:"destructive"}))}}}},[l,r,g,C,P,t,p,$,E,N]),oe=o.useCallback(async(i,n)=>{if(!(y||m!=="active"||g==="completed"))try{const{error:s}=await b.from("user_answers").upsert({user_id:r.id,question_id:i,selected_option_id:n},{onConflict:"user_id,question_id"});if(s)throw s;B(a=>({...a,[i]:n})),M<_.length-1&&(typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>J(a=>a+1)):setTimeout(()=>J(a=>a+1),250))}catch(s){console.error("Error saving answer:",s),x.current.some(f=>f.questionId===i)||t({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),x.current.push({questionId:i,optionId:n,attempt:1}),v()}},[y,m,g,r==null?void 0:r.id,M,_.length,t,v]),Z=o.useCallback(async()=>{if(!y){G(!0);try{const{error:i}=await b.from("quiz_participants").update({status:"completed"}).eq("user_id",r.id).eq("quiz_id",d);if(i)throw i;t({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),N("completed");try{await K(b,d)}catch(n){}p(`/results/${d}`)}catch(i){console.error("Error submitting quiz:",i),t({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{h.current&&G(!1)}}},[y,r==null?void 0:r.id,d,t,p]),le=o.useCallback(i=>{const n=Math.floor(i/60),s=i%60;return`${n.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},[]);return{quiz:l,questions:_,currentQuestionIndex:M,answers:U,quizState:m,timeLeft:O,submitting:y,engagement:D,joined:z,participantStatus:g,totalJoined:A,displayJoined:L,setCurrentQuestionIndex:J,handleJoinOrPrejoin:re,handleAnswerSelect:oe,handleSubmit:Z,formatTime:le}}const Ee=()=>{var g;const{id:d}=be(),p=we(),{quiz:t,questions:r,currentQuestionIndex:C,answers:P,quizState:l,timeLeft:R,submitting:_,joined:W,participantStatus:M,totalJoined:J,displayJoined:U,handleJoinOrPrejoin:B,handleAnswerSelect:m,handleSubmit:N,formatTime:O}=je(d,p),[T,y]=o.useState(null);o.useEffect(()=>{if(!(t!=null&&t.end_time)){y(null);return}if(!(l==="completed"||l==="finished")){y(null);return}const u=new Date(t.end_time).getTime(),c=()=>{const x=Math.max(0,u-Date.now());y(x)};c();const h=setInterval(c,1e3);return()=>clearInterval(h)},[t==null?void 0:t.end_time,l]);const G=()=>{if(!(t!=null&&t.end_time))return e.jsx("p",{className:"text-slate-300",children:"Results will be published soon."});const u=T!=null?T:Math.max(0,new Date(t.end_time).getTime()-Date.now()),c=Math.max(0,Math.floor(u/1e3)),h=Math.floor(c/86400),x=Math.floor(c%86400/3600),q=Math.floor(c%3600/60),v=c%60,w=({value:A,label:L})=>e.jsxs("div",{className:"px-3 py-2 rounded-md bg-slate-800/70 border border-slate-700 min-w-[64px]",children:[e.jsx("div",{className:"text-xl font-bold text-white tabular-nums",children:A.toString().padStart(2,"0")}),e.jsx("div",{className:"text-xs text-slate-400",children:L})]});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-slate-300",children:"Results will be published soon."}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[h>0&&e.jsx(w,{value:h,label:"Days"}),e.jsx(w,{value:x,label:"Hours"}),e.jsx(w,{value:q,label:"Minutes"}),e.jsx(w,{value:v,label:"Seconds"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Expected publish time: ",new Date(t.end_time).toLocaleString()]})]})};if(l==="loading"||!t)return e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx(H,{title:"Quiz – Loading | Quiz Dangal",description:"Loading quiz details.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"text-center",children:[e.jsx(ee,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})]});const D=()=>e.jsxs("div",{className:"mt-3 text-xs text-slate-300",children:[e.jsx("div",{className:"text-[11px] text-slate-400",children:t.start_time?pe(t.start_time):"—"}),e.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"Start"}),e.jsx("div",{children:t.start_time?I(t.start_time):"—"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"End"}),e.jsx("div",{children:t.end_time?I(t.end_time):"—"})]})]})]}),F=()=>{var w,A,L;const u=Array.isArray(t.prizes)?t.prizes:[],c=t.prize_type||"coins",h=(w=u[0])!=null?w:0,x=(A=u[1])!=null?A:0,q=(L=u[2])!=null?L:0,v=E=>he(c,E,{fallback:0}).formatted;return e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-700/30",children:["1st ",v(h)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-700/30",children:["2nd ",v(x)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-700/30",children:["3rd ",v(q)]})]})};if(!W&&l!=="completed"){const u=new Date,c=t.start_time?new Date(t.start_time):null,h=t.end_time?new Date(t.end_time):null,x=t.status==="active"&&c&&h&&u>=c&&u<h;return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(H,{title:`${t.title||"Quiz"} – Lobby | Quiz Dangal`,description:"Join the quiz lobby.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100 w-full",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?p(-1):p("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(te,{className:"h-5 w-5"})}),e.jsx(se,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:t.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:x?"Quiz is live!":"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:O(R)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),U," joined"]})}),e.jsx(F,{}),e.jsx(D,{}),e.jsx("div",{className:"mt-6",children:e.jsx(X,{onClick:B,className:x?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700",children:x?"Join & Start":"Pre-Join"})})]})]})}if(l==="waiting")return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(H,{title:`${t.title||"Quiz"} – Waiting | Quiz Dangal`,description:"Waiting for the quiz to start.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(Q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?p(-1):p("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(te,{className:"h-5 w-5"})}),e.jsx(se,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:t.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:O(R)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),J," joined"]})}),e.jsx(F,{}),e.jsx(D,{}),e.jsx("div",{className:"mt-4 text-xs text-slate-400",children:"We’ll auto-start when the timer hits zero."})]})]});if(l==="completed"||l==="finished")return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(H,{title:`${t.title||"Quiz"} – Completed | Quiz Dangal`,description:"Quiz completed. Results will be published soon.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(Q.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(ne,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-3",children:"Quiz Submitted Successfully!"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"Thank you for participating!"}),G(),e.jsx("div",{className:"mt-6",children:e.jsx(X,{onClick:()=>p("/"),className:"bg-indigo-600 hover:bg-indigo-700",children:"Back to Home"})})]})]});if(r.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const z=r[C],j=(C+1)/r.length*100;return e.jsxs("div",{className:"min-h-screen p-4 bg-[radial-gradient(1000px_600px_at_50%_-100px,rgba(59,130,246,0.25),transparent),radial-gradient(800px_500px_at_120%_0,rgba(168,85,247,0.18),transparent)]",children:[e.jsx(H,{title:`${t.title||"Quiz"} – Play | Quiz Dangal`,description:"Answer questions and compete to win.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(Q.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"rounded-2xl p-4 mb-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-extrabold text-white tracking-tight",children:t.title}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Question ",C+1," of ",r.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-black text-rose-300 tabular-nums",children:O(R)}),e.jsx("div",{className:"text-[10px] text-slate-400 uppercase tracking-wide",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-800/60 rounded-full h-2 mt-4 overflow-hidden",children:e.jsx(Q.div,{className:"h-2 rounded-full bg-[linear-gradient(90deg,#22d3ee,#818cf8,#a78bfa,#f472b6)]",style:{width:`${j}%`},transition:{duration:.5}})})]}),e.jsx(fe,{mode:"wait",children:e.jsxs(Q.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-16},transition:{duration:.25},className:"rounded-2xl p-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white mb-6 leading-relaxed",children:z.question_text}),e.jsx("div",{className:"space-y-3",children:(g=z.options)==null?void 0:g.map((u,c)=>{const h=P[z.id]===u.id;return e.jsxs(Q.button,{onClick:()=>m(z.id,u.id),disabled:_||l!=="active"||M==="completed",whileHover:{scale:1.01},whileTap:{scale:.99},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 border group relative overflow-hidden ${h?"bg-emerald-600/90 text-white border-emerald-400 shadow-[0_10px_24px_rgba(16,185,129,0.25)]":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700/80"}`,children:[e.jsxs("span",{className:`font-bold mr-3 ${h?"text-white":"text-indigo-300"}`,children:[String.fromCharCode(65+c),"."]}),u.option_text,!h&&e.jsx("span",{className:"absolute inset-y-0 right-0 w-0 group-hover:w-1/6 transition-[width] duration-200 bg-gradient-to-l from-indigo-500/20 to-transparent"})]},u.id)})}),C===r.length-1&&Object.keys(P).length===r.length&&e.jsx(Q.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},transition:{delay:.25},className:"mt-7",children:e.jsx(X,{onClick:N,disabled:_,className:"w-full text-white font-extrabold py-4 text-lg border border-violet-500/40 shadow-[0_8px_18px_rgba(139,92,246,0.35)] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)] bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]",children:_?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},z.id)})]})]})};export{Ee as default};
