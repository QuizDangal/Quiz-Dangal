import{l as p}from"./index-93c1c8bc.js";function z(t){var r,u,e,i,l,_,o,d,c,m;if(!t)return null;const a=Number((e=(u=(r=t.participants_joined)!=null?r:t.joined_count)!=null?u:t.joined)!=null?e:0),s=Number((_=(l=(i=t.participants_pre)!=null?i:t.pre_joined_count)!=null?l:t.pre_joined)!=null?_:0),n=Number((o=t.participants_total)!=null?o:a+s);return{slotId:t.id||t.slot_id||t.slotid||t.slotID||t.slot_uuid||t.slot_uuid_id||t.slot_uuid_ref||t.quiz_slot_id||t.quiz_slot_uuid||t.slot_uuid_value||t.slot_ref||t.slot_reference||t.slot||null,quizId:t.quiz_id||t.quizid||t.quiz_uuid||t.quiz_uuid_id||t.quiz||null,category:t.category||null,title:t.quiz_title||t.title||t.slot_title||null,start_time:t.start_time||t.slot_start||t.starts_at||null,end_time:t.end_time||t.slot_end||t.ends_at||null,status:t.status||"scheduled",prizes:Array.isArray(t.prizes)?t.prizes:Array.isArray(t.quiz_prizes)?t.quiz_prizes:[],questions:Array.isArray(t.questions)?t.questions:[],prize_type:t.prize_type||t.quiz_prize_type||"coins",participants_joined:a,participants_pre:s,participants_total:n,questions_count:Number((m=(c=(d=t.questions_count)!=null?d:t.question_count)!=null?c:t.q_count)!=null?m:0),auto_enabled:typeof t.auto_enabled=="boolean"?t.auto_enabled:void 0,stop_override:!!t.stop_override}}async function g(t,a){if(!t)return{slots:[],mode:"none",auto:!0};try{const{data:s,error:n}=await t.from("quiz_slots_view").select("*").eq("category",a).order("start_time",{ascending:!0});if(n)throw p.debug("quiz_slots_view error; fallback to quizzes",n.message||n),n;const r=(s||[]).map(z);let u=!0;try{const{data:e,error:i}=await t.from("category_runtime_overrides").select("category,auto_enabled:is_auto").eq("category",a).maybeSingle();!i&&e&&(u=!!e.auto_enabled)}catch(e){}return{slots:r,mode:"slots",auto:u}}catch(s){try{const{data:n,error:r}=await t.from("quizzes").select("id,title,start_time,end_time,status,prizes,prize_type").eq("category",a).order("start_time",{ascending:!0});if(r)throw r;const u=Date.now();return{slots:(n||[]).map(i=>({slotId:i.id,quizId:i.id,category:a,start_time:i.start_time,end_time:i.end_time,status:f(i,u),prizes:Array.isArray(i.prizes)?i.prizes:[],prize_type:i.prize_type||"coins",participants_joined:0,participants_total:0,auto_enabled:!0})),mode:"legacy",auto:!0}}catch(n){return p.error("Legacy fallback failed",n.message||n),{slots:[],mode:"error",auto:!0}}}}function f(t,a){const s=t.start_time?new Date(t.start_time).getTime():null,n=t.end_time?new Date(t.end_time).getTime():null;return s&&n&&a>=s&&a<n?"active":s&&a<s?"scheduled":n&&a>=n?"finished":"scheduled"}function q(t){const a=Date.now(),s=t.find(e=>{const i=e!=null&&e.start_time?new Date(e.start_time).getTime():null,l=e!=null&&e.end_time?new Date(e.end_time).getTime():null;return i&&l&&a>=i&&a<l}),n=t.filter(e=>{const i=e!=null&&e.start_time?new Date(e.start_time).getTime():null;return i?a<i:!1});n.sort((e,i)=>new Date(e.start_time).getTime()-new Date(i.start_time).getTime());const r=n[0]||null,u=n[1]||null;return{live:s,next:r,queued:u}}export{q as c,g as f};
