import{z as oe,j as a,P,A as le,C,o as I,u as ie,e as ce,D as ue,t as de,v as me,w as fe,B as pe}from"./index-ead586f9.js";import{r as d}from"./react-63c462fe.js";import{L as k,I as D}from"./label-548aa5e8.js";import{m as he,L as ve}from"./icons-1e9e0bae.js";import"./supabase-07ebd5d8.js";import"./router-d6d570a4.js";var M={exports:{}},B={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var S=d;function be(e,t){return e===t&&(e!==0||1/e===1/t)||e!==e&&t!==t}var xe=typeof Object.is=="function"?Object.is:be,ge=S.useState,we=S.useEffect,ye=S.useLayoutEffect,je=S.useDebugValue;function Se(e,t){var n=t(),l=ge({inst:{value:n,getSnapshot:t}}),r=l[0].inst,s=l[1];return ye(function(){r.value=n,r.getSnapshot=t,L(r)&&s({inst:r})},[e,n,t]),we(function(){return L(r)&&s({inst:r}),e(function(){L(r)&&s({inst:r})})},[e]),je(n),n}function L(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!xe(e,n)}catch(l){return!0}}function Ne(e,t){return t()}var _e=typeof window=="undefined"||typeof window.document=="undefined"||typeof window.document.createElement=="undefined"?Ne:Se;B.useSyncExternalStore=S.useSyncExternalStore!==void 0?S.useSyncExternalStore:_e;M.exports=B;var Ae=M.exports;function Ue(){return Ae.useSyncExternalStore(Ee,()=>!0,()=>!1)}function Ee(){return()=>{}}var R="Avatar",[Le,Be]=oe(R),[Ce,q]=Le(R),z=d.forwardRef((e,t)=>{const{__scopeAvatar:n,...l}=e,[r,s]=d.useState("idle");return a.jsx(Ce,{scope:n,imageLoadingStatus:r,onImageLoadingStatusChange:s,children:a.jsx(P.span,{...l,ref:t})})});z.displayName=R;var O="AvatarImage",H=d.forwardRef((e,t)=>{const{__scopeAvatar:n,src:l,onLoadingStatusChange:r=()=>{},...s}=e,y=q(O,n),h=Pe(l,s),b=le(g=>{r(g),y.onImageLoadingStatusChange(g)});return C(()=>{h!=="idle"&&b(h)},[h,b]),h==="loaded"?a.jsx(P.img,{...s,ref:t,src:l}):null});H.displayName=O;var V="AvatarFallback",G=d.forwardRef((e,t)=>{const{__scopeAvatar:n,delayMs:l,...r}=e,s=q(V,n),[y,h]=d.useState(l===void 0);return d.useEffect(()=>{if(l!==void 0){const b=window.setTimeout(()=>h(!0),l);return()=>window.clearTimeout(b)}},[l]),y&&s.imageLoadingStatus!=="loaded"?a.jsx(P.span,{...r,ref:t}):null});G.displayName=V;function F(e,t){return e?t?(e.src!==t&&(e.src=t),e.complete&&e.naturalWidth>0?"loaded":"loading"):"error":"idle"}function Pe(e,{referrerPolicy:t,crossOrigin:n}){const l=Ue(),r=d.useRef(null),s=l?(r.current||(r.current=new window.Image),r.current):null,[y,h]=d.useState(()=>F(s,e));return C(()=>{h(F(s,e))},[s,e]),C(()=>{const b=N=>()=>{h(N)};if(!s)return;const g=b("loaded"),m=b("error");return s.addEventListener("load",g),s.addEventListener("error",m),t&&(s.referrerPolicy=t),typeof n=="string"&&(s.crossOrigin=n),()=>{s.removeEventListener("load",g),s.removeEventListener("error",m)}},[s,n,t]),y}var W=z,Y=H,K=G;const Z=d.forwardRef(({className:e,...t},n)=>a.jsx(W,{ref:n,className:I("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",e),...t}));Z.displayName=W.displayName;const J=d.forwardRef(({className:e,...t},n)=>a.jsx(Y,{ref:n,className:I("aspect-square h-full w-full",e),...t}));J.displayName=Y.displayName;const Q=d.forwardRef(({className:e,...t},n)=>a.jsx(K,{ref:n,className:I("flex h-full w-full items-center justify-center rounded-full bg-muted",e),...t}));Q.displayName=K.displayName;const Ie=({isOpen:e,onClose:t,isFirstTime:n=!1})=>{const{user:l,userProfile:r,supabase:s,refreshUserProfile:y}=ie(),{toast:h}=ce(),[b,g]=d.useState(!1),[m,N]=d.useState({username:"",mobile_number:"",avatar_url:""}),[f,j]=d.useState({}),[$,T]=d.useState(null),[X,E]=d.useState("");d.useEffect(()=>{let o=!1;const c=u=>{if(!u)return"";try{if(!/^https?:\/\//i.test(u))return u.replace(/^\/+/,"");const i=u.match(/\/storage\/v1\/object\/(?:public|sign)\/avatars\/(.+)$/);return i&&i[1]?decodeURIComponent(i[1]):u}catch(i){return u}},p=async u=>{var _,A,w;const i=c(u);if(/^https?:\/\//i.test(i)&&!/\/storage\/v1\/object\//.test(i))return i;try{const x=(A=(_=s==null?void 0:s.storage)==null?void 0:_.from("avatars"))==null?void 0:A.getPublicUrl(i),U=(w=x==null?void 0:x.data)==null?void 0:w.publicUrl;if(U)return U}catch(x){}try{const{data:x,error:U}=await s.storage.from("avatars").createSignedUrl(i,3600);if(U)throw U;return(x==null?void 0:x.signedUrl)||""}catch(x){return console.warn("Avatar preview fetch failed:",x),""}};return(async()=>{if(r)if(N({username:r.username||"",mobile_number:r.mobile_number||"",avatar_url:r.avatar_url||""}),r.avatar_url&&s){const u=await p(r.avatar_url);o||E(u)}else E("")})(),()=>{o=!0}},[r,s]);const ee=()=>{const o={};return m.username.trim()?m.username.length<3?o.username="Username must be at least 3 characters":/^[a-zA-Z0-9_]+$/.test(m.username)||(o.username="Username can only contain letters, numbers, and underscores"):o.username="Username is required",m.mobile_number.trim()?/^[6-9]\d{9}$/.test(m.mobile_number)||(o.mobile_number="Please enter a valid 10-digit mobile number"):o.mobile_number="Mobile number is required",j(o),Object.keys(o).length===0},ae=async o=>{if(!o||o===(r==null?void 0:r.username))return!0;try{const{data:c,error:p}=await s.rpc("is_username_available",{p_username:o,p_exclude:l.id});return p?(console.error("Username check error:",p),!0):!!c}catch(c){return console.error("Username availability check failed:",c),!0}},te=async o=>{var A;const c=o.name.split(".").pop(),p=`${l.id}-${Date.now()}.${c}`,v=`${l.id}/${p}`,{error:u}=await s.storage.from("avatars").upload(v,o,{upsert:!0});if(u)throw u;try{const w=s.storage.from("avatars").getPublicUrl(v);if((A=w==null?void 0:w.data)!=null&&A.publicUrl)return{path:v,previewUrl:w.data.publicUrl}}catch(w){}const{data:i,error:_}=await s.storage.from("avatars").createSignedUrl(v,3600);if(_)throw _;return{path:v,previewUrl:(i==null?void 0:i.signedUrl)||""}},re=o=>{const c=o.target.files[0];if(c){if(c.size>5*1024*1024){j({...f,avatar:"File size must be less than 5MB"});return}if(!c.type.startsWith("image/")){j({...f,avatar:"Only image files are allowed"});return}T(c);const p=new FileReader;p.onload=u=>E(u.target.result),p.readAsDataURL(c);const v={...f};delete v.avatar,j(v)}},se=async o=>{if(o.preventDefault(),!!ee()){g(!0);try{if(!await ae(m.username)){j({username:"Username is already taken"}),g(!1);return}let p=m.avatar_url;if($)try{const i=await te($);p=i.path,i.previewUrl&&E(i.previewUrl)}catch(i){console.error("Avatar upload failed:",i)}const v={username:m.username.trim(),mobile_number:m.mobile_number.trim(),avatar_url:p,is_profile_complete:!0},{error:u}=await s.from("profiles").update(v).eq("id",l.id);if(u)throw u;h({title:"Profile updated",description:"Your profile has been saved successfully."}),await y(l),t()}catch(c){console.error("Profile update error:",c),j({submit:c.message||"Failed to update profile"})}finally{g(!1)}}},ne=()=>((r==null?void 0:r.full_name)||(r==null?void 0:r.username)||(l==null?void 0:l.email)||"").split(" ").map(c=>c[0]).join("").toUpperCase().slice(0,2);return a.jsx(ue,{open:e,onOpenChange:n?void 0:t,children:a.jsxs(de,{className:"sm:max-w-md app-surface border border-white/10 bg-slate-900/60",overlayClassName:"bg-black/60 backdrop-blur-sm",closeButton:!n,children:[a.jsxs(me,{children:[a.jsx(fe,{className:"text-center heading-gradient text-2xl font-extrabold",children:n?"Complete Your Profile":"Edit Profile"}),n&&a.jsx("p",{className:"text-sm text-white/70 text-center",children:"Please complete your profile to continue"})]}),a.jsx("div",{className:"subtle-divider my-2"}),a.jsxs("form",{onSubmit:se,className:"space-y-4",children:[a.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[a.jsxs("div",{className:"relative",children:[a.jsxs(Z,{className:"w-20 h-20 ring-1 ring-white/15 shadow-md",children:[a.jsx(J,{src:X}),a.jsx(Q,{className:"text-lg bg-slate-800 text-white",children:ne()})]}),a.jsx("label",{htmlFor:"avatar-upload","aria-label":"Change profile photo",className:"absolute bottom-0 right-0 bg-slate-900/80 border border-white/10 text-white p-1.5 rounded-full cursor-pointer hover:bg-slate-900/90 shadow transition-colors",children:a.jsx(he,{className:"w-3 h-3","aria-hidden":"true"})}),a.jsx("input",{id:"avatar-upload",type:"file",accept:"image/*",onChange:re,className:"sr-only"})]}),a.jsx("p",{className:"text-xs text-white/60",children:"Click camera to change photo"}),f.avatar&&a.jsx("p",{className:"text-xs text-red-400",children:f.avatar})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs(k,{htmlFor:"username",className:"text-white/90",children:["Username ",a.jsx("span",{className:"text-red-400",children:"*"})]}),a.jsx(D,{id:"username",value:m.username,onChange:o=>N({...m,username:o.target.value}),placeholder:"Enter unique username",className:`bg-slate-900/60 border-white/10 text-white placeholder:text-white/50 ${f.username?"border-red-500":""}`}),f.username&&a.jsx("p",{className:"text-xs text-red-400",children:f.username})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs(k,{htmlFor:"mobile",className:"text-white/90",children:["Mobile Number ",a.jsx("span",{className:"text-red-400",children:"*"})]}),a.jsx(D,{id:"mobile",type:"tel",value:m.mobile_number,onChange:o=>N({...m,mobile_number:o.target.value}),placeholder:"Enter 10-digit mobile number",className:`bg-slate-900/60 border-white/10 text-white placeholder:text-white/50 ${f.mobile_number?"border-red-500":""}`}),f.mobile_number&&a.jsx("p",{className:"text-xs text-red-400",children:f.mobile_number})]}),f.submit&&a.jsx("p",{className:"text-sm text-red-400 text-center",children:f.submit}),a.jsx(pe,{type:"submit",className:"w-full",variant:"brand",size:"lg",disabled:b,children:b?a.jsxs(a.Fragment,{children:[a.jsx(ve,{className:"w-4 h-4 mr-2 animate-spin"}),n?"Completing Profile...":"Updating Profile..."]}):n?"Complete Profile":"Update Profile"})]})]})})},qe=Ie;export{qe as default};
