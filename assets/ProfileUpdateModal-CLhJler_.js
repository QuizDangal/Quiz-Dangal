import{j as e,H as le,I as $,J as ue,K as k,w as D,u as ce,e as de,D as me,z as fe,C as pe,E as he,B as ve,s as U,l as P}from"./index-BlrZjynR.js";import{r as p}from"./router-D53U3OCX.js";import{L as M,I as B}from"./label-DfJWw_ga.js";import{r as be}from"./react-DQQtrPfG.js";import{p as xe,L as ge}from"./icons-DXR8YHNI.js";import"./supabase-BMIB7Fuo.js";var R={exports:{}},I={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var z;function we(){if(z)return I;z=1;var t=be();function n(a,u){return a===u&&(a!==0||1/a===1/u)||a!==a&&u!==u}var o=typeof Object.is=="function"?Object.is:n,i=t.useState,r=t.useEffect,l=t.useLayoutEffect,g=t.useDebugValue;function v(a,u){var w=u(),E=i({inst:{value:w,getSnapshot:u}}),y=E[0].inst,N=E[1];return l(function(){y.value=w,y.getSnapshot=u,h(y)&&N({inst:y})},[a,w,u]),r(function(){return h(y)&&N({inst:y}),a(function(){h(y)&&N({inst:y})})},[a]),g(w),w}function h(a){var u=a.getSnapshot;a=a.value;try{var w=u();return!o(a,w)}catch(E){return!0}}function c(a,u){return u()}var j=typeof window=="undefined"||typeof window.document=="undefined"||typeof window.document.createElement=="undefined"?c:v;return I.useSyncExternalStore=t.useSyncExternalStore!==void 0?t.useSyncExternalStore:j,I}var O;function ye(){return O||(O=1,R.exports=we()),R.exports}var Se=ye();function je(){return Se.useSyncExternalStore(Ne,()=>!0,()=>!1)}function Ne(){return()=>{}}var F="Avatar",[_e]=le(F),[Ue,V]=_e(F),G=p.forwardRef((t,n)=>{const{__scopeAvatar:o,...i}=t,[r,l]=p.useState("idle");return e.jsx(Ue,{scope:o,imageLoadingStatus:r,onImageLoadingStatusChange:l,children:e.jsx($.span,{...i,ref:n})})});G.displayName=F;var K="AvatarImage",W=p.forwardRef((t,n)=>{const{__scopeAvatar:o,src:i,onLoadingStatusChange:r=()=>{},...l}=t,g=V(K,o),v=Ee(i,l),h=ue(c=>{r(c),g.onImageLoadingStatusChange(c)});return k(()=>{v!=="idle"&&h(v)},[v,h]),v==="loaded"?e.jsx($.img,{...l,ref:n,src:i}):null});W.displayName=K;var Y="AvatarFallback",J=p.forwardRef((t,n)=>{const{__scopeAvatar:o,delayMs:i,...r}=t,l=V(Y,o),[g,v]=p.useState(i===void 0);return p.useEffect(()=>{if(i!==void 0){const h=window.setTimeout(()=>v(!0),i);return()=>window.clearTimeout(h)}},[i]),g&&l.imageLoadingStatus!=="loaded"?e.jsx($.span,{...r,ref:n}):null});J.displayName=Y;function H(t,n){return t?n?(t.src!==n&&(t.src=n),t.complete&&t.naturalWidth>0?"loaded":"loading"):"error":"idle"}function Ee(t,{referrerPolicy:n,crossOrigin:o}){const i=je(),r=p.useRef(null),l=i?(r.current||(r.current=new window.Image),r.current):null,[g,v]=p.useState(()=>H(l,t));return k(()=>{v(H(l,t))},[l,t]),k(()=>{const h=a=>()=>{v(a)};if(!l)return;const c=h("loaded"),j=h("error");return l.addEventListener("load",c),l.addEventListener("error",j),n&&(l.referrerPolicy=n),typeof o=="string"&&(l.crossOrigin=o),()=>{l.removeEventListener("load",c),l.removeEventListener("error",j)}},[l,o,n]),g}var Z=G,Q=W,T=J;const X=p.forwardRef(({className:t,...n},o)=>e.jsx(Z,{ref:o,className:D("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",t),...n}));X.displayName=Z.displayName;const ee=p.forwardRef(({className:t,...n},o)=>e.jsx(Q,{ref:o,className:D("aspect-square h-full w-full",t),...n}));ee.displayName=Q.displayName;const ae=p.forwardRef(({className:t,...n},o)=>e.jsx(T,{ref:o,className:D("flex h-full w-full items-center justify-center rounded-full bg-muted",t),...n}));ae.displayName=T.displayName;const ke=({isOpen:t,onClose:n,isFirstTime:o=!1})=>{const{user:i,userProfile:r,refreshUserProfile:l}=ce(),{toast:g}=de(),[v,h]=p.useState(!1),[c,j]=p.useState({username:"",mobile_number:"",avatar_url:""}),[a,u]=p.useState({}),[w,E]=p.useState(null),[y,N]=p.useState("");p.useEffect(()=>{let s=!1;const m=f=>{if(!f)return"";try{if(!/^https?:\/\//i.test(f))return f.replace(/^\/+/,"");const d=f.match(/\/storage\/v1\/object\/(?:public|sign)\/avatars\/(.+)$/);return d&&d[1]?decodeURIComponent(d[1]):f}catch(d){return f}},b=async f=>{var A,L,_,q;const d=m(f);if(/^https?:\/\//i.test(d)&&!/\/storage\/v1\/object\//.test(d))return d;try{const S=(_=(L=(A=U)==null?void 0:A.storage)==null?void 0:L.from("avatars"))==null?void 0:_.getPublicUrl(d),C=(q=S==null?void 0:S.data)==null?void 0:q.publicUrl;if(C)return C}catch(S){}try{const{data:S,error:C}=await U.storage.from("avatars").createSignedUrl(d,3600);if(C)throw C;return(S==null?void 0:S.signedUrl)||""}catch(S){return""}};return(async()=>{if(r)if(j({username:r.username||"",mobile_number:r.mobile_number||"",avatar_url:r.avatar_url||""}),r.avatar_url&&U){const f=await b(r.avatar_url);s||N(f)}else N("")})(),()=>{s=!0}},[r]);const te=()=>{const s={};return c.username.trim()?c.username.length<3?s.username="Username must be at least 3 characters":/^[a-zA-Z0-9_]+$/.test(c.username)||(s.username="Username can only contain letters, numbers, and underscores"):s.username="Username is required",c.mobile_number.trim()?/^[6-9]\d{9}$/.test(c.mobile_number)||(s.mobile_number="Please enter a valid 10-digit mobile number"):s.mobile_number="Mobile number is required",u(s),Object.keys(s).length===0},re=async s=>{if(!s||s===(r==null?void 0:r.username))return!0;try{const{data:m,error:b}=await U.rpc("is_username_available",{p_username:s,p_exclude:i.id});return b?(P.error("Username check error:",b),u(x=>({...x,username:"Unable to verify username. Please try again."})),!1):!!m}catch(m){return P.error("Username availability check failed:",m),u(b=>({...b,username:"Unable to verify username. Please try again."})),!1}},se=async s=>{var L;const m=s.name.split(".").pop(),b=`${i.id}-${Date.now()}.${m}`,x=`${i.id}/${b}`,{error:f}=await U.storage.from("avatars").upload(x,s,{upsert:!0});if(f)throw f;try{const _=U.storage.from("avatars").getPublicUrl(x);if((L=_==null?void 0:_.data)!=null&&L.publicUrl)return{path:x,previewUrl:_.data.publicUrl}}catch(_){}const{data:d,error:A}=await U.storage.from("avatars").createSignedUrl(x,3600);if(A)throw A;return{path:x,previewUrl:(d==null?void 0:d.signedUrl)||""}},ne=s=>{const m=s.target.files[0];if(m){if(m.size>5*1024*1024){u({...a,avatar:"File size must be less than 5MB"});return}if(!m.type.startsWith("image/")){u({...a,avatar:"Only image files are allowed"});return}E(m);const b=new FileReader;b.onload=f=>N(f.target.result),b.readAsDataURL(m);const x={...a};delete x.avatar,u(x)}},oe=async s=>{if(s.preventDefault(),!!te()){h(!0);try{if(!await re(c.username)){u({username:"Username is already taken"}),h(!1);return}let b=c.avatar_url;if(w)try{const d=await se(w);b=d.path,d.previewUrl&&N(d.previewUrl)}catch(d){P.error("Avatar upload failed:",d),g({title:"Avatar upload failed",description:"Profile will be saved without the new photo. Please try again later.",variant:"destructive"})}const x={username:c.username.trim(),mobile_number:c.mobile_number.trim(),avatar_url:b,is_profile_complete:!0},{error:f}=await U.from("profiles").update(x).eq("id",i.id);if(f)throw f;g({title:"Profile updated",description:"Your profile has been saved successfully."}),await l(i),n()}catch(m){P.error("Profile update error:",m),u({submit:m.message||"Failed to update profile"})}finally{h(!1)}}},ie=()=>((r==null?void 0:r.full_name)||(r==null?void 0:r.username)||(i==null?void 0:i.email)||"").split(" ").map(m=>m[0]).join("").toUpperCase().slice(0,2);return e.jsx(me,{open:t,onOpenChange:o?void 0:n,children:e.jsxs(fe,{className:"sm:max-w-md app-surface border border-white/10 bg-slate-900/60",overlayClassName:"bg-black/60 backdrop-blur-sm",closeButton:!o,children:[e.jsxs(pe,{children:[e.jsx(he,{className:"text-center heading-gradient text-2xl font-extrabold",children:o?"Complete Your Profile":"Edit Profile"}),o&&e.jsx("p",{className:"text-sm text-white/70 text-center",children:"Please complete your profile to continue"})]}),e.jsx("div",{className:"subtle-divider my-2"}),e.jsxs("form",{onSubmit:oe,className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(X,{className:"w-20 h-20 ring-1 ring-white/15 shadow-md",children:[e.jsx(ee,{src:y}),e.jsx(ae,{className:"text-lg bg-slate-800 text-white",children:ie()})]}),e.jsx("label",{htmlFor:"avatar-upload","aria-label":"Change profile photo",className:"absolute bottom-0 right-0 bg-slate-900/80 border border-white/10 text-white p-1.5 rounded-full cursor-pointer hover:bg-slate-900/90 shadow transition-colors",children:e.jsx(xe,{className:"w-3 h-3","aria-hidden":"true"})}),e.jsx("input",{id:"avatar-upload",type:"file",accept:"image/*",onChange:ne,className:"sr-only"})]}),e.jsx("p",{className:"text-xs text-white/60",children:"Click camera to change photo"}),a.avatar&&e.jsx("p",{className:"text-xs text-red-400",children:a.avatar})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(M,{htmlFor:"username",className:"text-white/90",children:["Username ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(B,{id:"username",value:c.username,onChange:s=>j({...c,username:s.target.value}),placeholder:"Enter unique username",className:`bg-slate-900/60 border-white/10 text-white placeholder:text-white/50 ${a.username?"border-red-500":""}`}),a.username&&e.jsx("p",{className:"text-xs text-red-400",children:a.username})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(M,{htmlFor:"mobile",className:"text-white/90",children:["Mobile Number ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(B,{id:"mobile",type:"tel",value:c.mobile_number,onChange:s=>j({...c,mobile_number:s.target.value}),placeholder:"Enter 10-digit mobile number",className:`bg-slate-900/60 border-white/10 text-white placeholder:text-white/50 ${a.mobile_number?"border-red-500":""}`}),a.mobile_number&&e.jsx("p",{className:"text-xs text-red-400",children:a.mobile_number})]}),a.submit&&e.jsx("p",{className:"text-sm text-red-400 text-center",children:a.submit}),e.jsx(ve,{type:"submit",className:"w-full",variant:"brand",size:"lg",disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-4 h-4 mr-2 animate-spin"}),o?"Completing Profile...":"Updating Profile..."]}):o?"Complete Profile":"Update Profile"})]})]})})};export{ke as default};
