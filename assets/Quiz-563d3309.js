import{e as Ee,u as Te,k as ke,s as h,l as de,Q as ze,m as ue,b as me,j as e,B as he,f as Ce,d as fe,g as Qe}from"./index-0d76935a.js";import{r as c}from"./react-63c462fe.js";import{s as De,f as qe}from"./slots-20ab4398.js";import{m as H,AnimatePresence as Ae}from"./motion-lite-3d667e23.js";import{S as I}from"./SEO-df0e0754.js";import{k as ge,X as be,b as oe,c as je,s as ye}from"./icons-2bdec3f2.js";import{c as Le,u as Pe,b as Re}from"./router-d6d570a4.js";import"./supabase-07ebd5d8.js";function xe(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function $e(n,m,y={}){const{slotId:l=null}=y,{toast:o}=Ee(),{user:d}=Te(),{isSubscribed:a,subscribeToPush:_}=ke(),[u,C]=c.useState(null),[q,P]=c.useState([]),[g,x]=c.useState(0),[S,U]=c.useState({}),[p,b]=c.useState("loading"),[X,B]=c.useState(0),[w,ee]=c.useState(null),[V,ne]=c.useState(!1),[re,ae]=c.useState(!!l),W=c.useCallback(t=>{var s,f,j,z,M,ie;const r=Number((j=(f=(s=t==null?void 0:t.participants_joined)!=null?s:t==null?void 0:t.joined_count)!=null?f:t==null?void 0:t.joined)!=null?j:0),i=Number((ie=(M=(z=t==null?void 0:t.participants_pre)!=null?z:t==null?void 0:t.pre_joined_count)!=null?M:t==null?void 0:t.pre_joined)!=null?ie:0);return{joined:Number.isFinite(r)?r:0,pre_joined:Number.isFinite(i)?i:0}},[]),R=c.useCallback(async()=>{if(!(!l||!h))try{const{data:t,error:r}=await h.from("quiz_slots_view").select("*").eq("id",l).maybeSingle();!r&&t&&(ee(t),ne(t.status==="paused"),F(W(t)))}catch(t){}finally{ae(!1)}},[l,W]);c.useEffect(()=>{R();const t=l?setInterval(R,3e4):null;return()=>{t&&clearInterval(t)}},[R,l]);const[$,Y]=c.useState(!1),[A,F]=c.useState({joined:0,pre_joined:0}),[G,E]=c.useState(!1),[v,T]=c.useState(null),N=c.useRef(null),Z=c.useRef(!0),Q=c.useRef([]),O=c.useRef(null);c.useEffect(()=>()=>{Z.current=!1,N.current&&clearTimeout(N.current),O.current&&clearTimeout(O.current)},[]);const K=c.useRef({});c.useEffect(()=>{K.current=S},[S]),c.useEffect(()=>()=>{try{const t=Object.keys(K.current).length>0;if(u&&p==="active"&&v!=="completed"&&(d!=null&&d.id)&&t){let r=h.from("quiz_participants").update({status:"completed"}).eq("user_id",d.id);l?r=r.eq("slot_id",l):r=r.eq("quiz_id",n),r.then(()=>{}).catch(()=>{})}}catch(t){}},[u,n,p,v,d==null?void 0:d.id]);const k=c.useCallback(()=>{if(O.current||Q.current.length===0)return;const t=Q.current[0],r=2e3*Math.pow(2,(t.attempt||1)-1),i=Math.min(r,3e4);O.current=setTimeout(()=>{O.current=null,L()},i)},[]),L=c.useCallback(async()=>{if(Q.current.length===0)return;const t=[...Q.current];Q.current=[];for(const r of t)if(!(!d||v==="completed"))try{const{error:i}=await h.from("user_answers").upsert({user_id:d.id,question_id:r.questionId,selected_option_id:r.optionId},{onConflict:"user_id,question_id"});if(i)throw i;U(s=>({...s,[r.questionId]:r.optionId}))}catch(i){const s=(r.attempt||1)+1;s<=6?Q.current.push({...r,attempt:s}):o({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}Q.current.length>0&&k()},[v,d,o,k]);c.useEffect(()=>{const t=()=>L(),r=()=>{xe()||L()};return window.addEventListener("online",t),document.addEventListener("visibilitychange",r),()=>{window.removeEventListener("online",t),document.removeEventListener("visibilitychange",r)}},[L]);const te=(A.joined||0)+(A.pre_joined||0),se=p==="active"?A.joined||0:te,D=c.useCallback(async(t=null)=>{const r=t||(u==null?void 0:u.id)||n||l;if(r)try{const{data:i,error:s}=await h.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",r).order("id");if(s){console.error("Questions fetch error:",s),de.error("Failed to load questions",s.message),P([]);return}if(!i||i.length===0){de.warn("No questions found for quiz",r),P([]);return}P(i)}catch(i){console.error("Questions load exception:",i),P([])}},[u==null?void 0:u.id,n,l]),J=c.useCallback(async()=>{var t,r;if(l){if(w){F(W(w));return}await R();return}if(!n){F({joined:0,pre_joined:0});return}try{const{data:i,error:s}=await h.rpc("get_engagement_counts",{p_quiz_id:n});if(s)console.warn("Engagement counts fetch failed:",s),F({joined:0,pre_joined:0});else{const f=Array.isArray(i)?i[0]:i,j=Number((t=f==null?void 0:f.joined)!=null?t:0),z=Number((r=f==null?void 0:f.pre_joined)!=null?r:0);F({joined:isNaN(j)?0:j,pre_joined:isNaN(z)?0:z})}}catch(i){console.warn("Engagement refresh failed",i)}},[n,l,w,R,W]),le=c.useCallback(async()=>{try{let t=null;if(l){const{data:s,error:f}=await h.from("quiz_slots_view").select("*").eq("id",l).maybeSingle();if(f||!s){o({title:"Error",description:"Quiz slot not found.",variant:"destructive"}),m("/");return}t={id:s.quiz_id||s.id,slotId:s.id,title:s.quiz_title,category:s.category,start_time:s.start_time,end_time:s.end_time,status:s.status,prizes:s.prizes,prize_type:"coins",questions:s.questions},ee(s)}else{const{data:s,error:f}=await h.from("quizzes").select("*").eq("id",n).single();if(f||!s){o({title:"Error",description:"Quiz not found.",variant:"destructive"}),m("/");return}t=s}C(t);const r=(t==null?void 0:t.id)||n;let i=null;if(d&&d.id&&r){let s=null,f=null;if(l){const j=await h.from("quiz_participants").select("status").eq("user_id",d.id).eq("slot_id",l).maybeSingle();s=j.data,f=j.error}else{const j=await h.from("quiz_participants").select("status").eq("user_id",d.id).eq("quiz_id",r).maybeSingle();s=j.data,f=j.error}!f&&s?(i=s,E(!0),T(s.status||null),i.status==="completed"&&b("completed")):(E(!1),T(null))}else E(!1),T(null);i&&i.status!=="completed"&&await D(t==null?void 0:t.id),await J()}catch(t){console.error("Error fetching quiz data:",t),o({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),m("/")}},[n,l,d,m,o,D,J]);c.useEffect(()=>{le()},[le]),c.useEffect(()=>{if(!u||p==="completed")return;const t=()=>{const i=new Date,s=w!=null&&w.start_time?new Date(w.start_time):u.start_time?new Date(u.start_time):null,f=w!=null&&w.end_time?new Date(w.end_time):u.end_time?new Date(u.end_time):null,j=s&&i<s,z=s&&f&&i>=s&&i<f;if(V){b("waiting"),B(j&&s?Math.max(0,Math.round((s.getTime()-i.getTime())/1e3)):z&&f?Math.max(0,Math.round((f.getTime()-i.getTime())/1e3)):0);return}if(j){b("waiting"),B(Math.max(0,Math.round((s.getTime()-i.getTime())/1e3)));return}if(z){b("active"),B(Math.max(0,Math.round((f.getTime()-i.getTime())/1e3)));return}b("finished"),B(0)};t();const r=setInterval(t,1e3);return()=>clearInterval(r)},[u,p,w,V]),c.useEffect(()=>{if(!u||!(p==="waiting"||p==="active"))return;const r=setInterval(()=>{xe()||J()},ze);return()=>clearInterval(r)},[u,p,J]),c.useEffect(()=>{(async()=>{var r,i;if(u&&p==="active"&&d&&!(l&&V))try{if(!G||v==="pre_joined"){let s=!1,f=null;for(let j=0;j<2&&!s;j++){const{error:z}=l?await h.rpc("join_slot",{p_slot_id:l}):await h.rpc("join_quiz",{p_quiz_id:n});if(!z){s=!0;break}f=z;const M=String(z.message||"").toLowerCase();if(M.includes("not active")||M.includes("not ready")){await new Promise(ie=>setTimeout(ie,1500));continue}if(M.includes("already")||M.includes("completed")){s=!0;break}if(M.includes("ended")||M.includes("has ended")){b("finished");break}break}if(s)E(!0),T("joined");else if(f){const{error:j}=l?await h.rpc("pre_join_slot",{p_slot_id:l}):await h.rpc("pre_join_quiz",{p_quiz_id:n});if(!j)E(!0),T("pre_joined");else throw f}}q.length===0&&await D(u==null?void 0:u.id)}catch(s){if(!((r=s==null?void 0:s.message)!=null&&r.includes("already"))&&!((i=s==null?void 0:s.message)!=null&&i.includes("completed"))){const f=ue(s);console.error("Quiz join error:",f,s)}}})()},[u,p,d,G,v,n,l,V,D,q.length,o]),c.useEffect(()=>{const t=Object.keys(S).length>0;p==="finished"&&t&&v==="joined"&&!$&&ce()},[p]),c.useEffect(()=>{if(N.current&&(clearTimeout(N.current),N.current=null),!u||!u.end_time||!(p==="finished"||p==="completed"))return;const t=()=>{(async()=>{try{await me(h,n)}catch(r){}m(`/results/${n}`)})()};try{const r=new Date(u.end_time).getTime(),i=Date.now(),s=Math.max(0,r-i);s===0?t():N.current=setTimeout(()=>{N.current=null,t()},s)}catch(r){console.error("Error calculating redirect time:",r),N.current=setTimeout(()=>{N.current=null,t()},5e3)}return()=>{N.current&&(clearTimeout(N.current),N.current=null)}},[u,n,p,m]);const Ne=c.useCallback(async()=>{var t,r;if(u){if(!d){o({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),m("/login");return}if(v!=="completed"){try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!a&&await _()}catch(i){}try{const i=await De({supabase:h,quiz:u,user:d});if(i.status==="error")throw i.error;i.status==="already"?(E(!0),T("joined"),o({title:"Already Joined",description:"Starting shortly."})):i.status==="joined"?(E(!0),T("joined"),o({title:"Joined!",description:"Starting now."})):i.status==="pre_joined"?(E(!0),T("joined"),o({title:"Joined!",description:"Quiz starts soon. Stay tuned!"})):i.status==="scheduled_retry"&&(E(!0),T("joined"),o({title:"Joined!",description:"Quiz starts soon. Stay tuned!"})),u.status==="active"&&(i.status==="joined"||i.status==="already")&&(await D(u==null?void 0:u.id),b("active")),J()}catch(i){if(!((t=i==null?void 0:i.message)!=null&&t.includes("already"))&&!((r=i==null?void 0:i.message)!=null&&r.includes("completed"))){const s=ue(i);console.error("Join quiz error:",s,i),o({title:"Error",description:s||"Could not join quiz. Please try again.",variant:"destructive"})}}}}},[u,d,v,a,_,o,m,J,D,b]),_e=c.useCallback(async(t,r)=>{if(!($||p!=="active"||v==="completed")&&d!=null&&d.id)try{const{error:i}=await h.from("user_answers").upsert({user_id:d.id,question_id:t,selected_option_id:r},{onConflict:"user_id,question_id"});if(i)throw i;U(s=>({...s,[t]:r})),g<q.length-1&&(typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>x(s=>s+1)):setTimeout(()=>x(s=>s+1),250))}catch(i){console.error("Error saving answer:",i),Q.current.some(f=>f.questionId===t)||o({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),Q.current.push({questionId:t,optionId:r,attempt:1}),k()}},[$,p,v,d==null?void 0:d.id,g,q.length,o,k]),ce=c.useCallback(async()=>{if(!$){Y(!0);try{let t=h.from("quiz_participants").update({status:"completed"}).eq("user_id",d.id);l?t=t.eq("slot_id",l):t=t.eq("quiz_id",n);const{error:r}=await t;if(r)throw r;o({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),b("completed");try{await me(h,l||n)}catch(i){}m(l?`/results/slot/${l}`:`/results/${n}`)}catch(t){console.error("Error submitting quiz:",t),o({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{Z.current&&Y(!1)}}},[$,d==null?void 0:d.id,n,o,m]),Se=c.useCallback(t=>{const r=Math.floor(t/60),i=t%60;return`${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},[]);return{quiz:u,questions:q,currentQuestionIndex:g,answers:S,quizState:p,timeLeft:X,submitting:$,engagement:A,joined:G,participantStatus:v,totalJoined:te,displayJoined:se,slotMeta:w,slotPaused:V,slotLoading:re,setCurrentQuestionIndex:x,handleJoinOrPrejoin:Ne,handleAnswerSelect:_e,handleSubmit:ce,formatTime:Se}}const we=({startTime:n,endTime:m})=>e.jsxs("div",{className:"mt-2 text-[10px] text-slate-400",children:[e.jsx("div",{className:"mb-1",children:n?Ce(n):"â€”"}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-md px-2 py-1",children:[e.jsx("span",{className:"uppercase text-[9px] text-slate-500",children:"Start"}),e.jsx("div",{className:"text-slate-300",children:n?fe(n):"â€”"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-md px-2 py-1",children:[e.jsx("span",{className:"uppercase text-[9px] text-slate-500",children:"End"}),e.jsx("div",{className:"text-slate-300",children:m?fe(m):"â€”"})]})]})]}),ve=({prizes:n=[],prizeType:m="coins"})=>{var a,_,u;const y=(a=n[0])!=null?a:0,l=(_=n[1])!=null?_:0,o=(u=n[2])!=null?u:0,d=C=>Qe(m,C,{fallback:0}).formatted;return e.jsxs("div",{className:"mt-2 flex items-center justify-center gap-1.5 text-[10px]",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-600/30",children:["ðŸ¥‡ ",d(y)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-600/30",children:["ðŸ¥ˆ ",d(l)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-600/30",children:["ðŸ¥‰ ",d(o)]})]})},pe=({quizId:n})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx(I,{title:"Quiz â€“ Loading | Quiz Dangal",description:"Loading quiz details.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${n||""}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"text-center",children:[e.jsx(ge,{className:"h-16 w-16 animate-spin text-indigo-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Loading quiz..."})]})]}),Je=({message:n})=>e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center text-red-400",children:n||"An error occurred"})}),Me=()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-400",children:"No questions available for this quiz."})})}),Fe=({quiz:n,title:m,isActive:y,timeLeft:l,displayJoined:o,prizes:d,prizeType:a,formatTime:_,onJoin:u,onClose:C})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center px-3 pt-16",children:[e.jsx(I,{title:`${m} â€“ Lobby | Quiz Dangal`,description:"Join the quiz lobby.",robots:"noindex, nofollow"}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:e.jsxs("div",{className:"relative rounded-xl bg-slate-900/95 p-4 text-center",children:[e.jsx("button",{"aria-label":"Close",onClick:C,className:"absolute top-3 right-3 text-slate-500 hover:text-white transition",children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-12 h-12 mx-auto mb-3 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center",children:e.jsx(oe,{className:"h-6 w-6 text-white"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:m}),e.jsx("p",{className:"text-[11px] text-slate-400 mb-2",children:y?"Quiz is live!":"Quiz starts in"}),e.jsx("div",{className:"text-2xl font-bold text-indigo-300 mb-2",children:_(l)}),e.jsxs("div",{className:"flex items-center justify-center gap-1 text-[11px] text-slate-400 mb-2",children:[e.jsx(je,{className:"h-3 w-3"}),o," joined"]}),e.jsx(ve,{prizes:d,prizeType:a}),e.jsx(we,{startTime:n==null?void 0:n.start_time,endTime:n==null?void 0:n.end_time}),e.jsx("div",{className:"mt-4",children:e.jsx(he,{onClick:u,className:`w-full h-10 text-sm font-bold ${y?"bg-gradient-to-r from-emerald-600 to-green-500":"bg-gradient-to-r from-indigo-600 to-violet-600"} hover:opacity-90`,children:y?"Join & Start":"Pre-Join"})})]})})})]}),Oe=({quiz:n,title:m,timeLeft:y,totalJoined:l,prizes:o,prizeType:d,formatTime:a,onClose:_})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(I,{title:`${m} â€“ Waiting | Quiz Dangal`,description:"Waiting for the quiz to start.",robots:"noindex, nofollow"}),e.jsx(H.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:e.jsxs("div",{className:"relative rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("button",{"aria-label":"Close",onClick:_,className:"absolute top-2 right-2 text-slate-400 hover:text-slate-200 transition",children:e.jsx(be,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(oe,{className:"h-6 w-6 text-indigo-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1 line-clamp-2",children:m}),e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-2xl font-bold text-indigo-300 mb-2",children:a(y)}),e.jsxs("div",{className:"flex items-center justify-center gap-1 text-xs text-slate-400 mb-2",children:[e.jsx(je,{className:"h-3 w-3"}),l," joined"]}),e.jsx(ve,{prizes:o,prizeType:d}),e.jsx(we,{startTime:n==null?void 0:n.start_time,endTime:n==null?void 0:n.end_time}),e.jsx("p",{className:"mt-2 text-[10px] text-slate-500",children:"Auto-starts when timer hits zero"})]})})})]}),Ve=({title:n,onNavigateHome:m})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(I,{title:`${n} â€“ Completed | Quiz Dangal`,description:"Quiz completed. Results will be published soon.",robots:"noindex, nofollow"}),e.jsx(H.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-emerald-500/50 via-green-500/40 to-teal-500/50",children:e.jsxs("div",{className:"rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(ye,{className:"h-6 w-6 text-emerald-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:"Quiz Submitted!"}),e.jsx("p",{className:"text-xs text-slate-400 mb-2",children:"Thank you for participating!"}),e.jsx("p",{className:"text-sm text-slate-300 mb-3",children:"Results will be published soon."}),e.jsx("button",{onClick:m,className:"mt-3 w-full h-9 rounded-lg text-xs font-bold text-white bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90 transition",children:"Back to Home"})]})})})]}),He=({title:n,onNavigateHome:m})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(I,{title:`${n} â€“ Time's Up | Quiz Dangal`,description:"Quiz time ended.",robots:"noindex, nofollow"}),e.jsx(H.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-amber-500/50 via-orange-500/40 to-red-500/50",children:e.jsxs("div",{className:"rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-amber-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(oe,{className:"h-6 w-6 text-amber-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:"Time's Up!"}),e.jsx("p",{className:"text-xs text-slate-400 mb-4",children:"This quiz has ended. Try the next one!"}),e.jsx("button",{onClick:m,className:"w-full h-9 rounded-lg text-xs font-bold text-white bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90 transition",children:"Browse Quizzes"})]})})})]}),Ue=({title:n,quizId:m,questions:y,currentQuestionIndex:l,answers:o,timeLeft:d,submitting:a,quizState:_,participantStatus:u,formatTime:C,onAnswerSelect:q,onSubmit:P})=>{const g=y[l],x=(l+1)/y.length*100;return e.jsxs("div",{className:"min-h-screen px-3 pt-16 pb-6",children:[e.jsx(I,{title:`${n} â€“ Play | Quiz Dangal`,description:"Answer questions and compete to win.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${m}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"max-w-md mx-auto space-y-3",children:[e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:e.jsxs("div",{className:"rounded-xl bg-slate-900/95 p-3",children:[e.jsxs("div",{className:"flex justify-between items-center gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-sm font-bold text-white truncate",children:n}),e.jsxs("p",{className:"text-[10px] text-slate-400",children:["Q",l+1," of ",y.length]})]}),e.jsxs("div",{className:"shrink-0 text-right",children:[e.jsx("div",{className:"text-lg font-bold text-rose-400 tabular-nums",children:C(d)}),e.jsx("div",{className:"text-[9px] text-slate-500 uppercase",children:"Time Left"})]})]}),e.jsx("div",{className:"mt-2 w-full bg-slate-800 rounded-full h-1.5 overflow-hidden",children:e.jsx(H.div,{className:"h-1.5 rounded-full bg-gradient-to-r from-cyan-400 via-indigo-500 to-fuchsia-500",style:{width:`${x}%`},transition:{duration:.3}})})]})}),e.jsx(Ae,{mode:"wait",children:e.jsxs(H.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2},className:"rounded-xl border border-slate-700/60 bg-slate-900/90 p-4",children:[e.jsx("h2",{className:"text-sm font-bold text-center text-white mb-4 leading-relaxed",children:g==null?void 0:g.question_text}),e.jsx("div",{className:"space-y-2",children:((g==null?void 0:g.options)||[]).map((S,U)=>{const p=o[g==null?void 0:g.id]===S.id;return e.jsxs(H.button,{onClick:()=>q(g.id,S.id),disabled:a||_!=="active"||u==="completed",whileTap:{scale:.98},className:`w-full p-3 rounded-lg text-left text-sm font-medium transition-all border ${p?"bg-emerald-600/90 text-white border-emerald-500 shadow-lg":"bg-slate-800/60 hover:bg-slate-800 text-slate-200 border-slate-700/60"}`,children:[e.jsxs("span",{className:`font-bold mr-2 ${p?"text-white":"text-indigo-400"}`,children:[String.fromCharCode(65+U),"."]}),S.option_text]},S.id)})}),l===y.length-1&&Object.keys(o).length===y.length&&e.jsx(H.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},className:"mt-4",children:e.jsx(he,{onClick:P,disabled:a,className:"w-full h-11 text-sm font-bold bg-gradient-to-r from-indigo-600 via-violet-600 to-fuchsia-600 hover:opacity-90",children:a?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"mr-2 h-4 w-4 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"mr-2 h-4 w-4"}),"Submit Quiz"]})})})]},(g==null?void 0:g.id)||l)})]})]})},et=()=>{const{id:n,slotId:m}=Le(),y=Pe(),l=Re(),o=y.pathname.includes("/quiz/slot/"),d=o?m:n,[a,_]=c.useState(null),[u,C]=c.useState(o),[q,P]=c.useState(null),g=c.useCallback(async()=>{if(!(!o||!m)){if(!h){P("Supabase not configured"),C(!1);return}try{const{data:k,error:L}=await h.from("quiz_slots_view").select("*").eq("id",m).maybeSingle();if(L)throw L;if(!k)throw new Error("Slot not found");_(k),C(!1)}catch(k){P(k.message||"Failed to load slot"),C(!1)}}},[o,m]);c.useEffect(()=>{o&&g()},[o,g]);const{quiz:x,questions:S,currentQuestionIndex:U,answers:p,quizState:b,timeLeft:X,submitting:B,joined:w,participantStatus:ee,totalJoined:V,displayJoined:ne,handleJoinOrPrejoin:re,handleAnswerSelect:ae,handleSubmit:W,formatTime:R}=$e(o?a==null?void 0:a.id:n,l,o?{slotId:m}:void 0);c.useEffect(()=>{if(!o||b!=="finished"&&b!=="completed"||!(a!=null&&a.id)||!(a!=null&&a.category))return;let k=!1;return(async()=>{try{const{slots:L}=await qe(h,a.category),te=a.end_time?new Date(a.end_time).getTime():Date.now(),se=(L||[]).filter(D=>D.start_time?new Date(D.start_time).getTime()>te:!1).sort((D,J)=>new Date(D.start_time).getTime()-new Date(J.start_time).getTime());!k&&se[0]&&l("/quiz/slot/"+se[0].slotId)}catch(L){}})(),()=>{k=!0}},[o,b,a==null?void 0:a.id,a==null?void 0:a.category,a==null?void 0:a.end_time,l]);const $=()=>{window.history.length>1?l(-1):l("/")},Y=()=>l("/");if(o&&u)return e.jsx(pe,{quizId:d});if(o&&q)return e.jsx(Je,{message:q});if(b==="loading"||!o&&!x||o&&!a)return e.jsx(pe,{quizId:d});const A=o?(a==null?void 0:a.quiz_title)||(x==null?void 0:x.title)||"Quiz":(x==null?void 0:x.title)||"Quiz",F=o?Array.isArray(a==null?void 0:a.prizes)?a.prizes:[]:Array.isArray(x==null?void 0:x.prizes)?x.prizes:[],G=o?"coins":(x==null?void 0:x.prize_type)||"coins",E=o?a==null?void 0:a.start_time:x==null?void 0:x.start_time,v=o?a==null?void 0:a.end_time:x==null?void 0:x.end_time,T=new Date,N=E?new Date(E):null,Z=v?new Date(v):null,Q=N&&Z&&T>=N&&T<Z,O=o?{start_time:a==null?void 0:a.start_time,end_time:a==null?void 0:a.end_time}:x;if(!w&&b!=="completed")return e.jsx(Fe,{quiz:O,title:A,isActive:Q,timeLeft:X,displayJoined:ne,prizes:F,prizeType:G,formatTime:R,onJoin:re,onClose:$});if(b==="waiting")return e.jsx(Oe,{quiz:O,title:A,timeLeft:X,totalJoined:V,prizes:F,prizeType:G,formatTime:R,onClose:$});const K=Object.keys(p).length>0;return b==="completed"||b==="finished"&&K?e.jsx(Ve,{title:A,onNavigateHome:Y}):b==="finished"&&!K?e.jsx(He,{title:A,onNavigateHome:Y}):!S||S.length===0?e.jsx(Me,{}):e.jsx(Ue,{title:A,quizId:d,questions:S,currentQuestionIndex:U,answers:p,timeLeft:X,submitting:B,quizState:b,participantStatus:ee,formatTime:R,onAnswerSelect:ae,onSubmit:W})};export{et as default};
