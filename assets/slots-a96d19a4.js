import{l as f}from"./index-176065b2.js";const g=new Map;async function h(t,e){return e.slotId&&!e.isLegacy?t.rpc("pre_join_slot",{p_slot_id:e.slotId}):t.rpc("pre_join_quiz",{p_quiz_id:e.id})}async function j(t,e){return e.slotId&&!e.isLegacy?t.rpc("join_slot",{p_slot_id:e.slotId}):t.rpc("join_quiz",{p_quiz_id:e.id})}async function T({supabase:t,quiz:e,user:d}){const n=(e==null?void 0:e.slotId)||(e==null?void 0:e.id);if(!t||!e||!n)return{status:"error",error:new Error("Missing quiz or supabase client")};if(!d||!d.id)return{status:"error",error:new Error("Not authenticated")};try{const o=String((e==null?void 0:e.status)||"").trim().toLowerCase();if(o==="paused"||o==="stopped"||o==="skipped")return{status:"error",error:new Error("Quiz is paused. Please try later.")};if(e!=null&&e.stop_override)return{status:"error",error:new Error("Quiz is temporarily stopped. Please try later.")}}catch(o){}try{const o=e.start_time?new Date(e.start_time).getTime():null,m=e.end_time?new Date(e.end_time).getTime():null,i=Date.now();if(!o||!m){const{error:l}=await h(t,e);return l?{status:"error",error:l}:{status:"pre_joined"}}const u=5e3,p=i>=o-u&&i<m,s=o-(u+1500);if(i<s){const{error:l}=await h(t,e);return l?{status:"error",error:l}:{status:"pre_joined"}}if(!p&&i>=s&&i<o-300){const{error:l}=await h(t,e);if(l)return{status:"error",error:l};if(!g.has(n)){const c=Math.max(50,o-(u-100)-Date.now()),y=setTimeout(async()=>{g.delete(n);try{const{error:r}=await j(t,e);if(r){const a=String(r.message||"").toLowerCase();if(a.includes("already")||a.includes("completed")){f.debug("Scheduled join: already joined/completed",n);return}if(a.includes("not active")){f.debug("Scheduled join: still not active, giving up this cycle",n);return}f.error("Scheduled join error",r.message||r)}else f.debug("Scheduled join success",n)}catch(r){f.error("Scheduled join throw",(r==null?void 0:r.message)||r)}},c);return g.set(n,y),{status:"scheduled_retry",scheduledAt:Date.now()+c}}return{status:"scheduled_retry",scheduledAt:null}}if(p){const{error:l}=await j(t,e);if(!l)return{status:"joined"};const c=String(l.message||"").toLowerCase();if(c.includes("already")||c.includes("completed"))return{status:"already"};if(c.includes("not active")){if(!g.has(n)){const r=setTimeout(async()=>{g.delete(n);try{const{error:a}=await j(t,e);a&&!String(a.message||"").toLowerCase().includes("already")&&f.error("Final join retry failed",a.message||a)}catch(a){f.error("Final join retry throw",(a==null?void 0:a.message)||a)}},600);return g.set(n,r),{status:"scheduled_retry",scheduledAt:Date.now()+600}}return{status:"scheduled_retry",scheduledAt:null}}return{status:"error",error:l}}const{error:_}=await h(t,e);return _?{status:"error",error:_}:{status:"pre_joined"}}catch(o){return{status:"error",error:o}}}function v(t){var o,m,i,u,p,s,_,l,c,y;if(!t)return null;const e=Number((i=(m=(o=t.participants_joined)!=null?o:t.joined_count)!=null?m:t.joined)!=null?i:0),d=Number((s=(p=(u=t.participants_pre)!=null?u:t.pre_joined_count)!=null?p:t.pre_joined)!=null?s:0),n=Number((_=t.participants_total)!=null?_:e+d);return{slotId:t.id||t.slot_id||t.slotid||t.slotID||t.slot_uuid||t.slot_uuid_id||t.slot_uuid_ref||t.quiz_slot_id||t.quiz_slot_uuid||t.slot_uuid_value||t.slot_ref||t.slot_reference||t.slot||null,quizId:t.quiz_id||t.quizid||t.quiz_uuid||t.quiz_uuid_id||t.quiz||null,category:t.category||null,title:t.quiz_title||t.title||t.slot_title||null,start_time:t.start_time||t.slot_start||t.starts_at||null,end_time:t.end_time||t.slot_end||t.ends_at||null,status:t.status||"scheduled",prizes:Array.isArray(t.prizes)?t.prizes:Array.isArray(t.quiz_prizes)?t.quiz_prizes:[],questions:Array.isArray(t.questions)?t.questions:[],prize_type:t.prize_type||t.quiz_prize_type||"coins",participants_joined:e,participants_pre:d,participants_total:n,questions_count:Number((y=(c=(l=t.questions_count)!=null?l:t.question_count)!=null?c:t.q_count)!=null?y:0),auto_enabled:typeof t.auto_enabled=="boolean"?t.auto_enabled:void 0,stop_override:!!t.stop_override}}async function I(t,e){if(!t)return{slots:[],mode:"none",auto:!0};let d=[],n=[],o=!0;try{const{data:s,error:_}=await t.from("quiz_slots_view").select("*").eq("category",e).order("start_time",{ascending:!0});!_&&s&&(d=s.map(v))}catch(s){f.debug("quiz_slots_view error",s.message||s)}try{const{data:s,error:_}=await t.from("quizzes").select("id,title,start_time,end_time,status,prizes,prize_type,slot_id,questions(count)").eq("category",e).order("start_time",{ascending:!0});if(!_&&s){const l=Date.now(),c=(s||[]).filter(r=>!r.slot_id);let y={};if(c.length>0)try{const{data:r}=await t.rpc("get_engagement_counts_many",{p_quiz_ids:c.map(a=>a.id)});if(r)for(const a of r)y[a.quiz_id]=(a.pre_joined||0)+(a.joined||0)}catch(r){}n=c.map(r=>{var a,D;return{slotId:r.id,quizId:r.id,category:e,title:r.title,quiz_title:r.title,start_time:r.start_time,end_time:r.end_time,status:S(r,l),prizes:Array.isArray(r.prizes)?r.prizes:[],prize_type:r.prize_type||"coins",participants_joined:y[r.id]||0,participants_total:y[r.id]||0,questions_count:((D=(a=r.questions)==null?void 0:a[0])==null?void 0:D.count)||0,auto_enabled:!0,isLegacy:!0}})}}catch(s){f.debug("Legacy quizzes fetch error",s.message||s)}try{const{data:s,error:_}=await t.from("category_runtime_overrides").select("category,auto_enabled:is_auto").eq("category",e).maybeSingle();!_&&s&&(o=!!s.auto_enabled)}catch(s){}const m=new Set(d.map(s=>s.quizId).filter(Boolean)),i=n.filter(s=>!m.has(s.quizId)),u=[...d,...i];u.sort((s,_)=>{const l=s.start_time?new Date(s.start_time).getTime():0,c=_.start_time?new Date(_.start_time).getTime():0;return l-c});const p=d.length>0?"slots":i.length>0?"legacy":"none";return{slots:u,mode:p,auto:o}}function S(t,e){const d=t.start_time?new Date(t.start_time).getTime():null,n=t.end_time?new Date(t.end_time).getTime():null;return d&&n&&e>=d&&e<n?"active":d&&e<d?"scheduled":n&&e>=n?"finished":"scheduled"}function A(t){const e=Date.now(),d=t.find(i=>{const u=i!=null&&i.start_time?new Date(i.start_time).getTime():null,p=i!=null&&i.end_time?new Date(i.end_time).getTime():null;return u&&p&&e>=u&&e<p}),n=t.filter(i=>{const u=i!=null&&i.start_time?new Date(i.start_time).getTime():null;return u?e<u:!1});n.sort((i,u)=>new Date(i.start_time).getTime()-new Date(u.start_time).getTime());const o=n[0]||null,m=n[1]||null;return{live:d,next:o,queued:m}}export{A as c,I as f,T as s};
