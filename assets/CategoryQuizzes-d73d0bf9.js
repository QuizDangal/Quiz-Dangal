import{e as Ie,u as De,k as Te,s as I,j as t,f as ae,d as M,p as de,m as ke,g as le}from"./index-05805094.js";import{r as p}from"./react-63c462fe.js";import{m as Me}from"./motion-lite-3d667e23.js";import{f as Ee,c as $e,s as Ce}from"./slots-1f349935.js";import{S as Le}from"./SEO-58a3497b.js";import{c as Pe,b as Je}from"./router-d6d570a4.js";import{b as Ae,c as Ue,M as ce,B as Oe,T as Qe,a as Be}from"./icons-1e9e0bae.js";import"./supabase-07ebd5d8.js";const D=new Map;let ue=0;function A(a){if(!(ue%200!==0&&D.size<100))for(const[d,m]of D.entries()){const l=(m.windowMs||8e3)*2;a-m.firstTs>l&&D.delete(d)}}function Fe(a,{max:d=5,windowMs:m=8e3}={}){ue+=1;const l=Date.now(),b=D.get(a);return b?l-b.firstTs>b.windowMs?(D.set(a,{count:1,firstTs:l,windowMs:m}),A(l),{allowed:!0,remaining:d-1}):b.count>=d?(A(l),{allowed:!1,remaining:0}):(b.count+=1,A(l),{allowed:!0,remaining:d-b.count}):(D.set(a,{count:1,firstTs:l,windowMs:m}),A(l),{allowed:!0,remaining:d-1})}function Ve(a=""){const d=String(a||"").toLowerCase();return d.includes("opinion")?{title:"Opinion Quizzes",emoji:"ðŸ’¬",Icon:ce,from:"from-indigo-600/30",to:"to-fuchsia-600/30",ring:"ring-fuchsia-500/30"}:d.includes("gk")?{title:"GK Quizzes",emoji:"ðŸ§ ",Icon:Oe,from:"from-emerald-600/30",to:"to-teal-600/30",ring:"ring-emerald-500/30"}:d.includes("sport")?{title:"Sports Quizzes",emoji:"ðŸ†",Icon:Qe,from:"from-orange-600/30",to:"to-red-600/30",ring:"ring-orange-500/30"}:d.includes("movie")?{title:"Movie Quizzes",emoji:"ðŸŽ¬",Icon:Be,from:"from-violet-600/30",to:"to-indigo-600/30",ring:"ring-violet-500/30"}:{title:`${a} Quizzes`,emoji:"â­",Icon:ce,from:"from-sky-600/30",to:"to-indigo-600/30",ring:"ring-sky-500/30"}}const U=a=>a!=null&&a.start_time?new Date(a.start_time).getTime():null,pe=a=>a!=null&&a.end_time?new Date(a.end_time).getTime():null,me=a=>{const d=U(a),m=pe(a);if(!d||!m)return!1;const l=Date.now();return l>=d&&l<m},We=a=>{const d=U(a);return d?Date.now()<d:!1},et=()=>{const{slug:a}=Pe(),d=Je(),{toast:m}=Ie(),{user:l}=De(),{isSubscribed:b,subscribeToPush:xe}=Te(),[g]=p.useState([]),[K,Y]=p.useState(!0),[E,X]=p.useState(null),[ge,Z]=p.useState({}),[q,y]=p.useState({}),[fe,ee]=p.useState(0),[f,he]=p.useState([]),[w,O]=p.useState("detect"),[be,ye]=p.useState(!0),we=2e4,$=p.useCallback(async()=>{if(I)try{const{slots:e,mode:n,auto:s}=await Ee(I,a);he(e),ye(s),O(n==="slots"||n==="legacy"?"slots":"legacy")}catch(e){O("legacy")}},[a]);p.useEffect(()=>{Y(!0),$().finally(()=>{Y(!1)})},[$,a]),p.useEffect(()=>{if(w==="none")return;const e=setInterval(()=>{$()},we);return()=>clearInterval(e)},[w,$]),p.useEffect(()=>{const e=Date.now();if(!(g||[]).some(i=>{const o=i.start_time?new Date(i.start_time).getTime():0,r=i.end_time?new Date(i.end_time).getTime():0;return o&&e<o||o&&r&&e>=o&&e<r}))return;const s=setInterval(()=>ee(i=>(i+1)%1e6),1e3);return()=>clearInterval(s)},[g]),p.useEffect(()=>{if(w!=="slots")return;const e=Date.now();if(!(f||[]).some(i=>{const o=i.start_time?new Date(i.start_time).getTime():0,r=i.end_time?new Date(i.end_time).getTime():0;return o&&e<o||o&&r&&e>=o&&e<r}))return;const s=setInterval(()=>ee(i=>(i+1)%1e6),1e3);return()=>clearInterval(s)},[f,w]),p.useEffect(()=>{const e=async()=>{try{const n=(g||[]).map(r=>r.id);if(!n.length){Z({});return}const{data:s,error:i}=await I.rpc("get_engagement_counts_many",{p_quiz_ids:n});if(i)throw i;const o={};for(const r of s||[]){const c=r.pre_joined||0,u=r.joined||0;o[r.quiz_id]=c+u}Z(o)}catch(n){}};g&&g.length&&e()},[g]),p.useEffect(()=>{(async()=>{const n=(g||[]).map(r=>r.id).filter(Boolean),s=(f||[]).filter(r=>!r.isLegacy).map(r=>r.slotId).filter(Boolean),i=(f||[]).filter(r=>r.isLegacy).map(r=>r.quizId).filter(Boolean),o=[...new Set([...n,...i])];if(!l||!o.length&&!s.length){y({});return}try{const r={};if(o.length){const{data:c,error:u}=await I.from("quiz_participants").select("quiz_id,status").eq("user_id",l.id).in("quiz_id",o);if(!u&&c)for(const x of c)r[x.quiz_id]=x.status==="pre_joined"?"pre":"joined"}if(s.length){const{data:c,error:u}=await I.from("quiz_participants").select("slot_id,status").eq("user_id",l.id).in("slot_id",s);if(!u&&c)for(const x of c)r[x.slot_id]=x.status==="pre_joined"?"pre":"joined"}y(r)}catch(r){y({})}})()},[l,g,f]);const te=async e=>{if(!l){m({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),d("/login");return}const n=e.slotId||e.id;try{const s=String((e==null?void 0:e.status)||"").trim().toLowerCase();if(s==="paused"||s==="stopped"||s==="skipped"||e!=null&&e.stop_override){m({title:"Paused",description:"This category is paused right now. Please try later.",variant:"destructive"});return}}catch(s){}X(n);try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!b&&Promise.resolve().then(()=>xe()).catch(()=>{})}catch(s){}try{const s=await Ce({supabase:I,quiz:e,user:l});if(s.status==="error")throw s.error;s.status==="already"?(y(i=>({...i,[n]:"joined"})),m({title:"Already Joined",description:"You are in this quiz."})):s.status==="joined"?(y(o=>({...o,[n]:"joined"})),Fe(`join_${(l==null?void 0:l.id)||"anon"}`,{max:4,windowMs:8e3}).allowed?(m({title:"Joined!",description:"Taking you to the quiz."}),d(e.slotId&&!e.isLegacy?`/quiz/slot/${e.slotId}`:`/quiz/${e.id}`)):m({title:"Slow down",description:"Please wait a moment before trying again.",variant:"destructive"})):s.status==="pre_joined"?(y(i=>({...i,[n]:"pre"})),m({title:"Pre-joined!",description:"We will remind you before start."})):s.status==="scheduled_retry"&&(y(i=>({...i,[n]:"pre"})),m({title:"Pre-joined!",description:"Auto joining at start time."}))}catch(s){const i=ke(s);m({title:"Error",description:i||(s==null?void 0:s.message)||"Could not join quiz.",variant:"destructive"})}finally{X(null)}},se=g.filter(e=>{if(w==="slots")return!1;const n=Date.now(),s=e.start_time?new Date(e.start_time).getTime():0,i=e.end_time?new Date(e.end_time).getTime():0,o=s&&i&&n>=s&&n<i,r=s&&n<s;return o||r}),C=Ve(a),_=Date.now(),Q=w==="slots",T=Q?f:g||[],je=Q?T.filter(e=>me(e)).length:T.reduce((e,n)=>{const s=n.start_time?new Date(n.start_time).getTime():0,i=n.end_time?new Date(n.end_time).getTime():0;return e+(s&&i&&_>=s&&_<i?1:0)},0),ve=T.filter(e=>{const n=e.start_time?new Date(e.start_time).getTime():0;return!n||_>=n?!1:e.isLegacy?!0:n-_<=300*1e3}).length,B=Q?T.map(e=>U(e)).filter(e=>e&&e>_).sort((e,n)=>e-n)[0]||null:T.map(e=>e.start_time?new Date(e.start_time).getTime():null).filter(e=>e&&e>_).sort((e,n)=>e-n)[0]||null,{next:L}=$e(f),Ne=e=>{var ne,re,oe;if(!e)return null;const n=Date.now(),s=U(e),i=pe(e),o=me(e),r=e.status==="paused",c=e.status==="finished"||i&&n>=i,u=We(e),x=u&&s?Math.max(0,Math.floor((s-n)/1e3)):o&&i?Math.max(0,Math.floor((i-n)/1e3)):null,j=Array.isArray(e.prizes)?e.prizes:[],F=e.prize_type||"coins",V=(ne=j[0])!=null?ne:0,W=(re=j[1])!=null?re:0,G=(oe=j[2])!=null?oe:0,v=Se=>le(F,Se,{fallback:0}).formatted,R=e.participants_total||e.participants_joined||0,P=e.questions_count||10,J=!be&&!o&&!u,N=o&&!c?"LIVE":r?"PAUSED":J?"STOPPED":u?"UPCOMING":c?"FINISHED":(e.status||"").toUpperCase(),k=e.isLegacy?e.quizId:e.slotId,h=!!q[k],z=E===k,ie=c?"Results":o?h?"Play":"Join Now":u?h?"Joined âœ“":"Pre-Join":"View",ze=async()=>{if(c||h&&!o){d(e.isLegacy?`/quiz/${e.quizId}`:`/quiz/slot/${e.slotId}`);return}if(o){d(e.isLegacy?`/quiz/${e.quizId}`:`/quiz/slot/${e.slotId}`);return}u&&!h&&await te({id:e.quizId,...e})};return t.jsx("div",{className:`p-[1px] rounded-xl sm:rounded-2xl ${o?"bg-gradient-to-r from-emerald-500/60 to-green-500/60":"bg-gradient-to-r from-indigo-500/40 via-violet-500/30 to-fuchsia-500/40"}`,children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4 lg:p-5",children:[t.jsx("div",{className:"flex justify-end mb-1.5 sm:mb-2",children:t.jsx("span",{className:`px-2 sm:px-3 py-0.5 sm:py-1 rounded-md text-[9px] sm:text-[11px] font-bold ${N==="LIVE"?"bg-rose-600 text-white":N==="UPCOMING"?"bg-sky-600 text-white":N==="PAUSED"?"bg-amber-600 text-white":"bg-slate-700 text-slate-300"}`,children:N})}),t.jsx("h3",{className:"text-sm sm:text-base font-bold text-white mb-2 sm:mb-3 line-clamp-2",children:e.quiz_title||e.title||"Quiz"}),t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 text-[10px] sm:text-xs text-slate-400 mb-2 sm:mb-3",children:[t.jsxs("div",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[t.jsx("span",{className:"text-[9px] sm:text-[10px] text-slate-500",children:"Start"})," ",e.start_time?M(e.start_time):"â€”"]}),t.jsxs("div",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[t.jsx("span",{className:"text-[9px] sm:text-[10px] text-slate-500",children:"End"})," ",e.end_time?M(e.end_time):"â€”"]})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 text-[10px] sm:text-xs mb-2 sm:mb-3",children:[t.jsxs("span",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-r from-amber-500/20 to-amber-400/10 text-amber-200 border border-amber-500/30 shadow-sm",children:["ðŸ¥‡ ",v(V)]}),t.jsxs("span",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-r from-sky-500/20 to-sky-400/10 text-sky-200 border border-sky-500/30 shadow-sm",children:["ðŸ¥ˆ ",v(W)]}),t.jsxs("span",{className:"px-2 py-1.5 rounded-lg bg-gradient-to-r from-violet-500/20 to-violet-400/10 text-violet-200 border border-violet-500/30 shadow-sm",children:["ðŸ¥‰ ",v(G)]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2 sm:mb-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-[10px] sm:text-xs",children:[t.jsxs("span",{className:"px-2 py-1 rounded-md bg-slate-800/70 border border-slate-700/50 text-slate-300",children:["ðŸ“ ",P," Questions"]}),t.jsxs("span",{className:"px-2 py-1 rounded-md bg-slate-800/70 border border-slate-700/50 text-slate-300",children:["ðŸ‘¥ ",R," Joined"]})]}),x!==null&&t.jsxs("div",{className:"text-xs sm:text-sm font-semibold text-indigo-300",children:[u?"In":"Ends"," ",Math.floor(x/60).toString().padStart(2,"0"),":",(x%60).toString().padStart(2,"0")]})]}),t.jsx("button",{type:"button",disabled:z||h&&u,onClick:ze,onMouseEnter:()=>de(e.isLegacy?`/quiz/${e.quizId}`:`/quiz/slot/${e.slotId}`),className:`w-full h-9 sm:h-10 lg:h-11 rounded-lg text-xs sm:text-sm font-bold text-white transition ${z?"opacity-50 cursor-wait":h&&u?"bg-gradient-to-r from-emerald-700 to-green-600 cursor-default":o?"bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90":"bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90"}`,children:z?"Joining...":ie})]})},e.slotId)};p.useEffect(()=>{if(!L)return;const e=L.start_time?new Date(L.start_time).getTime():null;if(!e)return;const n=Date.now(),s=e-n-6e4;if(s<=0||s>1800*1e3)return;const i=setTimeout(()=>{try{m({title:"Upcoming Slot",description:"1 minute to start â€“ be ready!",duration:4e3})}catch(o){}},s);return()=>clearTimeout(i)},[L,m]);const _e=typeof window!="undefined"?`${window.location.origin}/category/${a}/`:`https://quizdangal.com/category/${a}/`;return t.jsxs("div",{className:"px-3 sm:px-4 pt-16 sm:pt-20 pb-6",children:[t.jsx(Le,{title:`${C.title} â€“ Quiz Dangal`,description:`Active and upcoming quizzes in ${C.title}.`,canonical:_e,robots:"index, follow"}),t.jsx("span",{className:"hidden","aria-hidden":!0,children:fe}),t.jsxs("div",{className:"max-w-md sm:max-w-2xl lg:max-w-4xl mx-auto space-y-4",children:[t.jsx("div",{className:"p-[1px] rounded-xl sm:rounded-2xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4 lg:p-5",children:[t.jsxs("div",{className:"flex items-center gap-3 sm:gap-4 mb-2",children:[t.jsx("div",{className:"w-9 h-9 sm:w-12 sm:h-12 lg:w-14 lg:h-14 rounded-lg sm:rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-lg sm:text-2xl lg:text-3xl",children:C.emoji}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsx("h1",{className:"text-base sm:text-xl lg:text-2xl font-bold text-white truncate",children:C.title}),t.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 text-[10px] sm:text-xs mt-1",children:[t.jsxs("span",{className:"px-1.5 sm:px-2.5 py-0.5 sm:py-1 rounded sm:rounded-md bg-emerald-600/20 text-emerald-300 border border-emerald-600/30",children:[je," live"]}),t.jsxs("span",{className:"px-1.5 sm:px-2.5 py-0.5 sm:py-1 rounded sm:rounded-md bg-sky-600/20 text-sky-300 border border-sky-600/30",children:[ve," upcoming"]})]})]})]}),B&&t.jsxs("div",{className:"flex items-center gap-1 text-[10px] sm:text-xs text-slate-400",children:[t.jsx(Ae,{className:"w-3 h-3 sm:w-4 sm:h-4"}),"Next: ",ae(B)," â€¢ ",M(B)]})]})}),w==="slots"?t.jsx(t.Fragment,{children:K?t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:Array.from({length:3}).map((e,n)=>t.jsx("div",{className:"h-40 sm:h-48 lg:h-52 rounded-xl sm:rounded-2xl bg-slate-800/60 border border-slate-700/60 animate-pulse"},n))}):t.jsx(t.Fragment,{children:f.filter(e=>{const n=Date.now(),s=e.start_time?new Date(e.start_time).getTime():null,i=e.end_time?new Date(e.end_time).getTime():null,o=s&&i&&n>=s&&n<i,r=s&&n<s,c=r&&s-n<=300*1e3;return o||(e.isLegacy?r:c)}).length>0?t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:f.filter(e=>{const n=Date.now(),s=e.start_time?new Date(e.start_time).getTime():null,i=e.end_time?new Date(e.end_time).getTime():null,o=s&&i&&n>=s&&n<i,r=s&&n<s,c=r&&s-n<=300*1e3;return o||(e.isLegacy?r:c)}).map(e=>Ne(e))}):t.jsx("div",{className:"rounded-xl sm:rounded-2xl border border-slate-800 bg-slate-900/50 p-4 sm:p-6 text-center text-sm sm:text-base text-slate-400",children:"No quizzes scheduled yet."})})}):K?t.jsx("div",{className:"grid gap-3 sm:gap-4",children:Array.from({length:4}).map((e,n)=>t.jsx("div",{className:"h-24 sm:h-28 rounded-xl sm:rounded-2xl bg-slate-800/60 border border-slate-700/60 animate-pulse"},n))}):se.length===0?t.jsx("div",{className:"text-center text-muted-foreground py-16",children:"No quizzes in this category yet."}):t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",children:se.map((e,n)=>{var H,h,z;const s=Date.now(),i=e.start_time?new Date(e.start_time).getTime():null,o=e.end_time?new Date(e.end_time).getTime():null,r=i&&o&&s>=i&&s<o,c=i&&s<i,u=r||c,x=c&&i?Math.max(0,Math.floor((i-s)/1e3)):r&&o?Math.max(0,Math.floor((o-s)/1e3)):null,j=Array.isArray(e.prizes)?e.prizes:[],F=e.prize_type||"coins",V=(H=j[0])!=null?H:0,W=(h=j[1])!=null?h:0,G=(z=j[2])!=null?z:0,v=S=>le(F,S,{fallback:0}).formatted,R=ge[e.id]||0,P=q[e.id],J=!!P,N=i&&o?Math.max(1,o-i):null,k=r&&N?Math.min(100,Math.max(0,Math.round((s-i)/N*100))):null;return t.jsx(Me.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{delay:n*.02},onClick:()=>d(`/quiz/${e.id}`),className:"cursor-pointer",role:"button",tabIndex:0,onKeyDown:S=>{S.key==="Enter"&&d(`/quiz/${e.id}`)},children:t.jsx("div",{className:`p-[1px] rounded-xl sm:rounded-2xl ${r?"bg-gradient-to-r from-emerald-500/60 to-green-500/60":"bg-gradient-to-r from-indigo-500/40 via-violet-500/30 to-fuchsia-500/40"}`,children:t.jsxs("div",{className:"rounded-xl sm:rounded-2xl bg-slate-900/95 p-3 sm:p-4",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[t.jsx("h3",{className:"text-sm sm:text-base font-bold text-white flex-1 min-w-0 line-clamp-2",children:e.title}),t.jsxs("div",{className:"shrink-0 flex items-center gap-1",children:[r&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-bold bg-rose-600 text-white",children:"LIVE"}),c&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-bold bg-sky-600 text-white",children:"SOON"}),P&&t.jsx("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-[9px] sm:text-[10px] font-semibold bg-indigo-600/20 text-indigo-300 border border-indigo-500/40",children:"Joined"})]})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5 text-[10px] sm:text-xs mb-2",children:[t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-amber-500/15 text-amber-300 border border-amber-600/30",children:["ðŸ¥‡ ",v(V)]}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-sky-500/15 text-sky-300 border border-sky-600/30",children:["ðŸ¥ˆ ",v(W)]}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-1 rounded bg-violet-500/15 text-violet-300 border border-violet-600/30",children:["ðŸ¥‰ ",v(G)]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-[10px] sm:text-xs text-slate-400 mb-2",children:[t.jsx("span",{children:e.start_time?ae(e.start_time):"â€”"}),t.jsxs("span",{className:"px-1.5 sm:px-2 py-0.5 sm:py-1 rounded bg-slate-800/60 border border-slate-700/50",children:[e.start_time?M(e.start_time):"â€”"," - ",e.end_time?M(e.end_time):"â€”"]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2",children:[t.jsxs("div",{className:"flex items-center gap-1 text-[10px] sm:text-xs text-slate-500",children:[t.jsx(Ue,{className:"w-3 h-3 sm:w-4 sm:h-4"}),R," joined"]}),x!==null&&t.jsxs("div",{className:"text-xs sm:text-sm font-semibold text-indigo-300",children:[c?"In":"Ends"," ",Math.floor(x/60).toString().padStart(2,"0"),":",(x%60).toString().padStart(2,"0")]})]}),k!==null&&t.jsx("div",{className:"mb-2 w-full bg-slate-800 rounded-full h-1 sm:h-1.5 overflow-hidden",children:t.jsx("div",{className:"h-full bg-emerald-500",style:{width:`${k}%`}})}),t.jsx("button",{type:"button",onClick:S=>{S.stopPropagation(),J||!u?d(`/quiz/${e.id}`):te(e)},onMouseEnter:()=>de("/quiz"),disabled:E===e.id,className:`w-full h-9 sm:h-10 rounded-lg text-xs sm:text-sm font-bold text-white transition ${r?"bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90":"bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90"} ${E===e.id?"opacity-80":""}`,children:J?"JOINED":u?E===e.id?"JOININGâ€¦":"JOIN":"VIEW"})]})})},e.id)})})]})]})};export{et as default};
