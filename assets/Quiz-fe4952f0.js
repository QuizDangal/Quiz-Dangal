import{e as Se,u as Ee,k as Te,s as p,l as le,Q as ke,m as ce,b as de,j as e,B as xe,f as ze,d as ue,g as Ce}from"./index-05805094.js";import{r as d}from"./react-63c462fe.js";import{s as Qe,f as De}from"./slots-1f349935.js";import{m as V,AnimatePresence as qe}from"./motion-lite-3d667e23.js";import{S as G}from"./SEO-58a3497b.js";import{L as he,X as pe,b as ae,c as ge,s as be}from"./icons-1e9e0bae.js";import{c as Ae,u as Le,b as Pe}from"./router-d6d570a4.js";import"./supabase-07ebd5d8.js";function me(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function Re(n,m,j={}){const{slotId:l=null}=j,{toast:o}=Se(),{user:c}=Ee(),{isSubscribed:r,subscribeToPush:N}=Te(),[u,C]=d.useState(null),[D,A]=d.useState([]),[g,x]=d.useState(0),[_,H]=d.useState({}),[h,b]=d.useState("loading"),[I,U]=d.useState(0),[S,te]=d.useState(null),[J,se]=d.useState(!1),[ie,ne]=d.useState(!!l),X=d.useCallback(async()=>{if(!(!l||!p))try{const{data:s,error:a}=await p.from("quiz_slots_view").select("*").eq("id",l).maybeSingle();!a&&s&&(te(s),se(s.status==="paused"))}catch(s){}finally{ne(!1)}},[l]);d.useEffect(()=>{X();const s=l?setInterval(X,15e3):null;return()=>{s&&clearInterval(s)}},[X,l]);const[q,Y]=d.useState(!1),[M,L]=d.useState({joined:0,pre_joined:0}),[B,E]=d.useState(!1),[y,T]=d.useState(null),v=d.useRef(null),Z=d.useRef(!0),k=d.useRef([]),O=d.useRef(null);d.useEffect(()=>()=>{Z.current=!1,v.current&&clearTimeout(v.current),O.current&&clearTimeout(O.current)},[]);const K=d.useRef({});d.useEffect(()=>{K.current=_},[_]),d.useEffect(()=>()=>{try{const s=Object.keys(K.current).length>0;if(u&&h==="active"&&y!=="completed"&&(c!=null&&c.id)&&s){let a=p.from("quiz_participants").update({status:"completed"}).eq("user_id",c.id);l?a=a.eq("slot_id",l):a=a.eq("quiz_id",n),a.then(()=>{}).catch(()=>{})}}catch(s){}},[u,n,h,y,c==null?void 0:c.id]);const F=d.useCallback(()=>{if(O.current||k.current.length===0)return;const s=k.current[0],a=2e3*Math.pow(2,(s.attempt||1)-1),i=Math.min(a,3e4);O.current=setTimeout(()=>{O.current=null,z()},i)},[]),z=d.useCallback(async()=>{if(k.current.length===0)return;const s=[...k.current];k.current=[];for(const a of s)if(!(!c||y==="completed"))try{const{error:i}=await p.from("user_answers").upsert({user_id:c.id,question_id:a.questionId,selected_option_id:a.optionId},{onConflict:"user_id,question_id"});if(i)throw i;H(t=>({...t,[a.questionId]:a.optionId}))}catch(i){const t=(a.attempt||1)+1;t<=6?k.current.push({...a,attempt:t}):o({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}k.current.length>0&&F()},[y,c,o,F]);d.useEffect(()=>{const s=()=>z(),a=()=>{me()||z()};return window.addEventListener("online",s),document.addEventListener("visibilitychange",a),()=>{window.removeEventListener("online",s),document.removeEventListener("visibilitychange",a)}},[z]);const $=(M.joined||0)+(M.pre_joined||0),re=h==="active"?M.joined||0:$,P=d.useCallback(async(s=null)=>{const a=s||(u==null?void 0:u.id)||n||l;if(a)try{const{data:i,error:t}=await p.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",a).order("id");if(t){console.error("Questions fetch error:",t),le.error("Failed to load questions",t.message),A([]);return}if(!i||i.length===0){le.warn("No questions found for quiz",a),A([]);return}A(i)}catch(i){console.error("Questions load exception:",i),A([])}},[u==null?void 0:u.id,n,l]),Q=d.useCallback(async()=>{var s,a;if(!n){L({joined:0,pre_joined:0});return}try{const{data:i,error:t}=await p.rpc("get_engagement_counts",{p_quiz_id:n});if(t)console.warn("Engagement counts fetch failed:",t),L({joined:0,pre_joined:0});else{const f=Array.isArray(i)?i[0]:i,w=Number((s=f==null?void 0:f.joined)!=null?s:0),R=Number((a=f==null?void 0:f.pre_joined)!=null?a:0);L({joined:isNaN(w)?0:w,pre_joined:isNaN(R)?0:R})}}catch(i){console.warn("Engagement refresh failed",i)}},[n]),ee=d.useCallback(async()=>{try{let s=null;if(l){const{data:t,error:f}=await p.from("quiz_slots_view").select("*").eq("id",l).maybeSingle();if(f||!t){o({title:"Error",description:"Quiz slot not found.",variant:"destructive"}),m("/");return}s={id:t.quiz_id||t.id,slotId:t.id,title:t.quiz_title,category:t.category,start_time:t.start_time,end_time:t.end_time,status:t.status,prizes:t.prizes,prize_type:"coins",questions:t.questions},te(t)}else{const{data:t,error:f}=await p.from("quizzes").select("*").eq("id",n).single();if(f||!t){o({title:"Error",description:"Quiz not found.",variant:"destructive"}),m("/");return}s=t}C(s);const a=(s==null?void 0:s.id)||n;let i=null;if(c&&c.id&&a){let t=null,f=null;if(l){const w=await p.from("quiz_participants").select("status").eq("user_id",c.id).eq("slot_id",l).maybeSingle();t=w.data,f=w.error}else{const w=await p.from("quiz_participants").select("status").eq("user_id",c.id).eq("quiz_id",a).maybeSingle();t=w.data,f=w.error}!f&&t?(i=t,E(!0),T(t.status||null),i.status==="completed"&&b("completed")):(E(!1),T(null))}else E(!1),T(null);i&&i.status!=="completed"&&await P(s==null?void 0:s.id),await Q()}catch(s){console.error("Error fetching quiz data:",s),o({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),m("/")}},[n,l,c,m,o,P,Q]);d.useEffect(()=>{ee()},[ee]),d.useEffect(()=>{if(!u||h==="completed")return;const s=()=>{const i=new Date,t=S!=null&&S.start_time?new Date(S.start_time):u.start_time?new Date(u.start_time):null,f=S!=null&&S.end_time?new Date(S.end_time):u.end_time?new Date(u.end_time):null,w=t&&i<t,R=t&&f&&i>=t&&i<f;if(J){b("waiting"),U(w&&t?Math.max(0,Math.round((t.getTime()-i.getTime())/1e3)):R&&f?Math.max(0,Math.round((f.getTime()-i.getTime())/1e3)):0);return}if(w){b("waiting"),U(Math.max(0,Math.round((t.getTime()-i.getTime())/1e3)));return}if(R){b("active"),U(Math.max(0,Math.round((f.getTime()-i.getTime())/1e3)));return}b("finished"),U(0)};s();const a=setInterval(s,1e3);return()=>clearInterval(a)},[u,h,S,J]),d.useEffect(()=>{if(!u||!(h==="waiting"||h==="active"))return;const a=setInterval(()=>{me()||Q()},ke);return()=>clearInterval(a)},[u,h,Q]),d.useEffect(()=>{(async()=>{var a,i;if(u&&h==="active"&&c&&!(l&&J))try{if(!B||y==="pre_joined"){let t=!1,f=null;for(let w=0;w<2&&!t;w++){const{error:R}=l?await p.rpc("join_slot",{p_slot_id:l}):await p.rpc("join_quiz",{p_quiz_id:n});if(!R){t=!0;break}f=R;const W=String(R.message||"").toLowerCase();if(W.includes("not active")||W.includes("not ready")){await new Promise(_e=>setTimeout(_e,1500));continue}if(W.includes("already")||W.includes("completed")){t=!0;break}if(W.includes("ended")||W.includes("has ended")){b("finished");break}break}if(t)E(!0),T("joined");else if(f){const{error:w}=l?await p.rpc("pre_join_slot",{p_slot_id:l}):await p.rpc("pre_join_quiz",{p_quiz_id:n});if(!w)E(!0),T("pre_joined");else throw f}}D.length===0&&await P(u==null?void 0:u.id)}catch(t){if(!((a=t==null?void 0:t.message)!=null&&a.includes("already"))&&!((i=t==null?void 0:t.message)!=null&&i.includes("completed"))){const f=ce(t);console.error("Quiz join error:",f,t)}}})()},[u,h,c,B,y,n,l,J,P,D.length,o]),d.useEffect(()=>{const s=Object.keys(_).length>0;h==="finished"&&s&&y==="joined"&&!q&&oe()},[h]),d.useEffect(()=>{if(v.current&&(clearTimeout(v.current),v.current=null),!u||!u.end_time||!(h==="finished"||h==="completed"))return;const s=()=>{(async()=>{try{await de(p,n)}catch(a){}m(`/results/${n}`)})()};try{const a=new Date(u.end_time).getTime(),i=Date.now(),t=Math.max(0,a-i);t===0?s():v.current=setTimeout(()=>{v.current=null,s()},t)}catch(a){console.error("Error calculating redirect time:",a),v.current=setTimeout(()=>{v.current=null,s()},5e3)}return()=>{v.current&&(clearTimeout(v.current),v.current=null)}},[u,n,h,m]);const ye=d.useCallback(async()=>{var s,a;if(u){if(!c){o({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),m("/login");return}if(y!=="completed"){try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!r&&await N()}catch(i){}try{const i=await Qe({supabase:p,quiz:u,user:c});if(i.status==="error")throw i.error;i.status==="already"?(E(!0),T("joined"),o({title:"Already Joined",description:"Starting shortly."})):i.status==="joined"?(E(!0),T("joined"),o({title:"Joined!",description:"Starting now."})):i.status==="pre_joined"?(E(!0),T("joined"),o({title:"Joined!",description:"Quiz starts soon. Stay tuned!"})):i.status==="scheduled_retry"&&(E(!0),T("joined"),o({title:"Joined!",description:"Quiz starts soon. Stay tuned!"})),u.status==="active"&&(i.status==="joined"||i.status==="already")&&(await P(u==null?void 0:u.id),b("active")),Q()}catch(i){if(!((s=i==null?void 0:i.message)!=null&&s.includes("already"))&&!((a=i==null?void 0:i.message)!=null&&a.includes("completed"))){const t=ce(i);console.error("Join quiz error:",t,i),o({title:"Error",description:t||"Could not join quiz. Please try again.",variant:"destructive"})}}}}},[u,c,y,r,N,o,m,Q,P,b]),ve=d.useCallback(async(s,a)=>{if(!(q||h!=="active"||y==="completed")&&c!=null&&c.id)try{const{error:i}=await p.from("user_answers").upsert({user_id:c.id,question_id:s,selected_option_id:a},{onConflict:"user_id,question_id"});if(i)throw i;H(t=>({...t,[s]:a})),g<D.length-1&&(typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>x(t=>t+1)):setTimeout(()=>x(t=>t+1),250))}catch(i){console.error("Error saving answer:",i),k.current.some(f=>f.questionId===s)||o({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),k.current.push({questionId:s,optionId:a,attempt:1}),F()}},[q,h,y,c==null?void 0:c.id,g,D.length,o,F]),oe=d.useCallback(async()=>{if(!q){Y(!0);try{let s=p.from("quiz_participants").update({status:"completed"}).eq("user_id",c.id);l?s=s.eq("slot_id",l):s=s.eq("quiz_id",n);const{error:a}=await s;if(a)throw a;o({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),b("completed");try{await de(p,l||n)}catch(i){}m(l?`/results/slot/${l}`:`/results/${n}`)}catch(s){console.error("Error submitting quiz:",s),o({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{Z.current&&Y(!1)}}},[q,c==null?void 0:c.id,n,o,m]),Ne=d.useCallback(s=>{const a=Math.floor(s/60),i=s%60;return`${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},[]);return{quiz:u,questions:D,currentQuestionIndex:g,answers:_,quizState:h,timeLeft:I,submitting:q,engagement:M,joined:B,participantStatus:y,totalJoined:$,displayJoined:re,slotMeta:S,slotPaused:J,slotLoading:ie,setCurrentQuestionIndex:x,handleJoinOrPrejoin:ye,handleAnswerSelect:ve,handleSubmit:oe,formatTime:Ne}}const je=({startTime:n,endTime:m})=>e.jsxs("div",{className:"mt-2 text-[10px] text-slate-400",children:[e.jsx("div",{className:"mb-1",children:n?ze(n):"â€”"}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-md px-2 py-1",children:[e.jsx("span",{className:"uppercase text-[9px] text-slate-500",children:"Start"}),e.jsx("div",{className:"text-slate-300",children:n?ue(n):"â€”"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-md px-2 py-1",children:[e.jsx("span",{className:"uppercase text-[9px] text-slate-500",children:"End"}),e.jsx("div",{className:"text-slate-300",children:m?ue(m):"â€”"})]})]})]}),we=({prizes:n=[],prizeType:m="coins"})=>{var r,N,u;const j=(r=n[0])!=null?r:0,l=(N=n[1])!=null?N:0,o=(u=n[2])!=null?u:0,c=C=>Ce(m,C,{fallback:0}).formatted;return e.jsxs("div",{className:"mt-2 flex items-center justify-center gap-1.5 text-[10px]",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-600/30",children:["ðŸ¥‡ ",c(j)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-600/30",children:["ðŸ¥ˆ ",c(l)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-600/30",children:["ðŸ¥‰ ",c(o)]})]})},fe=({quizId:n})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx(G,{title:"Quiz â€“ Loading | Quiz Dangal",description:"Loading quiz details.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${n||""}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"text-center",children:[e.jsx(he,{className:"h-16 w-16 animate-spin text-indigo-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Loading quiz..."})]})]}),$e=({message:n})=>e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center text-red-400",children:n||"An error occurred"})}),Je=()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-400",children:"No questions available for this quiz."})})}),Me=({quiz:n,title:m,isActive:j,timeLeft:l,displayJoined:o,prizes:c,prizeType:r,formatTime:N,onJoin:u,onClose:C})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center px-3 pt-16",children:[e.jsx(G,{title:`${m} â€“ Lobby | Quiz Dangal`,description:"Join the quiz lobby.",robots:"noindex, nofollow"}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:e.jsxs("div",{className:"relative rounded-xl bg-slate-900/95 p-4 text-center",children:[e.jsx("button",{"aria-label":"Close",onClick:C,className:"absolute top-3 right-3 text-slate-500 hover:text-white transition",children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-12 h-12 mx-auto mb-3 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center",children:e.jsx(ae,{className:"h-6 w-6 text-white"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:m}),e.jsx("p",{className:"text-[11px] text-slate-400 mb-2",children:j?"Quiz is live!":"Quiz starts in"}),e.jsx("div",{className:"text-2xl font-bold text-indigo-300 mb-2",children:N(l)}),e.jsxs("div",{className:"flex items-center justify-center gap-1 text-[11px] text-slate-400 mb-2",children:[e.jsx(ge,{className:"h-3 w-3"}),o," joined"]}),e.jsx(we,{prizes:c,prizeType:r}),e.jsx(je,{startTime:n==null?void 0:n.start_time,endTime:n==null?void 0:n.end_time}),e.jsx("div",{className:"mt-4",children:e.jsx(xe,{onClick:u,className:`w-full h-10 text-sm font-bold ${j?"bg-gradient-to-r from-emerald-600 to-green-500":"bg-gradient-to-r from-indigo-600 to-violet-600"} hover:opacity-90`,children:j?"Join & Start":"Pre-Join"})})]})})})]}),Oe=({quiz:n,title:m,timeLeft:j,totalJoined:l,prizes:o,prizeType:c,formatTime:r,onClose:N})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(G,{title:`${m} â€“ Waiting | Quiz Dangal`,description:"Waiting for the quiz to start.",robots:"noindex, nofollow"}),e.jsx(V.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:e.jsxs("div",{className:"relative rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("button",{"aria-label":"Close",onClick:N,className:"absolute top-2 right-2 text-slate-400 hover:text-slate-200 transition",children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(ae,{className:"h-6 w-6 text-indigo-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1 line-clamp-2",children:m}),e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-2xl font-bold text-indigo-300 mb-2",children:r(j)}),e.jsxs("div",{className:"flex items-center justify-center gap-1 text-xs text-slate-400 mb-2",children:[e.jsx(ge,{className:"h-3 w-3"}),l," joined"]}),e.jsx(we,{prizes:o,prizeType:c}),e.jsx(je,{startTime:n==null?void 0:n.start_time,endTime:n==null?void 0:n.end_time}),e.jsx("p",{className:"mt-2 text-[10px] text-slate-500",children:"Auto-starts when timer hits zero"})]})})})]}),Fe=({title:n,onNavigateHome:m})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(G,{title:`${n} â€“ Completed | Quiz Dangal`,description:"Quiz completed. Results will be published soon.",robots:"noindex, nofollow"}),e.jsx(V.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-emerald-500/50 via-green-500/40 to-teal-500/50",children:e.jsxs("div",{className:"rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(be,{className:"h-6 w-6 text-emerald-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:"Quiz Submitted!"}),e.jsx("p",{className:"text-xs text-slate-400 mb-2",children:"Thank you for participating!"}),e.jsx("p",{className:"text-sm text-slate-300 mb-3",children:"Results will be published soon."}),e.jsx("button",{onClick:m,className:"mt-3 w-full h-9 rounded-lg text-xs font-bold text-white bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90 transition",children:"Back to Home"})]})})})]}),Ve=({title:n,onNavigateHome:m})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(G,{title:`${n} â€“ Time's Up | Quiz Dangal`,description:"Quiz time ended.",robots:"noindex, nofollow"}),e.jsx(V.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-amber-500/50 via-orange-500/40 to-red-500/50",children:e.jsxs("div",{className:"rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-amber-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(ae,{className:"h-6 w-6 text-amber-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:"Time's Up!"}),e.jsx("p",{className:"text-xs text-slate-400 mb-4",children:"This quiz has ended. Try the next one!"}),e.jsx("button",{onClick:m,className:"w-full h-9 rounded-lg text-xs font-bold text-white bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90 transition",children:"Browse Quizzes"})]})})})]}),He=({title:n,quizId:m,questions:j,currentQuestionIndex:l,answers:o,timeLeft:c,submitting:r,quizState:N,participantStatus:u,formatTime:C,onAnswerSelect:D,onSubmit:A})=>{const g=j[l],x=(l+1)/j.length*100;return e.jsxs("div",{className:"min-h-screen px-3 pt-16 pb-6",children:[e.jsx(G,{title:`${n} â€“ Play | Quiz Dangal`,description:"Answer questions and compete to win.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${m}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"max-w-md mx-auto space-y-3",children:[e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:e.jsxs("div",{className:"rounded-xl bg-slate-900/95 p-3",children:[e.jsxs("div",{className:"flex justify-between items-center gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-sm font-bold text-white truncate",children:n}),e.jsxs("p",{className:"text-[10px] text-slate-400",children:["Q",l+1," of ",j.length]})]}),e.jsxs("div",{className:"shrink-0 text-right",children:[e.jsx("div",{className:"text-lg font-bold text-rose-400 tabular-nums",children:C(c)}),e.jsx("div",{className:"text-[9px] text-slate-500 uppercase",children:"Time Left"})]})]}),e.jsx("div",{className:"mt-2 w-full bg-slate-800 rounded-full h-1.5 overflow-hidden",children:e.jsx(V.div,{className:"h-1.5 rounded-full bg-gradient-to-r from-cyan-400 via-indigo-500 to-fuchsia-500",style:{width:`${x}%`},transition:{duration:.3}})})]})}),e.jsx(qe,{mode:"wait",children:e.jsxs(V.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.2},className:"rounded-xl border border-slate-700/60 bg-slate-900/90 p-4",children:[e.jsx("h2",{className:"text-sm font-bold text-center text-white mb-4 leading-relaxed",children:g==null?void 0:g.question_text}),e.jsx("div",{className:"space-y-2",children:((g==null?void 0:g.options)||[]).map((_,H)=>{const h=o[g==null?void 0:g.id]===_.id;return e.jsxs(V.button,{onClick:()=>D(g.id,_.id),disabled:r||N!=="active"||u==="completed",whileTap:{scale:.98},className:`w-full p-3 rounded-lg text-left text-sm font-medium transition-all border ${h?"bg-emerald-600/90 text-white border-emerald-500 shadow-lg":"bg-slate-800/60 hover:bg-slate-800 text-slate-200 border-slate-700/60"}`,children:[e.jsxs("span",{className:`font-bold mr-2 ${h?"text-white":"text-indigo-400"}`,children:[String.fromCharCode(65+H),"."]}),_.option_text]},_.id)})}),l===j.length-1&&Object.keys(o).length===j.length&&e.jsx(V.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},className:"mt-4",children:e.jsx(xe,{onClick:A,disabled:r,className:"w-full h-11 text-sm font-bold bg-gradient-to-r from-indigo-600 via-violet-600 to-fuchsia-600 hover:opacity-90",children:r?e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"mr-2 h-4 w-4 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Submit Quiz"]})})})]},(g==null?void 0:g.id)||l)})]})]})},Ke=()=>{const{id:n,slotId:m}=Ae(),j=Le(),l=Pe(),o=j.pathname.includes("/quiz/slot/"),c=o?m:n,[r,N]=d.useState(null),[u,C]=d.useState(o),[D,A]=d.useState(null),g=d.useCallback(async()=>{if(!(!o||!m)){if(!p){A("Supabase not configured"),C(!1);return}try{const{data:z,error:$}=await p.from("quiz_slots_view").select("*").eq("id",m).maybeSingle();if($)throw $;if(!z)throw new Error("Slot not found");N(z),C(!1)}catch(z){A(z.message||"Failed to load slot"),C(!1)}}},[o,m]);d.useEffect(()=>{o&&g()},[o,g]);const{quiz:x,questions:_,currentQuestionIndex:H,answers:h,quizState:b,timeLeft:I,submitting:U,joined:S,participantStatus:te,totalJoined:J,displayJoined:se,handleJoinOrPrejoin:ie,handleAnswerSelect:ne,handleSubmit:X,formatTime:q}=Re(o?r==null?void 0:r.id:n,l,o?{slotId:m}:void 0);d.useEffect(()=>{if(!o||b!=="finished"&&b!=="completed"||!(r!=null&&r.id)||!(r!=null&&r.category))return;let z=!1;return(async()=>{try{const{slots:$}=await De(p,r.category),re=r.end_time?new Date(r.end_time).getTime():Date.now(),P=($||[]).filter(Q=>Q.start_time?new Date(Q.start_time).getTime()>re:!1).sort((Q,ee)=>new Date(Q.start_time).getTime()-new Date(ee.start_time).getTime());!z&&P[0]&&l("/quiz/slot/"+P[0].slotId)}catch($){}})(),()=>{z=!0}},[o,b,r==null?void 0:r.id,r==null?void 0:r.category,r==null?void 0:r.end_time,l]);const Y=()=>{window.history.length>1?l(-1):l("/")},M=()=>l("/");if(o&&u)return e.jsx(fe,{quizId:c});if(o&&D)return e.jsx($e,{message:D});if(b==="loading"||!o&&!x||o&&!r)return e.jsx(fe,{quizId:c});const L=o?(r==null?void 0:r.quiz_title)||(x==null?void 0:x.title)||"Quiz":(x==null?void 0:x.title)||"Quiz",B=o?Array.isArray(r==null?void 0:r.prizes)?r.prizes:[]:Array.isArray(x==null?void 0:x.prizes)?x.prizes:[],E=o?"coins":(x==null?void 0:x.prize_type)||"coins",y=o?r==null?void 0:r.start_time:x==null?void 0:x.start_time,T=o?r==null?void 0:r.end_time:x==null?void 0:x.end_time,v=new Date,Z=y?new Date(y):null,k=T?new Date(T):null,O=Z&&k&&v>=Z&&v<k,K=o?{start_time:r==null?void 0:r.start_time,end_time:r==null?void 0:r.end_time}:x;if(!S&&b!=="completed")return e.jsx(Me,{quiz:K,title:L,isActive:O,timeLeft:I,displayJoined:se,prizes:B,prizeType:E,formatTime:q,onJoin:ie,onClose:Y});if(b==="waiting")return e.jsx(Oe,{quiz:K,title:L,timeLeft:I,totalJoined:J,prizes:B,prizeType:E,formatTime:q,onClose:Y});const F=Object.keys(h).length>0;return b==="completed"||b==="finished"&&F?e.jsx(Fe,{title:L,onNavigateHome:M}):b==="finished"&&!F?e.jsx(Ve,{title:L,onNavigateHome:M}):!_||_.length===0?e.jsx(Je,{}):e.jsx(He,{title:L,quizId:c,questions:_,currentQuestionIndex:H,answers:h,timeLeft:I,submitting:U,quizState:b,participantStatus:te,formatTime:q,onAnswerSelect:ne,onSubmit:X})};export{Ke as default};
