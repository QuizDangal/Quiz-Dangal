import{e as Pe,u as De,k as Le,d as j,l as ge,Q as $e,m as je,c as be,j as e,S as W,B as xe,o as Je,f as ye,b as Oe}from"./index-596f72a9.js";import{r as a}from"./react-63c462fe.js";import{s as Me}from"./smartJoinQuiz-fc0dc321.js";import{m as M,AnimatePresence as Fe}from"./motion-lite-a13d6934.js";import{n as _e,X as Se,f as oe,g as Ee,K as ze,O as Ve,s as He}from"./icons-d9b262e9.js";import{c as Ue,b as Be,u as We}from"./router-5fd03704.js";import"./supabase-24c2e735.js";function we(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function Ge(i,x,y={}){const{slotId:o=null}=y,{toast:l}=Pe(),{user:d}=De(),{isSubscribed:f,subscribeToPush:N}=Le(),[u,C]=a.useState(null),[D,q]=a.useState([]),[G,m]=a.useState(0),[Q,F]=a.useState({}),[g,p]=a.useState("loading"),[L,$]=a.useState(null),[J,O]=a.useState(0),[b,re]=a.useState(null),[V,le]=a.useState(!1),[ce,de]=a.useState(!!o),K=a.useCallback(t=>{var n,c,h,E,te,P;const r=Number((h=(c=(n=t==null?void 0:t.participants_joined)!=null?n:t==null?void 0:t.joined_count)!=null?c:t==null?void 0:t.joined)!=null?h:0),s=Number((P=(te=(E=t==null?void 0:t.participants_pre)!=null?E:t==null?void 0:t.pre_joined_count)!=null?te:t==null?void 0:t.pre_joined)!=null?P:0);return{joined:Number.isFinite(r)?r:0,pre_joined:Number.isFinite(s)?s:0}},[]),R=a.useCallback(async()=>{if(!(!o||!j))try{const{data:t,error:r}=await j.from("quiz_slots_view").select("*").eq("id",o).maybeSingle();!r&&t&&(re(t),le(t.status==="paused"),z(K(t)))}catch(t){}finally{de(!1)}},[o,K]);a.useEffect(()=>{R();const t=o?setInterval(R,3e4):null;return()=>{t&&clearInterval(t)}},[R,o]);const[A,se]=a.useState(!1),[H,z]=a.useState({joined:0,pre_joined:0}),[U,S]=a.useState(!1),[_,k]=a.useState(null),w=a.useRef(null),ie=a.useRef(!0),v=a.useRef([]),B=a.useRef(null),X=a.useRef(null),Y=a.useRef(!1),T=a.useRef(null);a.useEffect(()=>()=>{ie.current=!1,w.current&&clearTimeout(w.current),B.current&&clearTimeout(B.current)},[]);const ne=a.useRef({});a.useEffect(()=>{ne.current=Q},[Q]);const ae=a.useCallback(()=>{if(B.current||v.current.length===0)return;const t=v.current[0],r=2e3*Math.pow(2,(t.attempt||1)-1),s=Math.min(r,3e4);B.current=setTimeout(()=>{B.current=null,Z()},s)},[]),Z=a.useCallback(async()=>{if(v.current.length===0)return;const t=[...v.current];v.current=[];for(const r of t)if(!(!d||_==="completed"))try{const{error:s}=await j.from("user_answers").upsert({user_id:d.id,question_id:r.questionId,selected_option_id:r.optionId},{onConflict:"user_id,question_id"});if(s)throw s;F(n=>({...n,[r.questionId]:r.optionId}))}catch(s){const n=(r.attempt||1)+1;n<=6?v.current.push({...r,attempt:n}):l({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}v.current.length>0&&ae()},[_,d,l,ae]);a.useEffect(()=>{const t=()=>Z(),r=()=>{we()||Z()};return window.addEventListener("online",t),document.addEventListener("visibilitychange",r),()=>{window.removeEventListener("online",t),document.removeEventListener("visibilitychange",r)}},[Z]);const he=(H.joined||0)+(H.pre_joined||0),Qe=g==="active"?H.joined||0:he,I=a.useCallback(async(t=null,r=!1)=>{const s=t||(u==null?void 0:u.id)||i||o;if(s&&!(!r&&T.current===s)){T.current=s;try{const{data:n,error:c}=await j.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",s).order("id");if(c){console.error("Questions fetch error:",c),ge.error("Failed to load questions",c.message),q([]);return}if(!n||n.length===0){ge.warn("No questions found for quiz",s),q([]);return}q(n)}catch(n){console.error("Questions load exception:",n),q([])}}},[u==null?void 0:u.id,i,o]),ee=a.useCallback(async()=>{var t,r;if(o){if(b){z(K(b));return}await R();return}if(!i){z({joined:0,pre_joined:0});return}try{const{data:s,error:n}=await j.rpc("get_engagement_counts",{p_quiz_id:i});if(n)console.warn("Engagement counts fetch failed:",n),z({joined:0,pre_joined:0});else{const c=Array.isArray(s)?s[0]:s,h=Number((t=c==null?void 0:c.joined)!=null?t:0),E=Number((r=c==null?void 0:c.pre_joined)!=null?r:0);z({joined:isNaN(h)?0:h,pre_joined:isNaN(E)?0:E})}}catch(s){console.warn("Engagement refresh failed",s)}},[i,o,b,R,K]),pe=a.useCallback(async()=>{try{$(null);let t=null;if(o){const{data:n,error:c}=await j.from("quiz_slots_view").select("*").eq("id",o).maybeSingle();if(c||!n){const h="Quiz slot not found.";l({title:"Error",description:h,variant:"destructive"}),$(h),p("error");return}t={id:n.quiz_id||n.id,slotId:n.id,title:n.quiz_title,category:n.category,start_time:n.start_time,end_time:n.end_time,status:n.status,prizes:n.prizes,prize_type:"coins",questions:n.questions},re(n)}else{const{data:n,error:c}=await j.from("quizzes").select("*").eq("id",i).single();if(c||!n){const h="Quiz not found.";l({title:"Error",description:h,variant:"destructive"}),$(h),p("error");return}t=n}C(t);const r=(t==null?void 0:t.id)||i;let s=null;if(d&&d.id&&r){let n=null,c=null;if(o){const h=await j.from("quiz_participants").select("status").eq("user_id",d.id).eq("slot_id",o).maybeSingle();n=h.data,c=h.error}else{const h=await j.from("quiz_participants").select("status").eq("user_id",d.id).eq("quiz_id",r).maybeSingle();n=h.data,c=h.error}!c&&n?(s=n,S(!0),k(n.status||null),s.status==="completed"&&p("completed")):(S(!1),k(null))}else S(!1),k(null);s&&s.status!=="completed"&&await I(t==null?void 0:t.id),await ee()}catch(t){console.error("Error fetching quiz data:",t);const r="Failed to load quiz. Please check your internet and try again.";l({title:"Error",description:r,variant:"destructive"}),$(r),p("error")}},[i,o,d,x,l,I,ee]);a.useEffect(()=>{Y.current=!1,T.current=null},[i,o]),a.useEffect(()=>{pe()},[pe]),a.useEffect(()=>{if(!u||g==="completed"||g==="error")return;const t=()=>{const s=new Date,n=b!=null&&b.start_time?new Date(b.start_time):u.start_time?new Date(u.start_time):null,c=b!=null&&b.end_time?new Date(b.end_time):u.end_time?new Date(u.end_time):null,h=n&&s<n,E=n&&c&&s>=n&&s<c;if(V){p("waiting"),O(h&&n?Math.max(0,Math.round((n.getTime()-s.getTime())/1e3)):E&&c?Math.max(0,Math.round((c.getTime()-s.getTime())/1e3)):0);return}if(h){p("waiting"),O(Math.max(0,Math.round((n.getTime()-s.getTime())/1e3)));return}if(E){p("active"),O(Math.max(0,Math.round((c.getTime()-s.getTime())/1e3)));return}p("finished"),O(0)};t();const r=setInterval(t,1e3);return()=>clearInterval(r)},[u,g,b,V]),a.useEffect(()=>{if(!u||!(g==="waiting"||g==="active"))return;const r=setInterval(()=>{we()||ee()},$e);return()=>clearInterval(r)},[u,g,ee]),a.useEffect(()=>{(async()=>{var s,n;if(!u||g!=="active"||!d||o&&V)return;const r=o||i;if(!(Y.current===r&&U))try{if(!U||_==="pre_joined"){Y.current=r;let c=!1,h=null;for(let E=0;E<2&&!c;E++){const{error:te}=o?await j.rpc("join_slot",{p_slot_id:o}):await j.rpc("join_quiz",{p_quiz_id:i});if(!te){c=!0;break}h=te;const P=String(te.message||"").toLowerCase();if(P.includes("not active")||P.includes("not ready")){await new Promise(Ae=>setTimeout(Ae,1500));continue}if(P.includes("already")||P.includes("completed")){c=!0;break}if(P.includes("ended")||P.includes("has ended")){p("finished");break}break}if(c)S(!0),k("joined");else if(h){const{error:E}=o?await j.rpc("pre_join_slot",{p_slot_id:o}):await j.rpc("pre_join_quiz",{p_quiz_id:i});if(!E)S(!0),k("pre_joined");else throw S(!0),h}}D.length===0&&await I(u==null?void 0:u.id)}catch(c){if(!((s=c==null?void 0:c.message)!=null&&s.includes("already"))&&!((n=c==null?void 0:c.message)!=null&&n.includes("completed"))){const h=je(c);console.error("Quiz join error:",h,c)}}})()},[u,g,d,U,_,i,o,V,I,D.length,l]),a.useEffect(()=>{if(w.current&&(clearTimeout(w.current),w.current=null),!u||!u.end_time||!(g==="finished"||g==="completed"))return;const t=()=>{(async()=>{try{await be(j,i)}catch(r){}x(`/results/${i}`)})()};try{const r=new Date(u.end_time).getTime(),s=Date.now(),n=Math.max(0,r-s);n===0?t():w.current=setTimeout(()=>{w.current=null,t()},n)}catch(r){console.error("Error calculating redirect time:",r),w.current=setTimeout(()=>{w.current=null,t()},5e3)}return()=>{w.current&&(clearTimeout(w.current),w.current=null)}},[u,i,g,x]);const Te=a.useCallback(async()=>{var t,r;if(u){if(!d){l({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),x("/login");return}if(_!=="completed"){try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!f&&await N()}catch(s){}try{const s=await Me({supabase:j,quiz:u,user:d});if(s.status==="error")throw s.error;s.status==="already"?(S(!0),k("joined"),l({title:"Already Joined",description:"Starting shortly."})):s.status==="joined"?(S(!0),k("joined"),l({title:"Joined!",description:"Starting now."})):s.status==="pre_joined"?(S(!0),k("joined"),l({title:"Joined!",description:"Quiz starts soon. Stay tuned!"})):s.status==="scheduled_retry"&&(S(!0),k("joined"),l({title:"Joined!",description:"Quiz starts soon. Stay tuned!"})),u.status==="active"&&(s.status==="joined"||s.status==="already")&&(await I(u==null?void 0:u.id),p("active")),ee()}catch(s){if(!((t=s==null?void 0:s.message)!=null&&t.includes("already"))&&!((r=s==null?void 0:s.message)!=null&&r.includes("completed"))){const n=je(s);console.error("Join quiz error:",n,s),l({title:"Error",description:n||"Could not join quiz. Please try again.",variant:"destructive"})}}}}},[u,d,_,f,N,l,x,ee,I,p]),qe=a.useCallback(async(t,r)=>{if(!(A||g!=="active"||_==="completed")&&d!=null&&d.id){F(s=>({...s,[t]:r}));try{const{error:s}=await j.from("user_answers").upsert({user_id:d.id,question_id:t,selected_option_id:r},{onConflict:"user_id,question_id"});if(s)throw s}catch(s){console.error("Error saving answer:",s),v.current.some(c=>c.questionId===t)||l({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),v.current=v.current.filter(c=>c.questionId!==t),v.current.push({questionId:t,optionId:r,attempt:1}),ae()}}},[A,g,_,d==null?void 0:d.id,l,ae]),ue=a.useCallback(async()=>{if(!A&&d!=null&&d.id){se(!0);try{if(await Z(),v.current.length>0){l({title:"Sync pending",description:"Some answers are still syncing. Please check internet and try again.",variant:"destructive"});return}let t=j.from("quiz_participants").update({status:"completed"}).eq("user_id",d.id);o?t=t.eq("slot_id",o):t=t.eq("quiz_id",i);const{error:r}=await t;if(r)throw r;l({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),p("completed");try{await be(j,o||i)}catch(s){}x(o?`/results/slot/${o}`:`/results/${i}`)}catch(t){console.error("Error submitting quiz:",t),l({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{ie.current&&se(!1)}}},[A,d==null?void 0:d.id,i,o,l,x,Z]);a.useEffect(()=>{X.current=ue},[ue]);const me=a.useRef(null),fe=a.useRef(null);a.useEffect(()=>{fe.current=null,me.current=null},[i,o]),a.useEffect(()=>{const t=me.current;if(me.current=g,g!=="finished"||t==="finished")return;const r=o?`slot:${o}`:`quiz:${i}`;if(fe.current===r)return;Object.keys(ne.current||{}).length>0&&_==="joined"&&!A&&(fe.current=r,typeof X.current=="function"&&X.current())},[g,_,A,i,o]);const Re=a.useCallback(t=>{const r=Math.floor(t/60),s=t%60;return`${r.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},[]);return{quiz:u,questions:D,currentQuestionIndex:G,answers:Q,quizState:g,error:L,timeLeft:J,submitting:A,engagement:H,joined:U,participantStatus:_,totalJoined:he,displayJoined:Qe,slotMeta:b,slotPaused:V,slotLoading:ce,setCurrentQuestionIndex:m,handleJoinOrPrejoin:Te,handleAnswerSelect:qe,handleSubmit:ue,formatTime:Re}}const ke=({startTime:i,endTime:x})=>e.jsxs("div",{className:"mt-2 text-[10px] text-slate-400",children:[e.jsx("div",{className:"mb-1",children:i?Je(i):"â€”"}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-md px-2 py-1",children:[e.jsx("span",{className:"uppercase text-[9px] text-slate-500",children:"Start"}),e.jsx("div",{className:"text-slate-300",children:i?ye(i):"â€”"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-md px-2 py-1",children:[e.jsx("span",{className:"uppercase text-[9px] text-slate-500",children:"End"}),e.jsx("div",{className:"text-slate-300",children:x?ye(x):"â€”"})]})]})]}),Ce=({prizes:i=[],prizeType:x="coins"})=>{var f,N,u;const y=(f=i[0])!=null?f:0,o=(N=i[1])!=null?N:0,l=(u=i[2])!=null?u:0,d=C=>Oe(x,C,{fallback:0}).formatted;return e.jsxs("div",{className:"mt-2 flex items-center justify-center gap-1.5 text-[10px]",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-600/30",children:["ðŸ¥‡ ",d(y)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-600/30",children:["ðŸ¥ˆ ",d(o)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-600/30",children:["ðŸ¥‰ ",d(l)]})]})},ve=({quizId:i})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx(W,{title:"Quiz â€“ Loading | Quiz Dangal",description:"Loading quiz details.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${i||""}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"text-center",children:[e.jsx(_e,{className:"h-16 w-16 animate-spin text-indigo-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400",children:"Loading quiz..."})]})]}),Ne=({message:i})=>e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center text-red-400",children:i||"An error occurred"})}),Ke=()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-400",children:"No questions available for this quiz."})})}),Xe=({quiz:i,title:x,isActive:y,timeLeft:o,displayJoined:l,prizes:d,prizeType:f,formatTime:N,onJoin:u,onClose:C})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center px-3 pt-16",children:[e.jsx(W,{title:`${x} â€“ Lobby | Quiz Dangal`,description:"Join the quiz lobby.",robots:"noindex, nofollow"}),e.jsx("div",{className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:e.jsxs("div",{className:"relative rounded-xl bg-slate-900/95 p-4 text-center",children:[e.jsx("button",{"aria-label":"Close",onClick:C,className:"absolute top-3 right-3 text-slate-500 hover:text-white transition",children:e.jsx(Se,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-12 h-12 mx-auto mb-3 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center",children:e.jsx(oe,{className:"h-6 w-6 text-white"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:x}),e.jsx("p",{className:"text-[11px] text-slate-400 mb-2",children:y?"Quiz is live!":"Quiz starts in"}),e.jsx("div",{className:"text-2xl font-bold text-indigo-300 mb-2",children:N(o)}),e.jsxs("div",{className:"flex items-center justify-center gap-1 text-[11px] text-slate-400 mb-2",children:[e.jsx(Ee,{className:"h-3 w-3"}),l," joined"]}),e.jsx(Ce,{prizes:d,prizeType:f}),e.jsx(ke,{startTime:i==null?void 0:i.start_time,endTime:i==null?void 0:i.end_time}),e.jsx("div",{className:"mt-4",children:e.jsx(xe,{onClick:u,className:`w-full h-10 text-sm font-bold ${y?"bg-gradient-to-r from-emerald-600 to-green-500":"bg-gradient-to-r from-indigo-600 to-violet-600"} hover:opacity-90`,children:y?"Join & Start":"Pre-Join"})})]})})})]}),Ye=({quiz:i,title:x,timeLeft:y,totalJoined:o,prizes:l,prizeType:d,formatTime:f,onClose:N})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(W,{title:`${x} â€“ Waiting | Quiz Dangal`,description:"Waiting for the quiz to start.",robots:"noindex, nofollow"}),e.jsx(M.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-indigo-500/50 via-violet-500/40 to-fuchsia-500/50",children:e.jsxs("div",{className:"relative rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("button",{"aria-label":"Close",onClick:N,className:"absolute top-2 right-2 text-slate-400 hover:text-slate-200 transition",children:e.jsx(Se,{className:"h-4 w-4"})}),e.jsx("div",{className:"w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(oe,{className:"h-6 w-6 text-indigo-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1 line-clamp-2",children:x}),e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-2xl font-bold text-indigo-300 mb-2",children:f(y)}),e.jsxs("div",{className:"flex items-center justify-center gap-1 text-xs text-slate-400 mb-2",children:[e.jsx(Ee,{className:"h-3 w-3"}),o," joined"]}),e.jsx(Ce,{prizes:l,prizeType:d}),e.jsx(ke,{startTime:i==null?void 0:i.start_time,endTime:i==null?void 0:i.end_time}),e.jsx("p",{className:"mt-2 text-[10px] text-slate-500",children:"Auto-starts when timer hits zero"})]})})})]}),Ze=({title:i,onNavigateHome:x})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(W,{title:`${i} â€“ Completed | Quiz Dangal`,description:"Quiz completed. Results will be published soon.",robots:"noindex, nofollow"}),e.jsx(M.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-emerald-500/50 via-green-500/40 to-teal-500/50",children:e.jsxs("div",{className:"rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(ze,{className:"h-6 w-6 text-emerald-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:"Quiz Submitted!"}),e.jsx("p",{className:"text-xs text-slate-400 mb-2",children:"Thank you for participating!"}),e.jsx("p",{className:"text-sm text-slate-300 mb-3",children:"Results will be published soon."}),e.jsx("button",{onClick:x,className:"mt-3 w-full h-9 rounded-lg text-xs font-bold text-white bg-gradient-to-r from-emerald-600 to-green-500 hover:opacity-90 transition",children:"Back to Home"})]})})})]}),Ie=({title:i,onNavigateHome:x})=>e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 pt-16 sm:pt-20",children:[e.jsx(W,{title:`${i} â€“ Time's Up | Quiz Dangal`,description:"Quiz time ended.",robots:"noindex, nofollow"}),e.jsx(M.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"w-full max-w-sm",children:e.jsx("div",{className:"p-[1px] rounded-xl bg-gradient-to-r from-amber-500/50 via-orange-500/40 to-red-500/50",children:e.jsxs("div",{className:"rounded-xl bg-slate-900/95 backdrop-blur-sm p-4 text-center",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-amber-500/20 flex items-center justify-center mx-auto mb-2",children:e.jsx(oe,{className:"h-6 w-6 text-amber-300"})}),e.jsx("h2",{className:"text-base font-bold text-white mb-1",children:"Time's Up!"}),e.jsx("p",{className:"text-xs text-slate-400 mb-4",children:"This quiz has ended. Try the next one!"}),e.jsx("button",{onClick:x,className:"w-full h-9 rounded-lg text-xs font-bold text-white bg-gradient-to-r from-indigo-600 to-violet-600 hover:opacity-90 transition",children:"Browse Quizzes"})]})})})]}),et=({title:i,quizId:x,questions:y,currentQuestionIndex:o,answers:l,timeLeft:d,submitting:f,quizState:N,participantStatus:u,formatTime:C,onAnswerSelect:D,onNext:q,onSubmit:G})=>{const m=y[o],Q=(o+1)/y.length*100,F=o===y.length-1,g=l[m==null?void 0:m.id]!==void 0,p=Object.keys(l).length,L=y.length,$=g&&N==="active"&&u!=="completed";return e.jsxs("div",{className:"min-h-screen px-3 pt-16 pb-6",children:[e.jsx(W,{title:`${i} â€“ Play | Quiz Dangal`,description:"Answer questions and compete to win.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${x}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"max-w-md mx-auto space-y-4",children:[e.jsxs("div",{className:"quiz-header-card",children:[e.jsx("div",{className:"quiz-header-glow"}),e.jsxs("div",{className:"quiz-header-content",children:[e.jsxs("div",{className:"flex justify-between items-center gap-3",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-sm font-bold text-white truncate",children:i}),e.jsxs("p",{className:"text-[10px] text-slate-400 mt-0.5",children:["Question ",o+1," of ",y.length]})]}),e.jsx("div",{className:"shrink-0 text-right",children:e.jsxs("div",{className:"quiz-timer",children:[e.jsx(oe,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:C(d)})]})})]}),e.jsx("div",{className:"mt-3 w-full bg-slate-800/80 rounded-full h-2 overflow-hidden",children:e.jsx(M.div,{className:"h-2 rounded-full bg-gradient-to-r from-cyan-400 via-indigo-500 to-fuchsia-500",initial:!1,animate:{width:`${Q}%`},transition:{duration:.4,ease:"easeOut"}})})]})]}),e.jsx(Fe,{mode:"wait",children:e.jsxs(M.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.25,ease:"easeOut"},className:"quiz-question-card",children:[e.jsxs("div",{className:"quiz-question-badge",children:["Q",o+1]}),e.jsx("h2",{className:"text-base font-semibold text-center text-white mb-5 leading-relaxed px-2",children:m==null?void 0:m.question_text}),e.jsx("div",{className:"space-y-3",children:((m==null?void 0:m.options)||[]).map((J,O)=>{const b=l[m==null?void 0:m.id]===J.id;return e.jsxs(M.button,{onClick:()=>D(m.id,J.id),disabled:f||N!=="active"||u==="completed",whileTap:{scale:.98},className:`quiz-option ${b?"quiz-option-selected":""}`,children:[e.jsx("span",{className:`quiz-option-letter ${b?"quiz-option-letter-selected":""}`,children:String.fromCharCode(65+O)}),e.jsx("span",{className:"flex-1 text-left",children:J.option_text}),b&&e.jsx(M.div,{initial:{scale:0},animate:{scale:1},className:"quiz-option-check",children:e.jsx(ze,{className:"w-4 h-4"})})]},J.id)})}),$&&e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.15},className:"mt-5",children:F?e.jsx(xe,{onClick:G,disabled:f,className:"quiz-submit-btn",children:f?e.jsxs(e.Fragment,{children:[e.jsx(_e,{className:"mr-2 h-4 w-4 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"mr-2 h-4 w-4"}),"Submit Quiz (",p,"/",L,")"]})}):e.jsxs(xe,{onClick:q,className:"quiz-next-btn",children:[e.jsx("span",{children:"Next Question"}),e.jsx(He,{className:"ml-1 h-5 w-5"})]})})]},(m==null?void 0:m.id)||o)}),e.jsx("div",{className:"quiz-progress-indicator",children:e.jsxs("span",{children:[p," of ",L," answered"]})})]})]})},lt=()=>{const{id:i,slotId:x}=Ue(),y=Be(),o=We(),l=y.pathname.includes("/quiz/slot/"),d=l?x:i,[f,N]=a.useState(null),[u,C]=a.useState(l),[D,q]=a.useState(null),G=a.useCallback(async()=>{if(!(!l||!x)){if(!j){q("Supabase not configured"),C(!1);return}try{const{data:T,error:ne}=await j.from("quiz_slots_view").select("*").eq("id",x).maybeSingle();if(ne)throw ne;if(!T)throw new Error("Slot not found");N(T),C(!1)}catch(T){q(T.message||"Failed to load slot"),C(!1)}}},[l,x]);a.useEffect(()=>{l&&G()},[l,G]);const{quiz:m,questions:Q,currentQuestionIndex:F,answers:g,quizState:p,timeLeft:L,submitting:$,joined:J,participantStatus:O,error:b,totalJoined:re,displayJoined:V,setCurrentQuestionIndex:le,handleJoinOrPrejoin:ce,handleAnswerSelect:de,handleSubmit:K,formatTime:R}=Ge(l?f==null?void 0:f.id:i,o,l?{slotId:x}:void 0),A=()=>{F<Q.length-1&&le(T=>T+1)},se=()=>{window.history.length>1?o(-1):o("/")},H=()=>o("/");if(l&&u)return e.jsx(ve,{quizId:d});if(l&&D)return e.jsx(Ne,{message:D});if(p==="error")return e.jsx(Ne,{message:b||"Something went wrong. Please try again."});if(p==="loading"||!l&&!m||l&&!f)return e.jsx(ve,{quizId:d});const z=l?(f==null?void 0:f.quiz_title)||(m==null?void 0:m.title)||"Quiz":(m==null?void 0:m.title)||"Quiz",U=l?Array.isArray(f==null?void 0:f.prizes)?f.prizes:[]:Array.isArray(m==null?void 0:m.prizes)?m.prizes:[],S=l?"coins":(m==null?void 0:m.prize_type)||"coins",_=l?f==null?void 0:f.start_time:m==null?void 0:m.start_time,k=l?f==null?void 0:f.end_time:m==null?void 0:m.end_time,w=new Date,ie=_?new Date(_):null,v=k?new Date(k):null,B=ie&&v&&w>=ie&&w<v,X=l?{start_time:f==null?void 0:f.start_time,end_time:f==null?void 0:f.end_time}:m;if(!J&&p!=="completed")return e.jsx(Xe,{quiz:X,title:z,isActive:B,timeLeft:L,displayJoined:V,prizes:U,prizeType:S,formatTime:R,onJoin:ce,onClose:se});if(p==="waiting")return e.jsx(Ye,{quiz:X,title:z,timeLeft:L,totalJoined:re,prizes:U,prizeType:S,formatTime:R,onClose:se});const Y=Object.keys(g).length>0;return p==="completed"||p==="finished"&&Y?e.jsx(Ze,{title:z,onNavigateHome:H}):p==="finished"&&!Y?e.jsx(Ie,{title:z,onNavigateHome:H}):!Q||Q.length===0?e.jsx(Ke,{}):e.jsxs(e.Fragment,{children:[e.jsx(W,{title:`${z} â€“ Quiz Dangal`,description:"Play this quiz on Quiz Dangal and win rewards!",robots:"noindex, nofollow"}),e.jsx(et,{title:z,quizId:d,questions:Q,currentQuestionIndex:F,answers:g,timeLeft:L,submitting:$,quizState:p,participantStatus:O,formatTime:R,onAnswerSelect:de,onNext:A,onSubmit:K})]})};export{lt as default};
